<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTi Complete Design Studio - Enhanced WYSIWYG Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .design-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: 100vh;
            overflow: hidden;
        }
        
        .live-iframe {
            border: none;
            width: 100%;
            height: 100%;
            background: white;
            transition: all 0.3s ease;
        }
        
        .property-panel {
            background: #1a1a1a;
            color: white;
            overflow-y: auto;
        }
        
        .component-tree {
            background: #2a2a2a;
            color: white;
            overflow-y: auto;
        }
        
        .live-indicator {
            animation: livebeat 1.5s infinite;
        }
        
        @keyframes livebeat {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .page-tab {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        
        .page-tab:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        
        .page-tab.active {
            background: rgba(59, 130, 246, 0.2);
            border-bottom-color: #3b82f6;
        }

        /* üöÄ PUBLISH BUTTON STYLES */
        .publish-button {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
            animation: publishGlow 3s infinite alternate;
            position: relative;
            overflow: hidden;
        }

        .publish-button:before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #059669, #10b981, #34d399, #6ee7b7);
            border-radius: inherit;
            z-index: -1;
            filter: blur(8px);
            opacity: 0.7;
        }

        .publish-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(5, 150, 105, 0.6);
        }

        .publish-button.publishing {
            animation: publishSpin 1s linear infinite;
        }

        @keyframes publishGlow {
            0% { box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4); }
            100% { box-shadow: 0 8px 25px rgba(52, 211, 153, 0.8); }
        }

        @keyframes publishSpin {
            0% { transform: rotate(0deg) scale(1.05); }
            100% { transform: rotate(360deg) scale(1.05); }
        }

        /* üí¨ MESSAGING SYSTEM STYLES */
        .message-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 70vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            overflow: hidden;
            border: 2px solid #3b82f6;
        }

        .message-header {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 16px;
        }

        .message-item {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            position: relative;
        }

        .message-item.sent {
            background: #3b82f6;
            color: white;
            margin-left: 20px;
        }

        .message-item.received {
            background: #f3f4f6;
            color: #1f2937;
            margin-right: 20px;
        }

        .message-input-area {
            border-top: 1px solid #e5e7eb;
            padding: 16px;
        }

        .user-list {
            max-height: 200px;
            overflow-y: auto;
            border-bottom: 1px solid #e5e7eb;
        }

        .user-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-item:hover {
            background: #f9fafb;
        }

        .user-item.active {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: auto;
        }

        .user-status.online {
            background: #10b981;
            animation: statusPulse 2s infinite;
        }

        .user-status.offline {
            background: #6b7280;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* üé® COMPLETE WYSIWYG EDITOR STYLES */
        .full-edit-mode {
            position: relative !important;
        }

        .full-edit-mode * {
            position: relative !important;
        }

        .full-edit-mode .editable-element {
            outline: 1px dashed rgba(34, 197, 94, 0.5) !important;
            cursor: pointer !important;
            transition: all 0.15s ease !important;
            min-height: 16px !important;
            min-width: 16px !important;
        }

        .full-edit-mode .editable-element:hover {
            outline: 2px solid #22c55e !important;
            background: rgba(34, 197, 94, 0.1) !important;
            transform: scale(1.02) !important;
            z-index: 999 !important;
        }

        .full-edit-mode .editable-text {
            outline-color: #3b82f6 !important;
        }

        .full-edit-mode .editable-text:hover {
            outline-color: #1d4ed8 !important;
            background: rgba(59, 130, 246, 0.1) !important;
        }

        .full-edit-mode .editable-image {
            outline-color: #f59e0b !important;
        }

        .full-edit-mode .editable-image:hover {
            outline-color: #d97706 !important;
            background: rgba(245, 158, 11, 0.1) !important;
        }

        .full-edit-mode .clickable-area {
            outline: 1px dashed rgba(168, 85, 247, 0.4) !important;
            cursor: crosshair !important;
            min-height: 20px !important;
        }

        .full-edit-mode .clickable-area:hover {
            outline: 2px solid #a855f7 !important;
            background: rgba(168, 85, 247, 0.1) !important;
        }

        /* Element tooltips */
        .full-edit-mode .editable-element:before {
            content: attr(data-edit-type);
            position: absolute;
            top: -25px;
            left: 0;
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }

        .full-edit-mode .editable-text:before {
            content: "‚úèÔ∏è Edit Text";
            background: #3b82f6;
        }

        .full-edit-mode .editable-image:before {
            content: "üñºÔ∏è Edit Image";
            background: #f59e0b;
        }

        .full-edit-mode .clickable-area:before {
            content: "‚ûï Add Element";
            background: #a855f7;
        }

        .full-edit-mode .editable-element:hover:before {
            opacity: 1;
        }

        /* Enhanced publish notification */
        .publish-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(5, 150, 105, 0.4);
            z-index: 20000;
            text-align: center;
            min-width: 300px;
            animation: publishNotificationSlide 0.5s ease-out;
        }

        @keyframes publishNotificationSlide {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Profile avatar enhancement */
        .profile-avatar {
            position: relative;
            cursor: pointer;
        }

        .profile-avatar:hover:after {
            content: 'üì∑ Change Photo';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Rest of existing styles... */
        .upload-zone {
            border: 2px dashed #6b7280;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(107, 114, 128, 0.05);
        }

        .upload-zone:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-zone.dragover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            transform: scale(1.02);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .floating-panel {
            position: fixed;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .floating-panel-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .element-toolbar {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 200px;
        }

        .element-button {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 500;
        }

        .element-button:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .element-button.active {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .tab-container {
            display: flex;
            background: #374151;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .tab-button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #9ca3af;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .tab-button.active {
            background: #3b82f6;
            color: white;
        }

        .tab-button:hover {
            background: rgba(59, 130, 246, 0.1);
            color: white;
        }

        .profile-header {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            padding: 16px;
            margin: -16px -16px 16px -16px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-header:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo, memo } = React;

        // Configuration
        const API_BASE_URL = 'https://rti-trading-backend-production.up.railway.app/api';
        const SOCKET_URL = 'https://rti-trading-backend-production.up.railway.app';
        const MAIN_SITE_URL = window.location.origin;

        const debugLog = (message, data = null) => {
            console.log(`üé® [COMPLETE STUDIO] ${message}`);
            if (data) console.log('üìä Data:', data);
        };

        // Enhanced file upload with multiple fallbacks
        const uploadFile = async (file, type = 'image') => {
            debugLog('üìÅ Starting enhanced upload...', { fileName: file.name, size: file.size });
            
            const uploadMethods = [
                // Method 1: Main API
                async () => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('type', type);
                    
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (response.ok) return await response.json();
                    throw new Error('API upload failed');
                },
                
                // Method 2: Alternative service
                async () => {
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch('https://api.imgur.com/3/image', {
                        method: 'POST',
                        headers: { 'Authorization': 'Client-ID 546c25a59c58ad7' },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        return { url: result.data.link };
                    }
                    throw new Error('Imgur upload failed');
                },
                
                // Method 3: Data URL fallback
                async () => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            resolve({
                                url: e.target.result,
                                fallback: true,
                                originalName: file.name,
                                size: file.size
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                }
            ];

            for (let i = 0; i < uploadMethods.length; i++) {
                try {
                    const result = await uploadMethods[i]();
                    debugLog(`‚úÖ Upload successful via method ${i + 1}`, result);
                    return result;
                } catch (error) {
                    debugLog(`‚ö†Ô∏è Upload method ${i + 1} failed:`, error.message);
                    if (i === uploadMethods.length - 1) throw error;
                }
            }
        };

        // Utility functions
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const generateId = () => `element-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        // Enhanced Image Uploader Component
        const ImageUploader = memo(({ onUpload, currentImage = null, title = "Upload Image", className = "" }) => {
            const [dragOver, setDragOver] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [progress, setProgress] = useState(0);
            const [error, setError] = useState('');
            const fileInputRef = useRef(null);

            const handleFileUpload = async (file) => {
                if (!file || !file.type.startsWith('image/')) {
                    setError('Please select a valid image file');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    setError('File too large. Maximum size is 10MB.');
                    return;
                }

                setUploading(true);
                setProgress(0);
                setError('');

                try {
                    const progressInterval = setInterval(() => {
                        setProgress(prev => Math.min(prev + 10, 90));
                    }, 200);

                    const result = await uploadFile(file, 'image');
                    
                    clearInterval(progressInterval);
                    setProgress(100);
                    
                    setTimeout(() => {
                        onUpload(result.url);
                        setProgress(0);
                        debugLog('‚úÖ Image uploaded successfully', result);
                    }, 500);

                } catch (error) {
                    debugLog('‚ùå All upload methods failed', error);
                    setError('Upload failed. Please try again.');
                } finally {
                    setUploading(false);
                    setTimeout(() => setProgress(0), 1000);
                }
            };

            return (
                <div className={className}>
                    <label className="block text-sm font-medium text-white mb-2">{title}</label>
                    
                    {error && (
                        <div className="bg-red-500/20 border border-red-500 text-red-300 px-3 py-2 rounded mb-3 text-sm">
                            {error}
                        </div>
                    )}
                    
                    {currentImage && (
                        <div className="mb-3 relative">
                            <img src={currentImage} alt="Current" className="w-full h-32 object-cover rounded border-2 border-gray-300" />
                            <button
                                onClick={() => onUpload(null)}
                                className="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs hover:bg-red-600"
                            >
                                ‚úï
                            </button>
                        </div>
                    )}

                    <div
                        className={`upload-zone ${dragOver ? 'dragover' : ''} ${uploading ? 'pointer-events-none opacity-50' : ''}`}
                        onDrop={(e) => {
                            e.preventDefault();
                            setDragOver(false);
                            const file = e.dataTransfer.files[0];
                            if (file) handleFileUpload(file);
                        }}
                        onDragOver={(e) => {
                            e.preventDefault();
                            setDragOver(true);
                        }}
                        onDragLeave={() => setDragOver(false)}
                        onClick={() => !uploading && fileInputRef.current?.click()}
                    >
                        {uploading ? (
                            <div>
                                <div className="spinner mx-auto mb-3"></div>
                                <p className="text-sm text-blue-600 font-medium">Uploading... {progress}%</p>
                                <div className="w-full bg-blue-200 rounded-full h-2 mt-2">
                                    <div 
                                        className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="text-3xl mb-2">{dragOver ? 'üéØ' : 'üìÅ'}</div>
                                <p className="text-sm font-medium mb-1">
                                    {dragOver ? 'Drop image here!' : 'Click or drag to upload'}
                                </p>
                                <p className="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                        )}
                    </div>

                    <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        onChange={(e) => {
                            const file = e.target.files?.[0];
                            if (file) handleFileUpload(file);
                        }}
                        className="hidden"
                        disabled={uploading}
                    />
                </div>
            );
        });

        // üöÄ Publish Button Component
        const PublishButton = memo(({ onPublish, hasChanges, isPublishing }) => {
            return (
                <button
                    onClick={onPublish}
                    disabled={!hasChanges || isPublishing}
                    className={`publish-button text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 flex items-center gap-3 ${
                        !hasChanges ? 'opacity-50 cursor-not-allowed' : ''
                    } ${isPublishing ? 'publishing' : ''}`}
                >
                    {isPublishing ? (
                        <>
                            <div className="spinner w-5 h-5"></div>
                            <span>Publishing...</span>
                        </>
                    ) : (
                        <>
                            <span className="text-xl">üöÄ</span>
                            <div>
                                <div className="text-lg">Publish Live</div>
                                <div className="text-xs opacity-90">
                                    {hasChanges ? 'Ready to publish' : 'No changes'}
                                </div>
                            </div>
                        </>
                    )}
                </button>
            );
        });

        // üí¨ Messaging System Component
        const MessagingSystem = memo(({ user, onClose, socket }) => {
            const [activeChat, setActiveChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [connectedUsers, setConnectedUsers] = useState([]);
            const [unreadCounts, setUnreadCounts] = useState({});

            // Mock users for demo - in real app, fetch from API
            const availableUsers = [
                { id: 'user1', username: 'Designer1', avatar: 'https://ui-avatars.com/api/?name=Designer1&background=3b82f6&color=fff', online: true },
                { id: 'user2', username: 'Developer1', avatar: 'https://ui-avatars.com/api/?name=Developer1&background=10b981&color=fff', online: true },
                { id: 'user3', username: 'Manager1', avatar: 'https://ui-avatars.com/api/?name=Manager1&background=f59e0b&color=fff', online: false },
                { id: 'user4', username: 'Client1', avatar: 'https://ui-avatars.com/api/?name=Client1&background=8b5cf6&color=fff', online: true }
            ];

            const sendMessage = () => {
                if (!newMessage.trim() || !activeChat) return;

                const message = {
                    id: Date.now(),
                    sender: user.username,
                    recipient: activeChat.username,
                    content: newMessage,
                    timestamp: new Date(),
                    type: 'sent'
                };

                setMessages(prev => [...prev, message]);
                setNewMessage('');

                // Emit via socket in real implementation
                if (socket) {
                    socket.emit('sendMessage', {
                        to: activeChat.id,
                        message: newMessage,
                        from: user.username
                    });
                }

                debugLog('üí¨ Message sent', message);
            };

            return (
                <div className="message-panel">
                    <div className="message-header">
                        <div className="flex items-center gap-2">
                            <span>üí¨</span>
                            <span>Messages</span>
                            {Object.keys(unreadCounts).length > 0 && (
                                <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                                    {Object.values(unreadCounts).reduce((a, b) => a + b, 0)}
                                </span>
                            )}
                        </div>
                        <button onClick={onClose} className="text-white/80 hover:text-white">‚úï</button>
                    </div>

                    {!activeChat ? (
                        <div className="user-list">
                            <div className="p-3 border-b border-gray-200">
                                <h4 className="font-medium text-gray-800">Team Members</h4>
                            </div>
                            {availableUsers.map(user => (
                                <div
                                    key={user.id}
                                    className="user-item"
                                    onClick={() => setActiveChat(user)}
                                >
                                    <img src={user.avatar} alt="" className="w-8 h-8 rounded-full" />
                                    <div className="flex-1">
                                        <div className="font-medium text-gray-800">{user.username}</div>
                                        <div className="text-xs text-gray-500">
                                            {user.online ? 'Online' : 'Offline'}
                                        </div>
                                    </div>
                                    {unreadCounts[user.id] && (
                                        <span className="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">
                                            {unreadCounts[user.id]}
                                        </span>
                                    )}
                                    <div className={`user-status ${user.online ? 'online' : 'offline'}`}></div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <>
                            <div className="p-3 border-b border-gray-200 flex items-center gap-3">
                                <button 
                                    onClick={() => setActiveChat(null)}
                                    className="text-gray-500 hover:text-gray-700"
                                >
                                    ‚Üê
                                </button>
                                <img src={activeChat.avatar} alt="" className="w-8 h-8 rounded-full" />
                                <div>
                                    <div className="font-medium text-gray-800">{activeChat.username}</div>
                                    <div className="text-xs text-gray-500">
                                        {activeChat.online ? 'üü¢ Online' : '‚ö´ Offline'}
                                    </div>
                                </div>
                            </div>

                            <div className="message-list">
                                {messages.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">
                                        <div className="text-3xl mb-2">üí¨</div>
                                        <p>Start a conversation with {activeChat.username}</p>
                                    </div>
                                ) : (
                                    messages.map(message => (
                                        <div key={message.id} className={`message-item ${message.type}`}>
                                            <div className="text-sm">{message.content}</div>
                                            <div className="text-xs opacity-70 mt-1">
                                                {message.timestamp.toLocaleTimeString()}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>

                            <div className="message-input-area">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newMessage}
                                        onChange={(e) => setNewMessage(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                        placeholder={`Message ${activeChat.username}...`}
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={!newMessage.trim()}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        üì§
                                    </button>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        });

        // Enhanced Profile Editor Modal
        const ProfileEditor = memo(({ user, onUpdate, onClose }) => {
            const [profileData, setProfileData] = useState({
                username: user?.username || '',
                email: user?.email || '',
                displayName: user?.displayName || '',
                bio: user?.bio || '',
                avatar: user?.avatar || '',
                role: user?.role || 'Complete Studio Admin',
                company: user?.company || 'RTi',
                location: user?.location || '',
                phone: user?.phone || '',
                website: user?.website || ''
            });
            const [saving, setSaving] = useState(false);
            const [activeTab, setActiveTab] = useState('profile');

            const handleSave = async () => {
                setSaving(true);
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const updatedUser = { ...user, ...profileData };
                    onUpdate(updatedUser);
                    debugLog('‚úÖ Profile updated successfully');
                } catch (error) {
                    debugLog('‚ùå Profile update failed', error);
                    alert('Failed to update profile. Please try again.');
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">üë§ Edit Profile</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center"
                            >
                                ‚úï
                            </button>
                        </div>

                        {/* Profile Tabs */}
                        <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                            <button
                                onClick={() => setActiveTab('profile')}
                                className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'profile' 
                                        ? 'bg-white text-blue-600 shadow-sm' 
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                üë§ Profile
                            </button>
                            <button
                                onClick={() => setActiveTab('settings')}
                                className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${
                                    activeTab === 'settings' 
                                        ? 'bg-white text-blue-600 shadow-sm' 
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                ‚öôÔ∏è Settings
                            </button>
                        </div>

                        {activeTab === 'profile' && (
                            <div className="space-y-6">
                                {/* Avatar Section */}
                                <div className="text-center">
                                    <div className="mb-4">
                                        <div className="profile-avatar inline-block">
                                            <img
                                                src={profileData.avatar || `https://ui-avatars.com/api/?name=${profileData.username}&background=3b82f6&color=fff&size=128`}
                                                alt="Profile Avatar"
                                                className="w-24 h-24 rounded-full mx-auto border-4 border-blue-500 object-cover"
                                            />
                                        </div>
                                    </div>
                                    <ImageUploader
                                        currentImage={profileData.avatar}
                                        onUpload={(url) => setProfileData(prev => ({...prev, avatar: url}))}
                                        title="Profile Picture"
                                        className="max-w-xs mx-auto"
                                    />
                                </div>

                                {/* Profile Fields */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                        <input
                                            type="text"
                                            value={profileData.username}
                                            onChange={(e) => setProfileData(prev => ({...prev, username: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter username"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input
                                            type="email"
                                            value={profileData.email}
                                            onChange={(e) => setProfileData(prev => ({...prev, email: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter email"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                                        <input
                                            type="text"
                                            value={profileData.displayName}
                                            onChange={(e) => setProfileData(prev => ({...prev, displayName: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter display name"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                        <input
                                            type="text"
                                            value={profileData.role}
                                            onChange={(e) => setProfileData(prev => ({...prev, role: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="e.g., Complete Studio Admin"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                        <input
                                            type="text"
                                            value={profileData.company}
                                            onChange={(e) => setProfileData(prev => ({...prev, company: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter company"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                        <input
                                            type="text"
                                            value={profileData.location}
                                            onChange={(e) => setProfileData(prev => ({...prev, location: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter location"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input
                                            type="tel"
                                            value={profileData.phone}
                                            onChange={(e) => setProfileData(prev => ({...prev, phone: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter phone number"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                        <input
                                            type="url"
                                            value={profileData.website}
                                            onChange={(e) => setProfileData(prev => ({...prev, website: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="https://example.com"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                                    <textarea
                                        value={profileData.bio}
                                        onChange={(e) => setProfileData(prev => ({...prev, bio: e.target.value}))}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="4"
                                        placeholder="Tell us about yourself..."
                                    />
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-6">
                                <div className="text-center py-8 text-gray-500">
                                    <div className="text-4xl mb-3">‚öôÔ∏è</div>
                                    <p>Settings panel coming soon!</p>
                                    <div className="text-sm mt-2">
                                        <p>‚Ä¢ Notification preferences</p>
                                        <p>‚Ä¢ Privacy settings</p>
                                        <p>‚Ä¢ Theme customization</p>
                                        <p>‚Ä¢ Account security</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Action Buttons */}
                        <div className="flex gap-3 pt-6 border-t">
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium disabled:opacity-50 transition-all"
                            >
                                {saving ? 'üíæ Saving...' : 'üíæ Save Changes'}
                            </button>
                            <button
                                onClick={onClose}
                                className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // Element Creation Toolbar
        const ElementToolbar = memo(({ isVisible, onElementCreate, creationMode, setCreationMode }) => {
            if (!isVisible) return null;

            const elements = [
                { type: 'text', icon: 'üìù', label: 'Text', description: 'Add text element' },
                { type: 'heading', icon: 'üì∞', label: 'Heading', description: 'Add heading' },
                { type: 'button', icon: 'üîò', label: 'Button', description: 'Add button' },
                { type: 'image', icon: 'üñºÔ∏è', label: 'Image', description: 'Add image' },
                { type: 'container', icon: 'üì¶', label: 'Container', description: 'Add container' },
                { type: 'card', icon: 'üÉè', label: 'Card', description: 'Add card' },
                { type: 'list', icon: 'üìã', label: 'List', description: 'Add list' },
                { type: '3d', icon: 'üéÆ', label: '3D Element', description: 'Add 3D element' },
                { type: 'video', icon: 'üé•', label: 'Video', description: 'Add video' },
                { type: 'form', icon: 'üìù', label: 'Form', description: 'Add form' }
            ];

            return (
                <div className="element-toolbar">
                    <div className="text-center mb-3">
                        <h3 className="font-bold text-gray-800">Add Elements</h3>
                        <p className="text-xs text-gray-600">Click to select, then click anywhere to add</p>
                    </div>
                    
                    {elements.map(element => (
                        <div
                            key={element.type}
                            className={`element-button ${creationMode === element.type ? 'active' : ''}`}
                            onClick={() => setCreationMode(element.type)}
                            title={element.description}
                        >
                            <div className="text-lg mb-1">{element.icon}</div>
                            <div className="text-sm">{element.label}</div>
                        </div>
                    ))}
                    
                    <button
                        onClick={() => setCreationMode(null)}
                        className="w-full mt-3 p-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium"
                    >
                        Cancel
                    </button>
                </div>
            );
        });

        // Floating Property Editor
        const FloatingPropertyEditor = memo(({ element, position, onClose, onSave }) => {
            const [properties, setProperties] = useState({
                text: element?.textContent || '',
                fontSize: element?.style?.fontSize || '16px',
                color: element?.style?.color || '#000000',
                backgroundColor: element?.style?.backgroundColor || 'transparent',
                padding: element?.style?.padding || '0px',
                margin: element?.style?.margin || '0px',
                borderRadius: element?.style?.borderRadius || '0px',
                width: element?.style?.width || 'auto',
                height: element?.style?.height || 'auto'
            });

            const handleSave = () => {
                onSave(properties);
                onClose();
            };

            return (
                <div 
                    className="floating-panel" 
                    style={{ 
                        left: Math.min(position.x, window.innerWidth - 350), 
                        top: Math.min(position.y, window.innerHeight - 400) 
                    }}
                >
                    <button className="floating-panel-close" onClick={onClose}>‚úï</button>
                    
                    <div className="floating-panel-header">
                        <h3 className="font-bold text-lg text-gray-800">Edit Element</h3>
                    </div>

                    <div className="space-y-4">
                        {/* Text Content */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Text Content</label>
                            <textarea
                                value={properties.text}
                                onChange={(e) => setProperties(prev => ({...prev, text: e.target.value}))}
                                className="w-full px-3 py-2 border border-gray-300 rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="3"
                                placeholder="Enter text..."
                            />
                        </div>

                        {/* Style Properties */}
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Font Size</label>
                                <select
                                    value={properties.fontSize}
                                    onChange={(e) => setProperties(prev => ({...prev, fontSize: e.target.value}))}
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="12px">12px</option>
                                    <option value="14px">14px</option>
                                    <option value="16px">16px</option>
                                    <option value="18px">18px</option>
                                    <option value="20px">20px</option>
                                    <option value="24px">24px</option>
                                    <option value="32px">32px</option>
                                    <option value="48px">48px</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Text Color</label>
                                <input
                                    type="color"
                                    value={properties.color}
                                    onChange={(e) => setProperties(prev => ({...prev, color: e.target.value}))}
                                    className="w-full h-8 border border-gray-300 rounded cursor-pointer"
                                />
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="flex gap-3 pt-4 border-t">
                            <button
                                onClick={handleSave}
                                className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded font-medium transition-all"
                            >
                                ‚úÖ Apply Changes
                            </button>
                            <button
                                onClick={onClose}
                                className="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // Publish Notification Component
        const PublishNotification = memo(({ show, onClose }) => {
            useEffect(() => {
                if (show) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [show, onClose]);

            if (!show) return null;

            return (
                <div className="publish-notification">
                    <div className="text-2xl mb-2">üöÄ</div>
                    <h3 className="text-xl font-bold mb-1">Published Successfully!</h3>
                    <p className="text-sm opacity-90">Your changes are now live</p>
                </div>
            );
        });

        // Main Application Component
        const RTiCompleteDesignStudio = () => {
            // Authentication State
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Design Studio State
            const [currentPage, setCurrentPage] = useState('landing');
            const [isConnected, setIsConnected] = useState(false);
            const [previewMode, setPreviewMode] = useState('desktop');
            const [liveChanges, setLiveChanges] = useState(0);
            const [showLiveIndicator, setShowLiveIndicator] = useState(false);
            const [isInitializing, setIsInitializing] = useState(true);

            // Edit Mode State
            const [fullEditMode, setFullEditMode] = useState(true); // Auto-enabled
            const [editableElements, setEditableElements] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [propertyEditor, setPropertyEditor] = useState(null);

            // Element Creation State
            const [showElementToolbar, setShowElementToolbar] = useState(false);
            const [creationMode, setCreationMode] = useState(null);
            const [showCreationOverlay, setShowCreationOverlay] = useState(false);

            // UI State
            const [activeTab, setActiveTab] = useState('elements');
            const [showProfileEditor, setShowProfileEditor] = useState(false);
            const [showCode, setShowCode] = useState(false);

            // Messaging State
            const [showMessaging, setShowMessaging] = useState(false);

            // Publish State
            const [isPublishing, setIsPublishing] = useState(false);
            const [showPublishNotification, setShowPublishNotification] = useState(false);
            const [hasUnpublishedChanges, setHasUnpublishedChanges] = useState(false);

            // Auto-save State
            const [autoSaving, setAutoSaving] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);

            // Auto-save functionality
            const autoSaveChanges = useCallback(debounce(async () => {
                if (!hasUnpublishedChanges) return;
                
                setAutoSaving(true);
                try {
                    const changes = collectAllChanges();
                    await saveChangesToPersistence(changes);
                    setLastSaved(new Date());
                    debugLog('üíæ Auto-saved changes');
                } catch (error) {
                    debugLog('‚ùå Auto-save failed', error);
                } finally {
                    setAutoSaving(false);
                }
            }, 3000), [hasUnpublishedChanges]);

            // Trigger auto-save when changes are made
            useEffect(() => {
                if (hasUnpublishedChanges) {
                    autoSaveChanges();
                }
            }, [hasUnpublishedChanges, autoSaveChanges]);

            // Test Mode State
            const [testMode, setTestMode] = useState(false);
            const [testUser, setTestUser] = useState(null);
            const [testStatus, setTestStatus] = useState('');

            // Media State
            const [mediaFiles, setMediaFiles] = useState([]);

            // Refs
            const iframeRef = useRef(null);
            const socketRef = useRef(null);
            const connectionAttempted = useRef(false);
            const editHandlersAttached = useRef(false);
            const lastUpdateTime = useRef(0);

            // Available Pages
            const pages = [
                { id: 'landing', name: 'üè† Landing Page', url: '/', icon: 'üè†' },
                { id: 'dashboard', name: 'üìä Dashboard', url: '/dashboard', icon: 'üìä' },
                { id: 'subscription', name: 'üíé Subscription', url: '/subscription', icon: 'üíé' },
                { id: 'live', name: 'üî¥ Live Site', url: MAIN_SITE_URL, icon: 'üåê' }
            ];

            // Test Users
            const testUsers = [
                { id: 'test-free', username: 'FreeUser', tier: 'FREE', description: 'Free tier user' },
                { id: 'test-weekly', username: 'WeeklyUser', tier: 'WEEKLY', description: 'Weekly subscriber' },
                { id: 'test-monthly', username: 'MonthlyUser', tier: 'MONTHLY', description: 'Monthly subscriber' },
                { id: 'test-admin', username: 'AdminUser', tier: 'ADMIN', isAdmin: true, description: 'Admin user' }
            ];

            // üöÄ Enhanced Publish Function with Real Persistence
            const handlePublish = useCallback(async () => {
                if (!hasUnpublishedChanges || isPublishing) return;

                setIsPublishing(true);
                debugLog('üöÄ Publishing changes to live site...');

                try {
                    // 1. Collect all current element states
                    const currentChanges = collectAllChanges();
                    debugLog('üìä Collected changes for publishing', currentChanges);

                    // 2. Save changes to backend/storage
                    await saveChangesToPersistence(currentChanges);

                    // 3. Inject changes into iframe for immediate feedback
                    await injectChangesIntoIframe(currentChanges);

                    setHasUnpublishedChanges(false);
                    setShowPublishNotification(true);
                    
                    // Broadcast publish event
                    if (socketRef.current) {
                        socketRef.current.emit('sitePublished', {
                            user: user?.username,
                            timestamp: Date.now(),
                            changesCount: liveChanges,
                            changes: currentChanges
                        });
                    }

                    debugLog('‚úÖ Site published successfully');

                } catch (error) {
                    debugLog('‚ùå Publish failed', error);
                    alert('Failed to publish changes. Please try again.');
                } finally {
                    setIsPublishing(false);
                }
            }, [hasUnpublishedChanges, isPublishing, liveChanges, user]);

            // Enhanced Element Scanner
            const scanAllElements = useCallback(() => {
                if (!iframeRef.current || !fullEditMode) return;

                try {
                    const iframe = iframeRef.current;
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                    
                    if (!iframeDoc || iframeDoc.readyState !== 'complete') return;

                    debugLog('üîç Scanning ALL elements for complete editing...');

                    // Clear existing
                    const existingEditables = iframeDoc.querySelectorAll('.editable-element, .clickable-area');
                    existingEditables.forEach(el => {
                        el.classList.remove('editable-element', 'editable-text', 'editable-image', 'clickable-area');
                        el.removeEventListener('click', handleElementClick);
                    });

                    // Add full edit mode class
                    iframeDoc.body.classList.add('full-edit-mode');

                    const elements = [];
                    let elementCounter = 0;

                    // Get ALL elements
                    const allElements = iframeDoc.querySelectorAll('*');
                    
                    allElements.forEach((element) => {
                        // Skip script, style, meta elements
                        if (['SCRIPT', 'STYLE', 'META', 'LINK', 'HEAD', 'TITLE', 'HTML', 'BODY'].includes(element.tagName)) {
                            return;
                        }

                        const rect = element.getBoundingClientRect();
                        if (rect.width < 5 || rect.height < 5) return;

                        const computedStyle = iframeDoc.defaultView.getComputedStyle(element);
                        if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                            return;
                        }

                        elementCounter++;
                        const editId = `edit-${elementCounter}`;
                        element.setAttribute('data-edit-id', editId);
                        element.classList.add('editable-element');

                        // Classify element type
                        let elementType = 'element';
                        
                        if (element.tagName === 'IMG' || element.style.backgroundImage) {
                            element.classList.add('editable-image');
                            element.setAttribute('data-edit-type', 'üñºÔ∏è Image');
                            elementType = 'image';
                        } else if (element.textContent && element.textContent.trim().length > 0) {
                            element.classList.add('editable-text');
                            element.setAttribute('data-edit-type', '‚úèÔ∏è Text');
                            elementType = 'text';
                        } else {
                            element.setAttribute('data-edit-type', '‚öôÔ∏è Element');
                        }

                        // Add click handler
                        element.addEventListener('click', handleElementClick);

                        elements.push({
                            id: editId,
                            element,
                            type: elementType,
                            tagName: element.tagName,
                            text: element.textContent?.substring(0, 50) || '',
                            className: element.className
                        });
                    });

                    // Add clickable areas for empty spaces
                    const emptyAreas = iframeDoc.querySelectorAll('body > *, div, section, article, main');
                    emptyAreas.forEach((area) => {
                        if (!area.classList.contains('editable-element')) {
                            area.classList.add('clickable-area');
                            area.addEventListener('click', handleAreaClick);
                        }
                    });

                    setEditableElements(elements);
                    editHandlersAttached.current = true;
                    
                    debugLog(`‚úÖ Full edit mode enabled: ${elements.length} elements editable`);
                    
                } catch (error) {
                    debugLog('‚ùå Failed to enable full edit mode', error);
                }
            }, [fullEditMode]);

            // Element Click Handler
            const handleElementClick = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const element = e.target;
                const rect = element.getBoundingClientRect();
                const iframeRect = iframeRef.current.getBoundingClientRect();
                
                setSelectedElement(element);
                setPropertyEditor({
                    element,
                    position: {
                        x: iframeRect.left + rect.right + 10,
                        y: iframeRect.top + rect.top
                    }
                });

                debugLog('üéØ Element selected for editing', { 
                    tagName: element.tagName, 
                    editId: element.getAttribute('data-edit-id')
                });
            }, []);

            // Area Click Handler (for adding elements)
            const handleAreaClick = useCallback((e) => {
                if (!creationMode) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const clickX = e.clientX;
                const clickY = e.clientY;
                
                createElement(creationMode, { x: clickX, y: clickY });
                setCreationMode(null);
                setShowCreationOverlay(false);
            }, [creationMode]);

            // Create Element Function
            const createElement = useCallback((type, position) => {
                if (!iframeRef.current) return;

                try {
                    const iframe = iframeRef.current;
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                    
                    if (!iframeDoc) return;

                    const newElement = iframeDoc.createElement('div');
                    const elementId = generateId();
                    
                    newElement.id = elementId;
                    newElement.setAttribute('data-edit-id', elementId);
                    newElement.style.position = 'absolute';
                    newElement.style.left = position.x + 'px';
                    newElement.style.top = position.y + 'px';
                    newElement.style.zIndex = '1000';

                    // Configure based on type
                    switch (type) {
                        case 'text':
                            newElement.textContent = 'New Text Element';
                            newElement.style.padding = '8px';
                            newElement.style.border = '1px solid #ccc';
                            break;
                        case 'heading':
                            newElement.innerHTML = '<h2>New Heading</h2>';
                            newElement.style.fontSize = '24px';
                            newElement.style.fontWeight = 'bold';
                            break;
                        case 'button':
                            newElement.innerHTML = '<button style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">New Button</button>';
                            break;
                        case 'image':
                            newElement.innerHTML = '<img src="https://via.placeholder.com/200x150" alt="New Image" style="max-width: 100%; height: auto;" />';
                            break;
                        case 'container':
                            newElement.style.width = '300px';
                            newElement.style.height = '200px';
                            newElement.style.border = '2px solid #3b82f6';
                            newElement.style.padding = '16px';
                            newElement.textContent = 'New Container';
                            break;
                        case 'card':
                            newElement.innerHTML = `
                                <div style="background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; width: 250px;">
                                    <h3 style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold;">Card Title</h3>
                                    <p style="margin: 0; color: #666;">Card content goes here.</p>
                                </div>
                            `;
                            break;
                        case '3d':
                            newElement.innerHTML = '<div style="width: 100px; height: 100px; background: linear-gradient(45deg, #3b82f6, #8b5cf6); transform: rotateX(15deg) rotateY(15deg); transform-style: preserve-3d;">3D Element</div>';
                            newElement.className = 'element-3d';
                            break;
                        default:
                            newElement.textContent = `New ${type} Element`;
                            newElement.style.padding = '12px';
                            newElement.style.border = '1px solid #ddd';
                            newElement.style.background = '#f9f9f9';
                    }

                    // Add to document
                    iframeDoc.body.appendChild(newElement);
                    
                    // Make it editable
                    newElement.classList.add('editable-element');
                    newElement.addEventListener('click', handleElementClick);
                    
                    // Update elements list
                    setEditableElements(prev => [...prev, {
                        id: elementId,
                        element: newElement,
                        type: type,
                        tagName: 'DIV',
                        text: newElement.textContent?.substring(0, 50) || '',
                        className: newElement.className
                    }]);

                    // Mark as having unpublished changes
                    setHasUnpublishedChanges(true);

                    debugLog(`‚úÖ Created new ${type} element`, { id: elementId, position });
                    
                } catch (error) {
                    debugLog('‚ùå Failed to create element', error);
                }
            }, [handleElementClick]);

            // Property Save Handler
            const handlePropertySave = useCallback((properties) => {
                if (!selectedElement) return;

                try {
                    // Apply text content
                    if (properties.text !== undefined) {
                        selectedElement.textContent = properties.text;
                    }

                    // Apply styles
                    Object.entries(properties).forEach(([key, value]) => {
                        if (key !== 'text' && value) {
                            selectedElement.style[key] = value;
                        }
                    });

                    // Mark as having unpublished changes
                    setHasUnpublishedChanges(true);

                    debugLog('‚úÖ Properties applied to element', properties);
                    
                    // Broadcast live update
                    pushLiveUpdate('elementUpdate', {
                        elementId: selectedElement.getAttribute('data-edit-id'),
                        properties
                    });

                } catch (error) {
                    debugLog('‚ùå Failed to apply properties', error);
                }
            }, [selectedElement]);

            // Live Update Functions
            const pushLiveUpdate = useCallback((updateType, updateData, source = 'user') => {
                const now = Date.now();
                if (now - lastUpdateTime.current < 200) return;
                lastUpdateTime.current = now;

                if (source === 'user') {
                    setLiveChanges(prev => prev + 1);
                    setShowLiveIndicator(true);
                    setTimeout(() => setShowLiveIndicator(false), 2000);
                }

                if (socketRef.current && isConnected && source === 'user') {
                    const payload = {
                        type: updateType,
                        page: currentPage,
                        data: updateData,
                        timestamp: Date.now(),
                        user: user?.username,
                        source
                    };

                    socketRef.current.emit('liveDesignUpdate', payload);
                    debugLog('üì° Broadcasting update', payload);
                }
            }, [isConnected, currentPage, user]);

            // üíæ Persistence System - Collect All Changes
            const collectAllChanges = useCallback(() => {
                if (!iframeRef.current) return {};

                const iframe = iframeRef.current;
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                
                if (!iframeDoc) return {};

                const changes = {
                    page: currentPage,
                    timestamp: Date.now(),
                    elements: {},
                    newElements: [],
                    deletedElements: [],
                    globalStyles: {}
                };

                // Collect all edited elements
                editableElements.forEach(elementData => {
                    try {
                        const element = elementData.element;
                        if (!element || !element.parentNode) return;

                        const elementChanges = {
                            id: elementData.id,
                            tagName: element.tagName,
                            innerHTML: element.innerHTML,
                            textContent: element.textContent,
                            styles: {
                                position: element.style.position,
                                left: element.style.left,
                                top: element.style.top,
                                width: element.style.width,
                                height: element.style.height,
                                fontSize: element.style.fontSize,
                                color: element.style.color,
                                backgroundColor: element.style.backgroundColor,
                                padding: element.style.padding,
                                margin: element.style.margin,
                                borderRadius: element.style.borderRadius,
                                border: element.style.border,
                                transform: element.style.transform,
                                zIndex: element.style.zIndex
                            },
                            attributes: {},
                            isNew: element.id.startsWith('element-'), // Check if it's a newly created element
                            selector: generateElementSelector(element),
                            xpath: generateXPath(element)
                        };

                        // Collect all attributes
                        for (let i = 0; i < element.attributes.length; i++) {
                            const attr = element.attributes[i];
                            elementChanges.attributes[attr.name] = attr.value;
                        }

                        changes.elements[elementData.id] = elementChanges;

                        if (elementChanges.isNew) {
                            changes.newElements.push(elementChanges);
                        }

                    } catch (error) {
                        debugLog('‚ùå Error collecting element changes', error);
                    }
                });

                debugLog('üìä Collected changes', changes);
                return changes;
            }, [editableElements, currentPage]);

            // üéØ Generate CSS Selector for Element
            const generateElementSelector = (element) => {
                if (element.id) return `#${element.id}`;
                
                const path = [];
                let current = element;
                
                while (current && current.nodeType === Node.ELEMENT_NODE) {
                    let selector = current.nodeName.toLowerCase();
                    
                    if (current.className) {
                        selector += '.' + current.className.split(' ').join('.');
                    }
                    
                    // Add nth-child if needed for uniqueness
                    const siblings = current.parentNode ? 
                        Array.from(current.parentNode.children).filter(e => e.nodeName === current.nodeName) : [];
                    
                    if (siblings.length > 1) {
                        const index = siblings.indexOf(current) + 1;
                        selector += `:nth-child(${index})`;
                    }
                    
                    path.unshift(selector);
                    current = current.parentElement;
                    
                    if (path.length > 5) break; // Limit depth
                }
                
                return path.join(' > ');
            };

            // üéØ Generate XPath for Element
            const generateXPath = (element) => {
                if (element.id) return `//*[@id="${element.id}"]`;
                
                const path = [];
                let current = element;
                
                while (current && current.nodeType === Node.ELEMENT_NODE) {
                    const tagName = current.nodeName.toLowerCase();
                    const siblings = current.parentNode ? 
                        Array.from(current.parentNode.children).filter(e => e.nodeName === current.nodeName) : [];
                    
                    if (siblings.length > 1) {
                        const index = siblings.indexOf(current) + 1;
                        path.unshift(`${tagName}[${index}]`);
                    } else {
                        path.unshift(tagName);
                    }
                    
                    current = current.parentElement;
                    if (path.length > 10) break; // Limit depth
                }
                
                return '//' + path.join('/');
            };

            // üíæ Save Changes to Persistence Layer
            const saveChangesToPersistence = useCallback(async (changes) => {
                const storageKey = `rti_design_changes_${currentPage}`;
                
                try {
                    // Method 1: Save to localStorage (immediate backup)
                    localStorage.setItem(storageKey, JSON.stringify(changes));
                    debugLog('‚úÖ Changes saved to localStorage');

                    // Method 2: Save to backend API
                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch(`${API_BASE_URL}/design/save`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                page: currentPage,
                                changes: changes,
                                timestamp: Date.now()
                            })
                        });

                        if (response.ok) {
                            debugLog('‚úÖ Changes saved to backend');
                        } else {
                            throw new Error('Backend save failed');
                        }
                    } catch (apiError) {
                        debugLog('‚ö†Ô∏è Backend save failed, using localStorage only', apiError);
                    }

                    // Method 3: Save to IndexedDB for larger storage
                    try {
                        await saveToIndexedDB(storageKey, changes);
                        debugLog('‚úÖ Changes saved to IndexedDB');
                    } catch (idbError) {
                        debugLog('‚ö†Ô∏è IndexedDB save failed', idbError);
                    }

                } catch (error) {
                    debugLog('‚ùå Failed to save changes', error);
                    throw new Error('Failed to persist changes');
                }
            }, [currentPage]);

            // üóÑÔ∏è IndexedDB Storage
            const saveToIndexedDB = async (key, data) => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('RTiDesignStudio', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['changes'], 'readwrite');
                        const store = transaction.objectStore('changes');
                        
                        store.put({ id: key, data: data, timestamp: Date.now() });
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    };
                    
                    request.onupgradeneeded = () => {
                        const db = request.result;
                        if (!db.objectStoreNames.contains('changes')) {
                            db.createObjectStore('changes', { keyPath: 'id' });
                        }
                    };
                });
            };

            // üîÑ Load Changes from Persistence
            const loadChangesFromPersistence = useCallback(async (page) => {
                const storageKey = `rti_design_changes_${page}`;
                
                try {
                    // Try localStorage first
                    const localData = localStorage.getItem(storageKey);
                    if (localData) {
                        const changes = JSON.parse(localData);
                        debugLog('üìÇ Loaded changes from localStorage', changes);
                        return changes;
                    }

                    // Try backend API
                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch(`${API_BASE_URL}/design/load/${page}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            const changes = await response.json();
                            debugLog('üìÇ Loaded changes from backend', changes);
                            return changes;
                        }
                    } catch (apiError) {
                        debugLog('‚ö†Ô∏è Backend load failed', apiError);
                    }

                    // Try IndexedDB
                    try {
                        const changes = await loadFromIndexedDB(storageKey);
                        if (changes) {
                            debugLog('üìÇ Loaded changes from IndexedDB', changes);
                            return changes;
                        }
                    } catch (idbError) {
                        debugLog('‚ö†Ô∏è IndexedDB load failed', idbError);
                    }

                } catch (error) {
                    debugLog('‚ùå Failed to load changes', error);
                }

                return null;
            }, []);

            // üóÑÔ∏è Load from IndexedDB
            const loadFromIndexedDB = async (key) => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('RTiDesignStudio', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['changes'], 'readonly');
                        const store = transaction.objectStore('changes');
                        const getRequest = store.get(key);
                        
                        getRequest.onsuccess = () => {
                            resolve(getRequest.result ? getRequest.result.data : null);
                        };
                        getRequest.onerror = () => reject(getRequest.error);
                    };
                    
                    request.onupgradeneeded = () => {
                        const db = request.result;
                        if (!db.objectStoreNames.contains('changes')) {
                            db.createObjectStore('changes', { keyPath: 'id' });
                        }
                    };
                });
            };

            // üíâ Inject Changes into Iframe
            const injectChangesIntoIframe = useCallback(async (changes) => {
                if (!iframeRef.current || !changes || !changes.elements) return;

                const iframe = iframeRef.current;
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                
                if (!iframeDoc) return;

                try {
                    debugLog('üíâ Injecting changes into iframe...', changes);

                    // Create or update style injection
                    let styleElement = iframeDoc.getElementById('rti-dynamic-styles');
                    if (!styleElement) {
                        styleElement = iframeDoc.createElement('style');
                        styleElement.id = 'rti-dynamic-styles';
                        iframeDoc.head.appendChild(styleElement);
                    }

                    let cssRules = '';

                    // Apply changes to existing elements
                    Object.values(changes.elements).forEach(elementChange => {
                        try {
                            // Try to find element by multiple methods
                            let targetElement = iframeDoc.getElementById(elementChange.id);
                            
                            if (!targetElement && elementChange.selector) {
                                targetElement = iframeDoc.querySelector(elementChange.selector);
                            }
                            
                            if (!targetElement && elementChange.xpath) {
                                const xpathResult = iframeDoc.evaluate(
                                    elementChange.xpath, 
                                    iframeDoc, 
                                    null, 
                                    XPathResult.FIRST_ORDERED_NODE_TYPE, 
                                    null
                                );
                                targetElement = xpathResult.singleNodeValue;
                            }

                            if (targetElement) {
                                // Apply content changes
                                if (elementChange.innerHTML !== undefined) {
                                    targetElement.innerHTML = elementChange.innerHTML;
                                }
                                if (elementChange.textContent !== undefined && !elementChange.innerHTML) {
                                    targetElement.textContent = elementChange.textContent;
                                }

                                // Apply style changes
                                Object.entries(elementChange.styles).forEach(([property, value]) => {
                                    if (value && value !== 'auto' && value !== 'inherit') {
                                        targetElement.style[property] = value;
                                    }
                                });

                                // Apply attributes
                                Object.entries(elementChange.attributes).forEach(([attr, value]) => {
                                    if (attr !== 'style' && value) {
                                        targetElement.setAttribute(attr, value);
                                    }
                                });

                                debugLog(`‚úÖ Applied changes to element: ${elementChange.id}`);
                            } else if (elementChange.isNew) {
                                // Create new element
                                const newElement = iframeDoc.createElement(elementChange.tagName.toLowerCase());
                                newElement.id = elementChange.id;
                                
                                if (elementChange.innerHTML) {
                                    newElement.innerHTML = elementChange.innerHTML;
                                } else if (elementChange.textContent) {
                                    newElement.textContent = elementChange.textContent;
                                }

                                // Apply styles
                                Object.entries(elementChange.styles).forEach(([property, value]) => {
                                    if (value && value !== 'auto' && value !== 'inherit') {
                                        newElement.style[property] = value;
                                    }
                                });

                                // Apply attributes
                                Object.entries(elementChange.attributes).forEach(([attr, value]) => {
                                    if (attr !== 'style' && value) {
                                        newElement.setAttribute(attr, value);
                                    }
                                });

                                // Add to document
                                iframeDoc.body.appendChild(newElement);
                                debugLog(`‚úÖ Created new element: ${elementChange.id}`);
                            }

                            // Generate CSS rules for persistent styling
                            if (elementChange.selector) {
                                const styles = Object.entries(elementChange.styles)
                                    .filter(([_, value]) => value && value !== 'auto' && value !== 'inherit')
                                    .map(([property, value]) => `${property.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value}`)
                                    .join('; ');
                                
                                if (styles) {
                                    cssRules += `${elementChange.selector} { ${styles} }\n`;
                                }
                            }

                        } catch (elementError) {
                            debugLog('‚ùå Error applying element changes', elementError);
                        }
                    });

                    // Apply CSS rules
                    if (cssRules) {
                        styleElement.textContent = cssRules;
                        debugLog('‚úÖ Applied CSS rules', cssRules);
                    }

                    debugLog('‚úÖ All changes injected successfully');

                } catch (error) {
                    debugLog('‚ùå Failed to inject changes', error);
                    throw new Error('Failed to apply changes to page');
                }
            }, []);
            const apiCall = useCallback(async (endpoint, options = {}) => {
                const token = localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers,
                        ...options
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            localStorage.removeItem('authToken');
                            setIsAuthenticated(false);
                            setUser(null);
                            throw new Error('Unauthorized');
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }

                    return response.json();
                } catch (error) {
                    if (error.message !== 'Unauthorized') {
                        debugLog(`‚ùå API Error: ${endpoint}`, error.message);
                    }
                    throw error;
                }
            }, []);

            // Get current URL
            const getCurrentUrl = useCallback(() => {
                const page = pages.find(p => p.id === currentPage);
                if (!page) return `${MAIN_SITE_URL}/`;
                return page.id === 'live' ? page.url : `${MAIN_SITE_URL}${page.url}`;
            }, [currentPage]);

            // Handle iframe load with change restoration
            const handleIframeLoad = useCallback(async () => {
                debugLog('üìÑ Iframe loaded - initializing with saved changes...');
                
                // First load any saved changes
                try {
                    const savedChanges = await loadChangesFromPersistence(currentPage);
                    if (savedChanges && Object.keys(savedChanges.elements || {}).length > 0) {
                        debugLog('üîÑ Restoring saved changes...', savedChanges);
                        
                        // Wait a bit for iframe to fully load
                        setTimeout(async () => {
                            await injectChangesIntoIframe(savedChanges);
                            
                            // Then enable full edit mode
                            if (fullEditMode) {
                                setTimeout(() => scanAllElements(), 1000);
                            }
                        }, 1500);
                    } else {
                        debugLog('üìÑ No saved changes found, initializing fresh');
                        // Just enable edit mode normally
                        setTimeout(() => {
                            if (fullEditMode) {
                                scanAllElements();
                            }
                        }, 2000);
                    }
                } catch (error) {
                    debugLog('‚ùå Error loading saved changes', error);
                    // Fallback to normal initialization
                    setTimeout(() => {
                        if (fullEditMode) {
                            scanAllElements();
                        }
                    }, 2000);
                }
            }, [fullEditMode, scanAllElements, currentPage, loadChangesFromPersistence, injectChangesIntoIframe]);

            // Page change effect
            useEffect(() => {
                debugLog('üîÑ Page changed:', currentPage);
                
                editHandlersAttached.current = false;
                setEditableElements([]);
                setSelectedElement(null);
                setPropertyEditor(null);
                
                if (iframeRef.current) {
                    const page = pages.find(p => p.id === currentPage);
                    const newUrl = page?.id === 'live' ? page.url : `${MAIN_SITE_URL}${page?.url || '/'}`;
                    iframeRef.current.src = newUrl;
                }
            }, [currentPage]);

            // Full edit mode effect
            useEffect(() => {
                if (editHandlersAttached.current) {
                    if (fullEditMode) {
                        setTimeout(() => scanAllElements(), 500);
                    } else {
                        // Disable full edit mode
                        if (iframeRef.current) {
                            const iframe = iframeRef.current;
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            
                            if (iframeDoc) {
                                iframeDoc.body.classList.remove('full-edit-mode');
                                const editables = iframeDoc.querySelectorAll('.editable-element, .clickable-area');
                                editables.forEach(el => {
                                    el.classList.remove('editable-element', 'editable-text', 'editable-image', 'clickable-area');
                                    el.removeEventListener('click', handleElementClick);
                                    el.removeEventListener('click', handleAreaClick);
                                });
                            }
                        }
                        setEditableElements([]);
                        editHandlersAttached.current = false;
                    }
                }
            }, [fullEditMode, scanAllElements, handleElementClick, handleAreaClick]);

            // Creation mode effect
            useEffect(() => {
                setShowCreationOverlay(!!creationMode);
            }, [creationMode]);

            // Initialization effect
            useEffect(() => {
                if (isAuthenticated) {
                    setIsInitializing(true);
                    setTimeout(() => setIsInitializing(false), 3000);
                }
            }, [isAuthenticated]);

            // Socket connection effect
            useEffect(() => {
                if (isAuthenticated && !socketRef.current && !connectionAttempted.current) {
                    connectionAttempted.current = true;
                    debugLog('Connecting to live design socket...');
                    
                    const newSocket = io(SOCKET_URL, {
                        transports: ['websocket'],
                        timeout: 10000,
                        forceNew: true,
                        autoConnect: true
                    });
                    
                    socketRef.current = newSocket;
                    
                    newSocket.on('connect', () => {
                        debugLog('üî¥ LIVE CONNECTION ESTABLISHED');
                        setIsConnected(true);
                    });

                    newSocket.on('disconnect', () => {
                        debugLog('‚ùå Live connection lost');
                        setIsConnected(false);
                        connectionAttempted.current = false;
                    });

                    return () => {
                        newSocket.disconnect();
                        socketRef.current = null;
                        connectionAttempted.current = false;
                    };
                }
            }, [isAuthenticated]);

            // Authentication check
            useEffect(() => {
                const token = localStorage.getItem('authToken');
                if (token) {
                    setLoading(true);
                    apiCall('/auth/profile')
                        .then(response => {
                            const userData = response.user || response;
                            if (userData && userData.isAdmin) {
                                setUser(userData);
                                setIsAuthenticated(true);
                                debugLog('‚úÖ Admin authenticated');
                            } else {
                                localStorage.removeItem('authToken');
                                setError('Admin access required');
                            }
                        })
                        .catch(() => {
                            localStorage.removeItem('authToken');
                            setError('Session expired. Please login again.');
                        })
                        .finally(() => setLoading(false));
                } else {
                    setLoading(false);
                }
            }, [apiCall]);

            // Auto-detect changes
            useEffect(() => {
                if (liveChanges > 0) {
                    setHasUnpublishedChanges(true);
                }
            }, [liveChanges]);

            // Login Component
            const LoginForm = memo(() => {
                const [credentials, setCredentials] = useState({ username: '', password: '' });

                const handleLogin = useCallback(async () => {
                    if (!credentials.username || !credentials.password) {
                        setError('Please enter admin credentials');
                        return;
                    }

                    setLoading(true);
                    setError('');

                    try {
                        const response = await apiCall('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify(credentials)
                        });

                        if (!response.user || !response.user.isAdmin) {
                            throw new Error('Admin access required');
                        }

                        localStorage.setItem('authToken', response.token);
                        setUser(response.user);
                        setIsAuthenticated(true);
                        debugLog('‚úÖ Admin login successful');
                    } catch (err) {
                        setError(err.message || 'Login failed');
                    } finally {
                        setLoading(false);
                    }
                }, [credentials]);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 flex items-center justify-center p-4">
                        <div className="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üé®</div>
                                <h1 className="text-3xl font-black text-white mb-2">RTi Complete Studio</h1>
                                <p className="text-gray-300">Enhanced WYSIWYG Editor</p>
                                <div className="text-sm text-green-300 mt-2">
                                    ‚ú® Click Anywhere to Edit Everything!
                                </div>
                                <div className="text-sm text-blue-300 mt-1">
                                    üöÄ Publish ‚Ä¢ üí¨ Message ‚Ä¢ üì∑ Profile
                                </div>
                            </div>

                            {error && (
                                <div className="bg-red-500/20 border border-red-500 text-red-300 px-4 py-2 rounded-lg mb-4">
                                    {error}
                                    <button 
                                        onClick={() => setError('')}
                                        className="float-right text-red-400 hover:text-red-200"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            )}

                            <div className="space-y-4">
                                <input
                                    type="text"
                                    placeholder="Admin Username"
                                    value={credentials.username}
                                    onChange={(e) => setCredentials({...credentials, username: e.target.value})}
                                    className="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-white placeholder-gray-400"
                                />

                                <input
                                    type="password"
                                    placeholder="Password"
                                    value={credentials.password}
                                    onChange={(e) => setCredentials({...credentials, password: e.target.value})}
                                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    className="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-white placeholder-gray-400"
                                />

                                <button
                                    onClick={handleLogin}
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-lg font-bold hover:from-green-600 hover:to-blue-700 transition-all disabled:opacity-50"
                                >
                                    {loading ? 'üîí Connecting...' : 'üé® Enter Complete Studio'}
                                </button>

                                <button
                                    onClick={() => {
                                        localStorage.clear();
                                        setError('');
                                    }}
                                    className="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg text-sm transition-all"
                                >
                                    üßπ Clear Session
                                </button>
                            </div>
                        </div>
                    </div>
                );
            });

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-900 flex items-center justify-center">
                        <div className="text-center">
                            <div className="spinner mx-auto mb-4"></div>
                            <p className="text-white text-lg">Initializing Complete Studio...</p>
                        </div>
                    </div>
                );
            }

            if (!isAuthenticated) {
                return <LoginForm />;
            }

            return (
                <>
                    <div className="design-grid">
                        {/* Left Panel - Component Tree */}
                        <div className="component-tree p-4">
                            {/* Enhanced Clickable Profile Header */}
                            <div 
                                className="profile-header"
                                onClick={() => setShowProfileEditor(true)}
                            >
                                <div className="flex items-center gap-3">
                                    <div className="profile-avatar">
                                        <img
                                            src={user?.avatar || `https://ui-avatars.com/api/?name=${user?.username}&background=22c55e&color=fff&size=64`}
                                            alt="Profile"
                                            className="w-12 h-12 rounded-full border-2 border-white/30"
                                        />
                                    </div>
                                    <div className="flex-1">
                                        <div className="text-white font-bold">{user?.username}</div>
                                        <div className="text-white/70 text-sm">Complete Studio Admin</div>
                                    </div>
                                    <div className="text-white/70">üìù</div>
                                </div>
                            </div>

                            {/* Enhanced Status with Messaging */}
                            <div className="mb-4 p-3 bg-gray-800 rounded-lg">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="font-bold text-white">üî¥ Live Status</span>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setShowMessaging(!showMessaging)}
                                            className="w-6 h-6 bg-blue-500 hover:bg-blue-600 rounded-full flex items-center justify-center text-sm transition-all"
                                            title="Messages"
                                        >
                                            üí¨
                                        </button>
                                        <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500 live-indicator' : 'bg-gray-500'}`}></div>
                                    </div>
                                </div>
                                <div className="text-sm text-gray-300 space-y-1">
                                    <div>Status: {isConnected ? 'üü¢ Connected' : 'üî¥ Offline'}</div>
                                    <div>Changes: {liveChanges}</div>
                                    <div>Elements: {editableElements.length}</div>
                                    <div>Mode: {fullEditMode ? 'üé® Full Edit' : 'üìù Basic'}</div>
                                    {hasUnpublishedChanges && (
                                        <div className="text-yellow-400 font-medium">‚ö†Ô∏è Unpublished changes</div>
                                    )}
                                    {autoSaving && (
                                        <div className="text-blue-400 font-medium flex items-center gap-2">
                                            <div className="spinner w-3 h-3"></div>
                                            Auto-saving...
                                        </div>
                                    )}
                                    {lastSaved && !autoSaving && (
                                        <div className="text-green-400 text-xs">
                                            üíæ Saved: {lastSaved.toLocaleTimeString()}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* üöÄ Publish Button */}
                            <div className="mb-4">
                                <PublishButton
                                    onPublish={handlePublish}
                                    hasChanges={hasUnpublishedChanges}
                                    isPublishing={isPublishing}
                                />
                            </div>

                            {/* Tab Navigation */}
                            <div className="tab-container">
                                <button
                                    className={`tab-button ${activeTab === 'elements' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('elements')}
                                >
                                    üéØ Elements
                                </button>
                                <button
                                    className={`tab-button ${activeTab === 'media' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('media')}
                                >
                                    üìÅ Media
                                </button>
                                <button
                                    className={`tab-button ${activeTab === 'tools' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('tools')}
                                >
                                    üõ†Ô∏è Tools
                                </button>
                            </div>

                            {/* Tab Content */}
                            {activeTab === 'elements' && (
                                <div className="space-y-2">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="text-white font-medium">All Elements</span>
                                        <span className="text-green-400 text-sm">{editableElements.length}</span>
                                    </div>
                                    
                                    <div className="max-h-64 overflow-y-auto space-y-1">
                                        {editableElements.map((element, index) => (
                                            <div
                                                key={`${element.id}-${index}`}
                                                className="p-2 bg-gray-800 rounded text-xs hover:bg-gray-700 cursor-pointer transition-all"
                                                onClick={() => {
                                                    try {
                                                        element.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                        element.element.style.outline = '3px solid #22c55e';
                                                        setTimeout(() => {
                                                            element.element.style.outline = '';
                                                        }, 2000);
                                                    } catch (e) {}
                                                }}
                                            >
                                                <div className="font-medium text-white">{element.id}</div>
                                                <div className="text-gray-400">{element.tagName} ‚Ä¢ {element.type}</div>
                                                {element.text && (
                                                    <div className="text-gray-500 truncate">{element.text}...</div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'media' && (
                                <div className="space-y-4">
                                    <ImageUploader
                                        onUpload={(url) => {
                                            const newFile = { 
                                                url, 
                                                type: 'image', 
                                                name: `Upload ${Date.now()}`,
                                                timestamp: new Date().toLocaleTimeString()
                                            };
                                            setMediaFiles(prev => [newFile, ...prev.slice(0, 9)]);
                                            setHasUnpublishedChanges(true);
                                        }}
                                        title="Upload Media"
                                    />
                                    
                                    {mediaFiles.length > 0 && (
                                        <div className="space-y-2">
                                            <h4 className="font-medium text-white">Recent Files</h4>
                                            {mediaFiles.map((file, index) => (
                                                <div key={index} className="flex items-center gap-2 p-2 bg-gray-800 rounded hover:bg-gray-700 transition-all">
                                                    <img src={file.url} alt="" className="w-8 h-8 object-cover rounded" />
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-xs text-white font-medium truncate">{file.name}</div>
                                                        <div className="text-xs text-gray-400">{file.timestamp}</div>
                                                    </div>
                                                    <button
                                                        onClick={() => {
                                                            navigator.clipboard.writeText(file.url);
                                                            alert('URL copied!');
                                                        }}
                                                        className="text-xs text-blue-400 hover:text-blue-300 p-1"
                                                    >
                                                        üìã
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'tools' && (
                                <div className="space-y-3">
                                    <button
                                        onClick={() => setFullEditMode(!fullEditMode)}
                                        className={`w-full p-3 rounded-lg font-medium transition-all ${
                                            fullEditMode 
                                                ? 'bg-green-600 text-white edit-mode-active' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        {fullEditMode ? 'üé® Full Edit ON' : 'üé® Full Edit OFF'}
                                    </button>

                                    <button
                                        onClick={() => setShowElementToolbar(!showElementToolbar)}
                                        className={`w-full p-3 rounded-lg font-medium transition-all ${
                                            showElementToolbar 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        {showElementToolbar ? '‚ûï Hide Tools' : '‚ûï Add Elements'}
                                    </button>

                                    {/* üíæ Save/Load Controls */}
                                    <div className="border-t border-gray-600 pt-3">
                                        <h4 className="text-white font-medium mb-2">üíæ Save & Load</h4>
                                        
                                        <button
                                            onClick={async () => {
                                                try {
                                                    const changes = collectAllChanges();
                                                    await saveChangesToPersistence(changes);
                                                    setLastSaved(new Date());
                                                    alert('‚úÖ Changes saved manually!');
                                                } catch (error) {
                                                    alert('‚ùå Failed to save changes');
                                                }
                                            }}
                                            className="w-full mb-2 p-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium transition-all"
                                        >
                                            üíæ Save Now
                                        </button>
                                        
                                        <button
                                            onClick={async () => {
                                                if (confirm('üîÑ Load saved changes? This will restore your last saved state.')) {
                                                    try {
                                                        const savedChanges = await loadChangesFromPersistence(currentPage);
                                                        if (savedChanges) {
                                                            await injectChangesIntoIframe(savedChanges);
                                                            setHasUnpublishedChanges(true);
                                                            setTimeout(() => scanAllElements(), 1000);
                                                            alert('‚úÖ Saved changes restored!');
                                                        } else {
                                                            alert('üìÑ No saved changes found');
                                                        }
                                                    } catch (error) {
                                                        alert('‚ùå Failed to load changes');
                                                    }
                                                }
                                            }}
                                            className="w-full mb-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-all"
                                        >
                                            üîÑ Load Saved
                                        </button>

                                        <button
                                            onClick={() => {
                                                if (confirm('üóëÔ∏è Clear all changes? This will remove all unsaved edits and reload the original page.')) {
                                                    // Clear localStorage
                                                    localStorage.removeItem(`rti_design_changes_${currentPage}`);
                                                    
                                                    // Clear IndexedDB
                                                    const request = indexedDB.deleteDatabase('RTiDesignStudio');
                                                    request.onsuccess = () => debugLog('üóëÔ∏è IndexedDB cleared');
                                                    
                                                    // Reload iframe
                                                    if (iframeRef.current) {
                                                        iframeRef.current.src = iframeRef.current.src;
                                                    }
                                                    
                                                    // Reset state
                                                    setHasUnpublishedChanges(false);
                                                    setLiveChanges(0);
                                                    setEditableElements([]);
                                                    
                                                    alert('üóëÔ∏è All changes cleared!');
                                                }
                                            }}
                                            className="w-full mb-2 p-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium transition-all"
                                        >
                                            üóëÔ∏è Clear All
                                        </button>
                                    </div>

                                    <button
                                        onClick={() => setTestMode(!testMode)}
                                        className={`w-full p-3 rounded-lg font-medium transition-all ${
                                            testMode 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        üß™ {testMode ? 'Exit Test' : 'Test Mode'}
                                    </button>

                                    <button
                                        onClick={() => setShowCode(!showCode)}
                                        className={`w-full p-3 rounded-lg font-medium transition-all ${
                                            showCode 
                                                ? 'bg-yellow-600 text-white' 
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }`}
                                    >
                                        {showCode ? '</> Hide Code' : '</> Show Code'}
                                    </button>

                                    {testMode && (
                                        <div className="mt-4 p-3 bg-purple-900/50 rounded-lg">
                                            <h4 className="font-bold text-purple-300 mb-2">üß™ Test Users</h4>
                                            {testUsers.map(testUser => (
                                                <button
                                                    key={testUser.id}
                                                    onClick={() => {
                                                        // Inject test user logic
                                                        setTestUser(testUser);
                                                        setTestStatus(`Injected: ${testUser.username}`);
                                                    }}
                                                    className="w-full mb-1 p-2 bg-gray-700 hover:bg-gray-600 rounded text-left text-sm"
                                                >
                                                    <div className="font-medium text-white">{testUser.username}</div>
                                                    <div className="text-xs text-gray-400">{testUser.description}</div>
                                                </button>
                                            ))}
                                            {testStatus && (
                                                <div className="mt-2 p-2 bg-green-900/50 rounded text-xs text-green-300">
                                                    {testStatus}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Center Panel - Live Preview */}
                        <div className="bg-gray-100 flex flex-col h-full">
                            {/* Enhanced Toolbar */}
                            <div className="bg-white border-b border-gray-200 p-3 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center gap-2">
                                        <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500 live-indicator' : 'bg-gray-400'}`}></div>
                                        <span className="font-bold text-gray-800">
                                            {isConnected ? 'üî¥ LIVE' : '‚ö´ OFFLINE'}
                                        </span>
                                    </div>
                                    <span className="text-gray-600">Complete Studio</span>
                                    <span className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                        {currentPage}
                                    </span>
                                    {fullEditMode && (
                                        <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded font-bold">
                                            üé® FULL EDIT ({editableElements.length})
                                        </span>
                                    )}
                                    {creationMode && (
                                        <span className="text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded font-bold animate-pulse">
                                            ‚ûï ADDING {creationMode.toUpperCase()}
                                        </span>
                                    )}
                                    {hasUnpublishedChanges && (
                                        <span className="text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded font-bold">
                                            ‚ö†Ô∏è UNPUBLISHED
                                        </span>
                                    )}
                                </div>

                                <div className="flex items-center gap-2">
                                    <select
                                        value={previewMode}
                                        onChange={(e) => setPreviewMode(e.target.value)}
                                        className="px-3 py-1 border border-gray-300 rounded text-sm"
                                    >
                                        <option value="mobile">üì± Mobile</option>
                                        <option value="tablet">üìä Tablet</option>
                                        <option value="desktop">üñ•Ô∏è Desktop</option>
                                    </select>
                                    
                                    <button
                                        onClick={() => {
                                            if (iframeRef.current) {
                                                iframeRef.current.src = iframeRef.current.src;
                                            }
                                        }}
                                        className="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600"
                                    >
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>

                            {/* Page Tabs */}
                            <div className="bg-white border-b border-gray-200 flex overflow-x-auto">
                                {pages.map((page, index) => (
                                    <button
                                        key={`page-${page.id}-${index}`}
                                        onClick={() => setCurrentPage(page.id)}
                                        className={`page-tab px-4 py-3 text-sm font-medium whitespace-nowrap flex items-center gap-2 ${
                                            currentPage === page.id ? 'active' : ''
                                        }`}
                                    >
                                        <span>{page.icon}</span>
                                        {page.name}
                                    </button>
                                ))}
                            </div>

                            {/* Live Iframe */}
                            <div className="flex-1 p-4">
                                <div className={`bg-white rounded-lg shadow-lg overflow-hidden mx-auto h-full transition-all ${
                                    previewMode === 'mobile' ? 'max-w-sm' :
                                    previewMode === 'tablet' ? 'max-w-4xl' : 'w-full'
                                } ${fullEditMode ? 'ring-2 ring-green-500' : ''}`}>
                                    <iframe
                                        ref={iframeRef}
                                        src={getCurrentUrl()}
                                        className="live-iframe"
                                        title="Complete Studio Preview"
                                        onLoad={handleIframeLoad}
                                    />
                                </div>
                            </div>

                            {/* Live Changes Indicator */}
                            {showLiveIndicator && (
                                <div className="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50">
                                    üé® Live update applied! (Total: {liveChanges})
                                </div>
                            )}
                        </div>

                        {/* Right Panel - Properties */}
                        <div className="property-panel p-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold text-lg text-white">üé® Properties</h3>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setShowMessaging(!showMessaging)}
                                        className="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"
                                        title="Messages"
                                    >
                                        üí¨
                                    </button>
                                    <button
                                        onClick={() => setShowElementToolbar(!showElementToolbar)}
                                        className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"
                                    >
                                        ‚ûï Add
                                    </button>
                                </div>
                            </div>

                            {selectedElement ? (
                                <div className="space-y-4">
                                    <div className="p-3 bg-gray-800 rounded">
                                        <div className="text-green-400 font-medium">Selected Element</div>
                                        <div className="text-sm text-gray-300">
                                            {selectedElement.tagName} ‚Ä¢ {selectedElement.getAttribute('data-edit-id')}
                                        </div>
                                    </div>

                                    <div className="text-center py-4 text-gray-400">
                                        <div className="text-3xl mb-2">‚ú®</div>
                                        <p>Click element to edit properties</p>
                                        <p className="text-xs mt-1">Properties panel will appear</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center py-8 text-gray-400">
                                    <div className="text-4xl mb-3">üéØ</div>
                                    <p className="font-bold mb-2">Complete WYSIWYG Editor</p>
                                    <div className="text-sm space-y-1">
                                        <p>‚úÖ Click ANY element to edit</p>
                                        <p>‚úÖ Add elements anywhere</p>
                                        <p>‚úÖ Real-time live updates</p>
                                        <p>‚úÖ Full visual editing</p>
                                        <p>‚úÖ 3D elements supported</p>
                                        <p>üöÄ Publish to live site</p>
                                        <p>üí¨ Message team members</p>
                                        <p>üì∑ Upload profile photos</p>
                                    </div>
                                </div>
                            )}

                            {showCode && (
                                <div className="mt-6 p-3 bg-black rounded-lg">
                                    <h4 className="font-bold mb-2 text-green-400">üì° Live CSS</h4>
                                    <pre className="text-xs text-green-400 overflow-auto max-h-32">
{`.full-edit-mode .editable-element {
  outline: 1px dashed rgba(34, 197, 94, 0.5);
  cursor: pointer;
  transition: all 0.15s ease;
}

.full-edit-mode .editable-element:hover {
  outline: 2px solid #22c55e;
  background: rgba(34, 197, 94, 0.1);
  transform: scale(1.02);
}`}
                                    </pre>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Element Creation Toolbar */}
                    <ElementToolbar
                        isVisible={showElementToolbar}
                        onElementCreate={createElement}
                        creationMode={creationMode}
                        setCreationMode={setCreationMode}
                    />

                    {/* Creation Overlay */}
                    {showCreationOverlay && (
                        <div className="creation-overlay" />
                    )}

                    {/* Property Editor */}
                    {propertyEditor && (
                        <FloatingPropertyEditor
                            element={propertyEditor.element}
                            position={propertyEditor.position}
                            onClose={() => setPropertyEditor(null)}
                            onSave={handlePropertySave}
                        />
                    )}

                    {/* Enhanced Profile Editor */}
                    {showProfileEditor && (
                        <ProfileEditor
                            user={user}
                            onUpdate={(updatedUser) => {
                                setUser(updatedUser);
                                setShowProfileEditor(false);
                            }}
                            onClose={() => setShowProfileEditor(false)}
                        />
                    )}

                    {/* üí¨ Messaging System */}
                    {showMessaging && (
                        <MessagingSystem
                            user={user}
                            onClose={() => setShowMessaging(false)}
                            socket={socketRef.current}
                        />
                    )}

                    {/* üöÄ Publish Notification */}
                    <PublishNotification
                        show={showPublishNotification}
                        onClose={() => setShowPublishNotification(false)}
                    />
                </>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(RTiCompleteDesignStudio));
    </script>
</body>
</html>
