<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTi Cashflowops - Trading Group Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes dollarAcrossToMoon {
            0% { transform: translateX(0px) translateY(0px) scale(1) rotate(0deg); opacity: 1; }
            25% { transform: translateX(25vw) translateY(-30px) scale(1.1) rotate(15deg); opacity: 1; }
            50% { transform: translateX(50vw) translateY(-80px) scale(1.2) rotate(30deg); opacity: 1; }
            75% { transform: translateX(75vw) translateY(-140px) scale(1.1) rotate(45deg); opacity: 1; }
            100% { transform: translateX(calc(50vw - 50px)) translateY(-200px) scale(0.8) rotate(60deg); opacity: 0.9; }
        }
        
        @keyframes messageAppear {
            0%, 85% { opacity: 0; transform: translateY(20px); }
            90% { opacity: 1; transform: translateY(0px); }
            100% { opacity: 1; transform: translateY(0px); }
        }
        
        @keyframes moneyFall {
            0% { transform: translateY(-80px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(calc(100vh + 80px)) rotate(180deg); opacity: 0.8; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chat-message-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        .money-rain {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;
        }
        
        .falling-money {
            position: absolute; width: 40px; height: 17px;
            background: linear-gradient(135deg, #2d5016 0%, #3d6b1c 25%, #4a7c22 50%, #5a8c28 75%, #6ba02e 100%);
            border: 1px solid #1a3d0a; border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
            animation: moneyFall 4s ease-in infinite; position: relative;
        }
        
        .falling-money::before {
            content: '$1'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #1a3d0a; font-size: 10px; font-weight: bold; font-family: serif;
        }
        
        .falling-money::after {
            content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
            border: 1px solid rgba(26, 61, 10, 0.3); border-radius: 1px;
        }
        
        .plan-glow {
            animation: pulse 2s infinite;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
        }

        .chat-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }

        .chat-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .chat-scrollbar::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 3px;
        }

        .chat-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .chat-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Debug Panel Styles */
        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            width: 300px;
            z-index: 10000;
            border: 2px solid #00ff00;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #ff0000;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10001;
            font-weight: bold;
        }

        .error-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            width: 350px;
            z-index: 10000;
            border: 2px solid #ff0000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // üö® ENHANCED DEBUGGING SYSTEM
        let debugLogs = [];
        let errorLogs = [];
        let performanceMetrics = {};
        let initializationSteps = [];

        // State tracking for debugging
        let dashboardInitialized = false;
        let socketInitialized = false;
        let authCheckCompleted = false;
        let routingInitialized = false;
        let apiCallsInProgress = new Set();
        let componentRenderCount = 0;

        // Enhanced debug logging system
        const debugLog = (message, data = null, level = 'INFO') => {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logEntry = {
                timestamp,
                level,
                message,
                data,
                renderCount: componentRenderCount,
                stack: new Error().stack.split('\n')[2]?.trim()
            };

            debugLogs.push(logEntry);
            if (debugLogs.length > 50) debugLogs.shift(); // Keep last 50 logs

            // Console output with enhanced formatting
            const prefix = level === 'ERROR' ? '‚ùå' : level === 'WARN' ? '‚ö†Ô∏è' : level === 'SUCCESS' ? '‚úÖ' : 'üêõ';
            console.log(`${prefix} [${timestamp}][${level}][R:${componentRenderCount}] ${message}`);
            if (data) {
                console.log('üìä Data:', data);
                console.log('üìç Stack:', logEntry.stack);
            }

            // Track initialization steps
            if (message.includes('Dashboard Loaded') || message.includes('Socket') || message.includes('Auth') || message.includes('ROUTING')) {
                initializationSteps.push(logEntry);
            }

            // Auto-detect potential issues
            if (level === 'ERROR' || message.includes('failed') || message.includes('error')) {
                errorLogs.push(logEntry);
                if (errorLogs.length > 20) errorLogs.shift();
            }

            // Update debug panel if visible
            updateDebugPanel();
        };

        // Error tracking system
        const trackError = (error, context = 'Unknown') => {
            const errorEntry = {
                timestamp: new Date().toISOString(),
                context,
                message: error.message || error,
                stack: error.stack,
                renderCount: componentRenderCount
            };
            
            errorLogs.push(errorEntry);
            debugLog(`ERROR in ${context}: ${error.message || error}`, error, 'ERROR');
            
            // Update error panel
            updateErrorPanel();
        };

        // Performance monitoring
        const startPerformanceTimer = (operation) => {
            performanceMetrics[operation] = { start: performance.now() };
        };

        const endPerformanceTimer = (operation) => {
            if (performanceMetrics[operation]) {
                const duration = performance.now() - performanceMetrics[operation].start;
                performanceMetrics[operation].duration = duration;
                debugLog(`PERF: ${operation} took ${duration.toFixed(2)}ms`, null, 'INFO');
            }
        };

        // Debug panel management
        let debugPanelVisible = false;
        const updateDebugPanel = () => {
            if (!debugPanelVisible) return;
            
            const panel = document.getElementById('debug-panel');
            if (panel) {
                const recentLogs = debugLogs.slice(-10);
                panel.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px;">üîç RTi Debug Console</div>
                    <div style="margin-bottom: 5px;">Renders: ${componentRenderCount}</div>
                    <div style="margin-bottom: 5px;">Dashboard Init: ${dashboardInitialized ? '‚úÖ' : '‚ùå'}</div>
                    <div style="margin-bottom: 5px;">Socket Init: ${socketInitialized ? '‚úÖ' : '‚ùå'}</div>
                    <div style="margin-bottom: 5px;">Auth Complete: ${authCheckCompleted ? '‚úÖ' : '‚ùå'}</div>
                    <div style="margin-bottom: 5px;">Routing Init: ${routingInitialized ? '‚úÖ' : '‚ùå'}</div>
                    <div style="margin-bottom: 5px;">API Calls Active: ${apiCallsInProgress.size}</div>
                    <hr style="margin: 10px 0;">
                    <div style="font-weight: bold;">Recent Logs:</div>
                    ${recentLogs.map(log => `
                        <div style="margin: 2px 0; font-size: 10px;">
                            [${log.timestamp}] ${log.level}: ${log.message}
                        </div>
                    `).join('')}
                `;
            }
        };

        const updateErrorPanel = () => {
            const panel = document.getElementById('error-panel');
            if (panel && errorLogs.length > 0) {
                panel.style.display = 'block';
                const recentErrors = errorLogs.slice(-5);
                panel.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px;">üö® Error Console</div>
                    <button onclick="clearErrors()" style="background: darkred; color: white; border: none; padding: 2px 5px; border-radius: 3px;">Clear</button>
                    <hr style="margin: 10px 0;">
                    ${recentErrors.map(error => `
                        <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1);">
                            <div style="font-weight: bold;">[${error.timestamp.split('T')[1].split('.')[0]}] ${error.context}</div>
                            <div style="font-size: 10px;">${error.message}</div>
                        </div>
                    `).join('')}
                `;
            } else if (panel) {
                panel.style.display = 'none';
            }
        };

        // Global error handlers
        window.addEventListener('error', (event) => {
            trackError(event.error || event, 'Global Error Handler');
        });

        window.addEventListener('unhandledrejection', (event) => {
            trackError(event.reason, 'Unhandled Promise Rejection');
        });

        // Clear functions for panels
        window.clearErrors = () => {
            errorLogs = [];
            updateErrorPanel();
        };

        window.toggleDebug = () => {
            debugPanelVisible = !debugPanelVisible;
            const panel = document.getElementById('debug-panel');
            if (panel) {
                panel.style.display = debugPanelVisible ? 'block' : 'none';
            }
            updateDebugPanel();
        };

        // API Configuration
        const API_BASE_URL = 'https://rti-trading-backend-production.up.railway.app/api';

        // Socket.io connection
        let socket = null;

        const TradingGroupDashboard = () => {
            componentRenderCount++;
            debugLog(`Component render #${componentRenderCount}`, { 
                timestamp: new Date().toISOString(),
                location: 'TradingGroupDashboard'
            });

            const [user, setUser] = useState(null);
            const [showLanding, setShowLanding] = useState(true);
            const [showSubscriptionPicker, setShowSubscriptionPicker] = useState(false);
            const [alerts, setAlerts] = useState([]);
            const [members, setMembers] = useState([]);
            const [marketData, setMarketData] = useState({});
            const [filterType, setFilterType] = useState('ALL');
            const [newAlert, setNewAlert] = useState({ title: '', message: '', priority: 'MEDIUM', type: 'NEWS' });
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Chat state
            const [chatMessages, setChatMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [chatExpanded, setChatExpanded] = useState(false);
            const [unreadMessages, setUnreadMessages] = useState(0);
            const chatMessagesRef = useRef(null);

            // üåê URL ROUTING FUNCTIONS
            const updateURL = (path) => {
                const newUrl = `${window.location.origin}${path}`;
                debugLog(`üåê ROUTING: Updating URL to ${path}`, { newUrl });
                window.history.pushState({}, '', path);
            };

            const navigateToPage = (page) => {
                debugLog(`üåê ROUTING: Navigating to ${page}`);
                
                switch (page) {
                    case 'landing':
                        setShowLanding(true);
                        setShowSubscriptionPicker(false);
                        updateURL('/');
                        break;
                    case 'subscription':
                        setShowLanding(false);
                        setShowSubscriptionPicker(true);
                        updateURL('/subscription');
                        break;
                    case 'dashboard':
                        setShowLanding(false);
                        setShowSubscriptionPicker(false);
                        updateURL('/dashboard');
                        break;
                    default:
                        debugLog(`üåê ROUTING: Unknown page ${page}`, null, 'WARN');
                }
            };

            // üåê URL-BASED ROUTING INITIALIZATION
            useEffect(() => {
                if (routingInitialized) {
                    debugLog('üåê ROUTING: Skipping - already initialized', null, 'WARN');
                    return;
                }

                routingInitialized = true;
                const currentPath = window.location.pathname;
                debugLog('üåê ROUTING: Initializing URL-based routing', { 
                    currentPath,
                    origin: window.location.origin,
                    fullURL: window.location.href 
                }, 'SUCCESS');

                // Set initial state based on URL
                if (currentPath === '/dashboard') {
                    debugLog('üåê ROUTING: URL indicates dashboard - setting initial state');
                    setShowLanding(false);
                    setShowSubscriptionPicker(false);
                } else if (currentPath === '/subscription') {
                    debugLog('üåê ROUTING: URL indicates subscription - setting initial state');
                    setShowLanding(false);
                    setShowSubscriptionPicker(true);
                } else {
                    debugLog('üåê ROUTING: URL indicates landing page - setting initial state');
                    setShowLanding(true);
                    setShowSubscriptionPicker(false);
                }

                // Handle browser back/forward buttons
                const handlePopState = (event) => {
                    const path = window.location.pathname;
                    debugLog('üåê ROUTING: Browser navigation detected', { path });
                    
                    if (path === '/dashboard') {
                        setShowLanding(false);
                        setShowSubscriptionPicker(false);
                    } else if (path === '/subscription') {
                        setShowLanding(false);
                        setShowSubscriptionPicker(true);
                    } else {
                        setShowLanding(true);
                        setShowSubscriptionPicker(false);
                    }
                };

                window.addEventListener('popstate', handlePopState);

                return () => {
                    window.removeEventListener('popstate', handlePopState);
                    routingInitialized = false;
                };
            }, []);

            // Initialize debug panels when component mounts
            useEffect(() => {
                // Create debug panels
                const debugPanel = document.createElement('div');
                debugPanel.id = 'debug-panel';
                debugPanel.className = 'debug-panel';
                debugPanel.style.display = 'none';
                document.body.appendChild(debugPanel);

                const errorPanel = document.createElement('div');
                errorPanel.id = 'error-panel';
                errorPanel.className = 'error-panel';
                errorPanel.style.display = 'none';
                document.body.appendChild(errorPanel);

                const debugToggle = document.createElement('button');
                debugToggle.className = 'debug-toggle';
                debugToggle.textContent = 'üîç DEBUG';
                debugToggle.onclick = window.toggleDebug;
                document.body.appendChild(debugToggle);

                return () => {
                    debugPanel?.remove();
                    errorPanel?.remove();
                    debugToggle?.remove();
                };
            }, []);

            // Debug state changes
            useEffect(() => {
                debugLog('State Change: User', { user: user?.username || 'null', id: user?.id });
            }, [user]);

            useEffect(() => {
                debugLog('State Change: showLanding', showLanding);
            }, [showLanding]);

            useEffect(() => {
                debugLog('State Change: showSubscriptionPicker', showSubscriptionPicker);
            }, [showSubscriptionPicker]);

            useEffect(() => {
                debugLog('State Change: alerts count', alerts.length);
            }, [alerts]);

            useEffect(() => {
                debugLog('State Change: members count', members.length);
            }, [members]);

            // Initialize socket connection with enhanced debugging
            useEffect(() => {
                debugLog('useEffect: Socket initialization triggered', {
                    user: !!user,
                    socket: !!socket,
                    showSubscriptionPicker,
                    socketInitialized
                });

                try {
                    if (user && !socket && !showSubscriptionPicker && !socketInitialized) {
                        startPerformanceTimer('socket-init');
                        socketInitialized = true;
                        debugLog('SOCKET: Starting initialization...', { userId: user.id });
                        
                        socket = io(API_BASE_URL.replace('/api', ''));
                        
                        socket.on('connect', () => {
                            endPerformanceTimer('socket-init');
                            debugLog('SOCKET: Connected successfully', { socketId: socket.id }, 'SUCCESS');
                            socket.emit('joinTradingRoom', user.id);
                        });

                        socket.on('disconnect', (reason) => {
                            debugLog('SOCKET: Disconnected', { reason }, 'WARN');
                        });

                        socket.on('connect_error', (error) => {
                            trackError(error, 'Socket Connection');
                        });

                        socket.on('newAlert', (alert) => {
                            debugLog('SOCKET: New alert received', { alertId: alert._id });
                            setAlerts(prev => [alert, ...prev]);
                        });

                        socket.on('alertDeleted', (alertId) => {
                            debugLog('SOCKET: Alert deleted', { alertId });
                            setAlerts(prev => prev.filter(alert => alert._id !== alertId));
                        });

                        socket.on('marketUpdate', (data) => {
                            debugLog('SOCKET: Market update', { symbol: data.symbol });
                            setMarketData(prev => ({
                                ...prev,
                                [data.symbol]: data
                            }));
                        });

                        // Chat events with debugging
                        socket.on('chatMessage', (message) => {
                            debugLog('SOCKET: Chat message received', { from: message.user?.username });
                            setChatMessages(prev => [...prev, {
                                ...message,
                                id: message.id || Date.now() + Math.random(),
                                timestamp: new Date()
                            }]);
                            
                            if (!chatExpanded) {
                                setUnreadMessages(prev => prev + 1);
                            }
                        });

                        socket.on('userJoined', (userData) => {
                            debugLog('SOCKET: User joined', { username: userData.username });
                            setChatMessages(prev => [...prev, {
                                id: Date.now() + Math.random(),
                                type: 'system',
                                message: `${userData.username} joined the trading room`,
                                timestamp: new Date()
                            }]);
                        });

                        socket.on('userLeft', (userData) => {
                            debugLog('SOCKET: User left', { username: userData.username });
                            setChatMessages(prev => [...prev, {
                                id: Date.now() + Math.random(),
                                type: 'system',
                                message: `${userData.username} left the trading room`,
                                timestamp: new Date()
                            }]);
                        });

                        debugLog('SOCKET: All event listeners attached', null, 'SUCCESS');
                    }
                } catch (error) {
                    trackError(error, 'Socket useEffect');
                }

                return () => {
                    if (socket) {
                        debugLog('SOCKET: Cleaning up connection');
                        socket.disconnect();
                        socket = null;
                        socketInitialized = false;
                    }
                };
            }, [user, showSubscriptionPicker, chatExpanded]);

            // Auto-scroll chat to bottom
            useEffect(() => {
                if (chatMessagesRef.current) {
                    chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                }
            }, [chatMessages]);

            // Clear unread messages when chat is expanded
            useEffect(() => {
                if (chatExpanded) {
                    setUnreadMessages(0);
                }
            }, [chatExpanded]);

            // Enhanced API Functions with debugging
            const apiCall = async (endpoint, options = {}) => {
                const callId = `${options.method || 'GET'}-${endpoint}`;
                startPerformanceTimer(callId);
                
                const token = localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                debugLog(`API: Starting call to ${endpoint}`, { 
                    method: options.method || 'GET',
                    hasToken: !!token,
                    hasBody: !!options.body
                });

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers,
                        ...options
                    });

                    endPerformanceTimer(callId);
                    
                    debugLog(`API: Response from ${endpoint}`, { 
                        status: response.status, 
                        ok: response.ok,
                        statusText: response.statusText
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        const error = new Error(errorData.error || `HTTP ${response.status}`);
                        trackError(error, `API Call: ${endpoint}`);
                        throw error;
                    }

                    const data = await response.json();
                    debugLog(`API: Success ${endpoint}`, { dataKeys: Object.keys(data) }, 'SUCCESS');
                    return data;
                } catch (error) {
                    endPerformanceTimer(callId);
                    trackError(error, `API Call: ${endpoint}`);
                    throw error;
                }
            };

            // Check if user requires subscription selection
            const requiresSubscriptionSelection = (user) => {
                debugLog('Checking subscription requirements', { 
                    userId: user?.id,
                    tier: user?.tier,
                    isAdmin: user?.isAdmin,
                    subscriptionStatus: user?.subscriptionStatus
                });

                if (!user) return false;
                if (user.isAdmin) return false;
                
                const needsSubscription = 
                    user.tier === 'FREE' || 
                    !user.subscriptionStatus || 
                    user.subscriptionStatus === 'inactive' ||
                    user.subscriptionStatus === 'expired' ||
                    user.subscriptionStatus === 'cancelled' ||
                    (!user.subscriptionId && user.tier !== 'WEEKLY' && user.tier !== 'MONTHLY');
                
                debugLog('Subscription check result', {
                    needsSubscription,
                    reason: needsSubscription ? 'Missing or invalid subscription' : 'Valid subscription found'
                });
                
                return needsSubscription;
            };

            // Chat functions
            const sendChatMessage = () => {
                if (!newMessage.trim() || !socket) return;

                const messageData = {
                    message: newMessage.trim(),
                    user: {
                        id: user.id,
                        username: user.username,
                        avatar: user.avatar,
                        tier: user.tier,
                        isAdmin: user.isAdmin
                    },
                    timestamp: new Date()
                };

                debugLog('CHAT: Sending message', { messageLength: messageData.message.length });
                socket.emit('chatMessage', messageData);
                setNewMessage('');
            };

            const handleChatKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            };

            const formatChatTime = (timestamp) => {
                return new Date(timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };

            const getTierColor = (tier) => {
                switch (tier) {
                    case 'ADMIN': return 'text-red-600 bg-red-100';
                    case 'MONTHLY': return 'text-green-600 bg-green-100';
                    case 'WEEKLY': return 'text-blue-600 bg-blue-100';
                    default: return 'text-gray-600 bg-gray-100';
                }
            };

            // Enhanced fetchAlerts with debugging
            const fetchAlerts = async () => {
                const callId = 'fetchAlerts';
                if (apiCallsInProgress.has(callId)) {
                    debugLog('API: Skipping fetchAlerts - already in progress', null, 'WARN');
                    return;
                }
                
                apiCallsInProgress.add(callId);
                debugLog('API: Starting fetchAlerts', { filterType });
                
                try {
                    const data = await apiCall(`/alerts?type=${filterType}`);
                    setAlerts(data);
                    debugLog('API: fetchAlerts completed', { count: data?.length || 0 }, 'SUCCESS');
                } catch (err) {
                    trackError(err, 'fetchAlerts');
                    setError('Failed to fetch alerts');
                } finally {
                    apiCallsInProgress.delete(callId);
                }
            };

            // Enhanced fetchActiveUsers with debugging
            const fetchActiveUsers = async () => {
                const callId = 'fetchActiveUsers';
                if (apiCallsInProgress.has(callId)) {
                    debugLog('API: Skipping fetchActiveUsers - already in progress', null, 'WARN');
                    return;
                }
                
                apiCallsInProgress.add(callId);
                debugLog('API: Starting fetchActiveUsers');
                
                try {
                    const data = await apiCall('/users/active');
                    const mappedUsers = data.map((user, index) => ({
                        id: user._id || `user-${index}`,
                        username: user.username,
                        avatar: user.avatar,
                        tier: user.tier,
                        status: 'online'
                    }));
                    setMembers(mappedUsers);
                    debugLog('API: fetchActiveUsers completed', { count: mappedUsers.length }, 'SUCCESS');
                } catch (err) {
                    trackError(err, 'fetchActiveUsers');
                } finally {
                    apiCallsInProgress.delete(callId);
                }
            };

            // Enhanced data fetching with initialization guard
            useEffect(() => {
                debugLog('useEffect: Data fetching triggered', {
                    user: !!user,
                    showSubscriptionPicker,
                    dashboardInitialized,
                    filterType
                });

                try {
                    if (user && !showSubscriptionPicker && !dashboardInitialized) {
                        dashboardInitialized = true;
                        debugLog('üöÄ RTi Cashflowops Dashboard Loaded', null, 'SUCCESS');
                        
                        // Start both API calls
                        fetchAlerts();
                        fetchActiveUsers();
                    } else if (user && !showSubscriptionPicker && dashboardInitialized) {
                        // Only refetch alerts when filter changes
                        debugLog('Dashboard already initialized, refetching alerts for filter change');
                        fetchAlerts();
                    }
                } catch (error) {
                    trackError(error, 'Data fetching useEffect');
                }
            }, [user, filterType, showSubscriptionPicker]);

            const formatTimeAgo = (timestamp) => {
                const diff = Date.now() - new Date(timestamp).getTime();
                const minutes = Math.floor(diff / 60000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                return `${Math.floor(minutes / 60)}h ago`;
            };

            const handleCreateAlert = async () => {
                if (!user.isAdmin || !newAlert.title || !newAlert.message) return;
                
                setLoading(true);
                debugLog('ADMIN: Creating new alert', { title: newAlert.title, type: newAlert.type });
                
                try {
                    await apiCall('/alerts', {
                        method: 'POST',
                        body: JSON.stringify(newAlert)
                    });
                    setNewAlert({ title: '', message: '', priority: 'MEDIUM', type: 'NEWS' });
                    setError('');
                    debugLog('ADMIN: Alert created successfully', null, 'SUCCESS');
                } catch (err) {
                    trackError(err, 'Create Alert');
                    setError('Failed to create alert');
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteAlert = async (alertId) => {
                if (!user.isAdmin) return;
                
                debugLog('ADMIN: Deleting alert', { alertId });
                try {
                    await apiCall(`/alerts/${alertId}`, { method: 'DELETE' });
                    debugLog('ADMIN: Alert deleted successfully', null, 'SUCCESS');
                } catch (err) {
                    trackError(err, 'Delete Alert');
                    setError('Failed to delete alert');
                }
            };

            const LandingPage = () => {
                debugLog('Rendering LandingPage component');
                const [loginData, setLoginData] = useState({ username: '', password: '' });
                const [isRegistering, setIsRegistering] = useState(false);
                const [registerData, setRegisterData] = useState({ username: '', email: '', password: '' });
                const [isAdminLogin, setIsAdminLogin] = useState(false);

                const handleLogin = async () => {
                    debugLog('=== LOGIN ATTEMPT ===', {
                        username: loginData.username,
                        hasPassword: !!loginData.password,
                        isAdminLogin
                    });
                    
                    if (!loginData.username || !loginData.password) {
                        setError('Please enter username and password');
                        return;
                    }

                    setLoading(true);
                    setError('');

                    try {
                        startPerformanceTimer('login');
                        const response = await apiCall('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify(loginData)
                        });
                        endPerformanceTimer('login');

                        debugLog('LOGIN: Success', { userId: response.user?.id }, 'SUCCESS');

                        localStorage.setItem('authToken', response.token);
                        setUser(response.user);

                        if (requiresSubscriptionSelection(response.user)) {
                            debugLog('LOGIN: Redirecting to subscription picker');
                            navigateToPage('subscription');
                            return;
                        }

                        debugLog('LOGIN: Redirecting to dashboard');
                        navigateToPage('dashboard');
                    } catch (err) {
                        trackError(err, 'Login');
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                const handleRegister = async () => {
                    debugLog('=== REGISTRATION ATTEMPT ===', {
                        username: registerData.username,
                        email: registerData.email,
                        hasPassword: !!registerData.password
                    });
                    
                    if (!registerData.username || !registerData.email || !registerData.password) {
                        setError('Please fill in all fields');
                        return;
                    }

                    setLoading(true);
                    setError('');

                    try {
                        startPerformanceTimer('register');
                        const response = await apiCall('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify(registerData)
                        });
                        endPerformanceTimer('register');

                        debugLog('REGISTER: Success', { userId: response.user?.id }, 'SUCCESS');

                        localStorage.setItem('authToken', response.token);
                        setUser(response.user);
                        
                        debugLog('REGISTER: New user - showing subscription picker');
                        navigateToPage('subscription');
                    } catch (err) {
                        trackError(err, 'Registration');
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black overflow-hidden relative">
                        {/* Money Rain Effect */}
                        <div className="money-rain">
                            {[...Array(20)].map((_, i) => {
                                const randomLeft = ((i * 17) % 100);
                                const randomDelay = ((i * 7) % 40) / 10;
                                const randomDuration = 3 + ((i * 3) % 20) / 10;
                                return (
                                    <div 
                                        key={`landing-money-${i}`}
                                        className="falling-money"
                                        style={{
                                            left: `${randomLeft}%`,
                                            animationDelay: `${randomDelay}s`,
                                            animationDuration: `${randomDuration}s`
                                        }}
                                    />
                                );
                            })}
                        </div>

                        <div className="absolute inset-0">
                            <div className="absolute top-20 left-10 w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                            <div className="absolute top-40 right-20 w-1 h-1 bg-white rounded-full animate-ping"></div>
                            <div className="absolute bottom-32 left-1/4 w-1.5 h-1.5 bg-green-400 rounded-full animate-bounce"></div>
                        </div>

                        <div className="relative z-10 flex flex-col items-center justify-center min-h-screen px-4 pt-32">
                            <div className="relative mb-6">
                                <div className="flex justify-center">
                                    <div className="text-8xl">üåï</div>
                                </div>
                            </div>

                            <div className="text-center mb-8">
                                <h1 
                                    className="text-6xl md:text-8xl font-black text-white mb-4 tracking-wider"
                                    style={{
                                        fontFamily: 'Impact, Arial Black, sans-serif',
                                        textShadow: '0 0 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(34, 197, 94, 0.2)'
                                    }}
                                >
                                    RTi
                                </h1>
                                <h2 
                                    className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-500 tracking-wide"
                                    style={{
                                        fontFamily: 'Impact, Arial Black, sans-serif'
                                    }}
                                >
                                    CASHFLOWOPS
                                </h2>
                                <p className="text-xl md:text-2xl text-gray-300 mt-4 font-bold tracking-widest">
                                    TO THE MOON üöÄ
                                </p>
                            </div>

                            <div className="relative w-full h-24 mb-6">
                                <div 
                                    className="absolute bottom-0 left-0"
                                    style={{
                                        animation: 'dollarAcrossToMoon 4s ease-in-out forwards'
                                    }}
                                >
                                    <div 
                                        className="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-500 cursor-pointer select-none"
                                        style={{
                                            fontFamily: 'Impact, Arial Black, sans-serif',
                                            textShadow: '0 0 30px rgba(34, 197, 94, 0.8), 0 0 60px rgba(234, 179, 8, 0.6)'
                                        }}
                                    >
                                        $
                                    </div>
                                    
                                    <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
                                        <div 
                                            className="w-6 h-8 bg-gradient-to-t from-red-500 via-orange-400 to-yellow-300 opacity-90"
                                            style={{
                                                clipPath: 'polygon(50% 100%, 20% 0%, 80% 0%)'
                                            }}
                                        ></div>
                                    </div>
                                    
                                    <div className="absolute -bottom-1 left-1/4 transform -translate-x-1/2">
                                        <div 
                                            className="w-3 h-6 bg-gradient-to-t from-orange-500 to-red-400 opacity-70"
                                            style={{
                                                clipPath: 'polygon(50% 100%, 0% 0%, 100% 0%)'
                                            }}
                                        ></div>
                                    </div>
                                    
                                    <div className="absolute -bottom-1 right-1/4 transform translate-x-1/2">
                                        <div 
                                            className="w-3 h-6 bg-gradient-to-t from-orange-500 to-red-400 opacity-70"
                                            style={{
                                                clipPath: 'polygon(50% 100%, 0% 0%, 100% 0%)'
                                            }}
                                        ></div>
                                    </div>
                                </div>
                            </div>

                            <div className="text-center mb-6">
                                <p 
                                    className="text-2xl font-black text-yellow-400 opacity-0"
                                    style={{
                                        fontFamily: 'Impact, Arial Black, sans-serif',
                                        animation: 'messageAppear 4s ease-out forwards'
                                    }}
                                >
                                    üöÄ MOON LANDING SUCCESSFUL! üåï
                                </p>
                            </div>

                            <div className="bg-black/80 backdrop-blur-lg border border-green-500/30 rounded-2xl shadow-2xl p-8 w-full max-w-md">
                                {error && (
                                    <div className="bg-red-500/20 border border-red-500 text-red-300 px-4 py-2 rounded-lg mb-4">
                                        {error}
                                    </div>
                                )}

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setIsRegistering(false)}
                                        className={`flex-1 py-2 px-4 rounded-lg font-medium ${
                                            !isRegistering 
                                                ? 'bg-green-600 text-white' 
                                                : 'bg-gray-700 text-gray-300'
                                        }`}
                                    >
                                        Login
                                    </button>
                                    <button
                                        onClick={() => setIsRegistering(true)}
                                        className={`flex-1 py-2 px-4 rounded-lg font-medium ${
                                            isRegistering 
                                                ? 'bg-green-600 text-white' 
                                                : 'bg-gray-700 text-gray-300'
                                        }`}
                                    >
                                        Sign up
                                    </button>
                                </div>

                                <div className="mb-6 p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
                                    <div className="flex items-center justify-between">
                                        <span className="text-red-300 text-sm font-medium">üîê Admin Access</span>
                                        <button
                                            onClick={() => setIsAdminLogin(!isAdminLogin)}
                                            className={`px-3 py-1 rounded text-xs font-bold transition-colors ${
                                                isAdminLogin 
                                                    ? 'bg-red-500 text-white' 
                                                    : 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                            }`}
                                        >
                                            {isAdminLogin ? '‚úÖ ADMIN MODE' : 'Switch to Admin'}
                                        </button>
                                    </div>
                                    {isAdminLogin && (
                                        <div className="mt-2 text-xs text-red-200">
                                            üîí Redirects to secure admin login page
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-6">
                                    {isRegistering && (
                                        <div>
                                            <label className="block text-sm font-bold text-green-400 mb-2 uppercase tracking-wide">Email</label>
                                            <input
                                                type="email"
                                                value={registerData.email}
                                                onChange={(e) => setRegisterData({...registerData, email: e.target.value})}
                                                className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent text-white placeholder-gray-400"
                                                placeholder="Enter your email"
                                            />
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-bold text-green-400 mb-2 uppercase tracking-wide">Username</label>
                                        <input
                                            type="text"
                                            value={isRegistering ? registerData.username : loginData.username}
                                            onChange={(e) => {
                                                if (isRegistering) {
                                                    setRegisterData({...registerData, username: e.target.value});
                                                } else {
                                                    setLoginData({...loginData, username: e.target.value});
                                                }
                                            }}
                                            className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent text-white placeholder-gray-400"
                                            placeholder="Enter your username"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-green-400 mb-2 uppercase tracking-wide">Password</label>
                                        <input
                                            type="password"
                                            value={isRegistering ? registerData.password : loginData.password}
                                            onChange={(e) => {
                                                if (isRegistering) {
                                                    setRegisterData({...registerData, password: e.target.value});
                                                } else {
                                                    setLoginData({...loginData, password: e.target.value});
                                                }
                                            }}
                                            className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent text-white placeholder-gray-400"
                                            placeholder="Enter your password"
                                        />
                                    </div>

                                    <button
                                        onClick={isRegistering ? handleRegister : handleLogin}
                                        disabled={loading}
                                        className="w-full bg-gradient-to-r from-green-500 via-yellow-500 to-orange-500 text-black py-4 rounded-lg font-black text-lg hover:from-green-600 hover:via-yellow-600 hover:to-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg uppercase tracking-wide disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {loading ? 'üöÄ Loading...' : 
                                         isAdminLogin ? 'üîê ADMIN SECURE LOGIN' :
                                         `üöÄ ${isRegistering ? 'Join' : 'Launch to'} Dashboard`}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const SubscriptionPicker = () => {
                debugLog('Rendering SubscriptionPicker component');
                const [selectedPlan, setSelectedPlan] = useState('');
                const [isProcessing, setIsProcessing] = useState(false);

                const plans = [
                    {
                        id: 'weekly',
                        name: 'Weekly Access',
                        price: 6,
                        interval: 'week',
                        popular: false,
                        features: [
                            'Full group access',
                            'Custom charts & analysis', 
                            'Unlimited live alerts',
                            'Live news feed',
                            'Real-time market data',
                            'Direct trader access'
                        ]
                    },
                    {
                        id: 'monthly',
                        name: 'Monthly Access',
                        price: 20,
                        interval: 'month',
                        popular: true,
                        features: [
                            'Full group access',
                            'Custom charts & analysis',
                            'Unlimited live alerts', 
                            'Live news feed',
                            'Real-time market data',
                            'Direct trader access',
                            'üî• Save $4/month vs weekly'
                        ]
                    }
                ];

                const handlePlanSelection = async (planId) => {
                    setIsProcessing(true);
                    debugLog('SUBSCRIPTION: Plan selected', { planId });
                    
                    try {
                        debugLog('SUBSCRIPTION: Opening payment window', { planId });
                        
                        if (planId === 'weekly') {
                            window.open('https://buy.stripe.com/aFa3cw2g84qA9E78Wq18c00', '_blank');
                        } else {
                            window.open('https://buy.stripe.com/aFa3cw2g84qA9E78Wq18c00', '_blank');
                        }
                        
                        setError('üöÄ Redirecting to secure payment... Complete payment to access dashboard!');
                        
                    } catch (error) {
                        trackError(error, 'Plan Selection');
                        setError('Payment failed. Please try again.');
                    } finally {
                        setIsProcessing(false);
                    }
                };

                const handleSkipForNow = () => {
                    debugLog('SUBSCRIPTION: User chose to skip');
                    
                    if (user && (!user.tier || user.tier === undefined)) {
                        setUser({
                            ...user,
                            tier: 'FREE',
                            subscriptionStatus: 'free'
                        });
                    }
                    
                    navigateToPage('dashboard');
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black overflow-hidden relative">
                        <div className="money-rain">
                            {[...Array(15)].map((_, i) => {
                                const randomLeft = ((i * 23) % 100);
                                const randomDelay = ((i * 11) % 50) / 10;
                                const randomDuration = 4 + ((i * 5) % 15) / 10;
                                return (
                                    <div 
                                        key={`subscription-money-${i}`}
                                        className="falling-money"
                                        style={{
                                            left: `${randomLeft}%`,
                                            animationDelay: `${randomDelay}s`,
                                            animationDuration: `${randomDuration}s`
                                        }}
                                    />
                                );
                            })}
                        </div>

                        <div className="relative z-10 min-h-screen flex items-center justify-center px-4 py-12">
                            <div className="w-full max-w-6xl">
                                <div className="text-center mb-12">
                                    <div className="text-6xl mb-6">üöÄüåï</div>
                                    <h1 className="text-4xl md:text-6xl font-black text-white mb-4 tracking-wider"
                                        style={{ fontFamily: 'Impact, Arial Black, sans-serif' }}>
                                        CHOOSE YOUR MISSION
                                    </h1>
                                    <p className="text-xl text-gray-300 mb-2">
                                        Welcome to RTi Cashflowops, <span className="text-green-400 font-bold">{user?.username}</span>!
                                    </p>
                                    <p className="text-gray-400">
                                        Select a plan to unlock the full trading experience and join our exclusive community.
                                    </p>
                                </div>

                                {error && (
                                    <div className="max-w-2xl mx-auto mb-8 bg-red-500/20 border border-red-500 text-red-300 px-6 py-4 rounded-lg text-center">
                                        {error}
                                    </div>
                                )}

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-4xl mx-auto mb-12">
                                    {plans.map((plan) => (
                                        <div key={plan.id} className={`relative bg-black/80 backdrop-blur-lg border rounded-2xl p-8 transition-all duration-300 hover:scale-105 ${
                                            plan.popular 
                                                ? 'border-green-500 plan-glow' 
                                                : 'border-gray-500 hover:border-green-400'
                                        }`}>
                                            {plan.popular && (
                                                <div className="absolute -top-4 left-1/2 transform -translate-x-1/2">
                                                    <span className="bg-green-500 text-black px-4 py-2 rounded-full text-sm font-black uppercase">
                                                        üî• Most Popular
                                                    </span>
                                                </div>
                                            )}

                                            <div className="text-center mb-6">
                                                <h3 className="text-2xl font-black text-white mb-2">{plan.name}</h3>
                                                <div className="text-4xl font-black text-green-400 mb-2">
                                                    ${plan.price}
                                                    <span className="text-lg text-gray-400">/{plan.interval}</span>
                                                </div>
                                                <p className="text-gray-400">
                                                    {plan.interval === 'week' ? 'Weekly billing' : 'Monthly billing - Best value!'}
                                                </p>
                                            </div>

                                            <ul className="space-y-3 mb-8">
                                                {plan.features.map((feature, idx) => (
                                                    <li key={`${plan.id}-feature-${idx}`} className="flex items-center text-gray-300">
                                                        <span className="text-green-400 mr-3">‚úÖ</span>
                                                        {feature}
                                                    </li>
                                                ))}
                                            </ul>

                                            <button
                                                onClick={() => handlePlanSelection(plan.id)}
                                                disabled={isProcessing}
                                                className={`w-full py-4 px-6 rounded-lg font-black text-lg transition-all duration-300 ${
                                                    plan.popular
                                                        ? 'bg-gradient-to-r from-green-500 via-yellow-500 to-orange-500 text-black hover:from-green-600 hover:via-yellow-600 hover:to-orange-600 transform hover:scale-105'
                                                        : 'bg-gray-700 text-white hover:bg-gray-600'
                                                } disabled:opacity-50 disabled:cursor-not-allowed`}
                                            >
                                                {isProcessing ? 'üöÄ Processing...' : `üöÄ SELECT ${plan.name.toUpperCase()}`}
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                <div className="text-center">
                                    <button
                                        onClick={handleSkipForNow}
                                        className="text-gray-400 hover:text-white transition-colors text-sm underline"
                                    >
                                        Continue with limited free access for now
                                    </button>
                                    <p className="text-xs text-gray-500 mt-2">
                                        (You can upgrade anytime from the dashboard)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Chat Panel Component
            const ChatPanel = () => {
                const isPaidUser = user.tier === 'WEEKLY' || user.tier === 'MONTHLY' || user.isAdmin;
                const maxMessages = isPaidUser ? 100 : 10;

                return (
                    <div className={`fixed bottom-0 right-4 z-50 transition-all duration-300 ${
                        chatExpanded ? 'w-96 h-96' : 'w-80 h-12'
                    }`}>
                        <div 
                            className="bg-gradient-to-r from-green-500 to-blue-600 text-white px-4 py-3 rounded-t-lg cursor-pointer flex items-center justify-between hover:from-green-600 hover:to-blue-700 transition-all"
                            onClick={() => setChatExpanded(!chatExpanded)}
                        >
                            <div className="flex items-center gap-2">
                                <span className="text-lg">üí¨</span>
                                <span className="font-bold">Trading Chat</span>
                                <div className="w-2 h-2 bg-green-300 rounded-full animate-pulse"></div>
                            </div>
                            <div className="flex items-center gap-2">
                                {unreadMessages > 0 && (
                                    <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">
                                        {unreadMessages}
                                    </span>
                                )}
                                <span className="text-sm">
                                    {chatExpanded ? '‚ñº' : '‚ñ≤'}
                                </span>
                            </div>
                        </div>

                        {chatExpanded && (
                            <div className="bg-white border-l border-r border-gray-200 flex flex-col h-80">
                                <div 
                                    ref={chatMessagesRef}
                                    className="flex-1 overflow-y-auto p-3 space-y-3 chat-scrollbar"
                                >
                                    {chatMessages.length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">
                                            <span className="text-4xl mb-2 block">üöÄ</span>
                                            <p className="text-sm">Welcome to RTi Trading Chat!</p>
                                            <p className="text-xs text-gray-400 mt-1">Start the conversation...</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {chatMessages.slice(-maxMessages).map((message) => (
                                                <div key={message.id} className="chat-message-enter">
                                                    {message.type === 'system' ? (
                                                        <div className="text-center">
                                                            <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                                                {message.message}
                                                            </span>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-start gap-2">
                                                            <img 
                                                                src={message.user.avatar} 
                                                                alt="" 
                                                                className="w-8 h-8 rounded-full flex-shrink-0"
                                                            />
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center gap-2 mb-1">
                                                                    <span className="font-medium text-sm text-gray-900 truncate">
                                                                        {message.user.username}
                                                                    </span>
                                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${getTierColor(message.user.tier)}`}>
                                                                        {message.user.tier}
                                                                    </span>
                                                                    <span className="text-xs text-gray-400">
                                                                        {formatChatTime(message.timestamp)}
                                                                    </span>
                                                                </div>
                                                                <p className="text-sm text-gray-700 break-words">
                                                                    {message.message}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {!isPaidUser && chatMessages.length > maxMessages && (
                                        <div className="text-center py-2 border-t">
                                            <p className="text-xs text-gray-500">
                                                Showing last {maxMessages} messages
                                            </p>
                                            <button 
                                                onClick={() => navigateToPage('subscription')}
                                                className="text-xs text-blue-600 hover:text-blue-800 underline"
                                            >
                                                Upgrade to see full chat history
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div className="border-t p-3">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newMessage}
                                            onChange={(e) => setNewMessage(e.target.value)}
                                            onKeyPress={handleChatKeyPress}
                                            placeholder={isPaidUser ? "Type your message..." : "Upgrade for unlimited messages..."}
                                            className="flex-1 text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            disabled={!isPaidUser}
                                        />
                                        <button
                                            onClick={sendChatMessage}
                                            disabled={!newMessage.trim() || !isPaidUser}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            üöÄ
                                        </button>
                                    </div>
                                    {!isPaidUser && (
                                        <p className="text-xs text-gray-500 mt-1 text-center">
                                            <button 
                                                onClick={() => navigateToPage('subscription')}
                                                className="text-blue-600 hover:text-blue-800 underline"
                                            >
                                                Upgrade to participate in chat
                                            </button>
                                        </p>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const Dashboard = () => {
                debugLog('Rendering Dashboard component');
                
                if (showSubscriptionPicker) {
                    return null;
                }

                const filteredAlerts = alerts.filter(alert => 
                    filterType === 'ALL' || alert.type === filterType
                );

                const isPaidUser = user.tier === 'WEEKLY' || user.tier === 'MONTHLY' || user.isAdmin;
                const limitedAlerts = isPaidUser ? filteredAlerts : filteredAlerts.slice(0, 3);

                return (
                    <div className="min-h-screen bg-gray-50 relative">
                        <header className="bg-white shadow-sm border-b">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex justify-between items-center h-16">
                                    <div className="flex items-center gap-3">
                                        <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-orange-500">
                                            RTi Cashflowops
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-4">
                                        <div className="flex items-center gap-2 text-green-600">
                                            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <span className="text-sm font-medium">Live</span>
                                        </div>

                                        {user.isAdmin && (
                                            <button
                                                onClick={() => setShowAdminPanel(!showAdminPanel)}
                                                className="flex items-center gap-2 bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-red-600"
                                            >
                                                ‚öôÔ∏è Admin Panel
                                            </button>
                                        )}

                                        <div className="flex items-center gap-3">
                                            <img src={user.avatar} alt="" className="w-8 h-8 rounded-full" />
                                            <div className="text-right">
                                                <p className="text-sm font-medium text-gray-900">{user.username}</p>
                                                <p className={`text-xs ${
                                                    user.tier === 'ADMIN' ? 'text-red-600' :
                                                    user.tier === 'MONTHLY' ? 'text-green-600' :
                                                    user.tier === 'WEEKLY' ? 'text-blue-600' :
                                                    user.tier === 'FREE' ? 'text-gray-500' : 'text-gray-600'
                                                }`}>
                                                    {user.tier === 'FREE' ? 'FREE TIER' : user.tier}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    debugLog('LOGOUT: User logging out');
                                                    localStorage.removeItem('authToken');
                                                    setUser(null);
                                                    navigateToPage('landing');
                                                    if (socket) {
                                                        socket.disconnect();
                                                        socket = null;
                                                    }
                                                    // Reset initialization flags
                                                    dashboardInitialized = false;
                                                    socketInitialized = false;
                                                    authCheckCompleted = false;
                                                    routingInitialized = false;
                                                }}
                                                className="p-1 text-gray-400 hover:text-gray-600"
                                            >
                                                üö™
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                    <button 
                                        onClick={() => setError('')}
                                        className="float-right text-red-500 hover:text-red-700"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            )}

                            {!isPaidUser && (
                                <div className="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white rounded-lg p-6 mb-8 shadow-lg">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className="text-4xl">üöÄ</div>
                                            <div>
                                                <h3 className="text-xl font-black">UPGRADE TO PREMIUM - TO THE MOON! üåï</h3>
                                                <p className="text-yellow-100">
                                                    You're on the FREE tier with limited access. Upgrade to get:
                                                </p>
                                                <ul className="text-sm text-yellow-100 mt-2 space-y-1">
                                                    <li>‚Ä¢ Unlimited live alerts & bot signals</li>
                                                    <li>‚Ä¢ Real-time market data & PnL tracking</li>
                                                    <li>‚Ä¢ Full chat participation & history</li>
                                                    <li>‚Ä¢ Priority customer support</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => navigateToPage('subscription')}
                                            className="bg-white text-orange-600 px-6 py-3 rounded-lg font-black hover:bg-gray-100 transition-colors shadow-lg"
                                        >
                                            üíé UPGRADE NOW
                                        </button>
                                    </div>
                                </div>
                            )}

                            {user.isAdmin && showAdminPanel && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
                                    <h3 className="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                                        ‚öôÔ∏è Admin Panel - Create Alert
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Alert Type</label>
                                            <select
                                                value={newAlert.type}
                                                onChange={(e) => setNewAlert({...newAlert, type: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="NEWS">News Alert</option>
                                                <option value="BOT_SIGNAL">Bot Signal</option>
                                                <option value="MARKET_UPDATE">Market Update</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                            <select
                                                value={newAlert.priority}
                                                onChange={(e) => setNewAlert({...newAlert, priority: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="LOW">Low</option>
                                                <option value="MEDIUM">Medium</option>
                                                <option value="HIGH">High</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                            <input
                                                type="text"
                                                value={newAlert.title}
                                                onChange={(e) => setNewAlert({...newAlert, title: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                placeholder="Alert title"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Message</label>
                                            <textarea
                                                value={newAlert.message}
                                                onChange={(e) => setNewAlert({...newAlert, message: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                rows="3"
                                                placeholder="Alert message"
                                            />
                                        </div>
                                        <button
                                            onClick={handleCreateAlert}
                                            disabled={loading}
                                            className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2 disabled:opacity-50"
                                        >
                                            ‚ûï {loading ? 'Creating...' : 'Create Alert'}
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                                <div className="lg:col-span-3 space-y-6">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-2xl font-bold text-gray-900">Live Alerts</h2>
                                        <div className="flex gap-2">
                                            {['ALL', 'BOT_SIGNAL', 'NEWS', 'MARKET_UPDATE'].map((type, index) => (
                                                <button
                                                    key={`filter-${type}-${index}`}
                                                    onClick={() => {
                                                        debugLog(`Filter changed to: ${type}`);
                                                        setFilterType(type);
                                                    }}
                                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                                                        filterType === type 
                                                            ? 'bg-blue-500 text-white' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    {type === 'BOT_SIGNAL' ? 'Bot Signals' : 
                                                     type === 'NEWS' ? 'News' : 
                                                     type === 'MARKET_UPDATE' ? 'Market' : 'All'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        {limitedAlerts.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                No alerts found. {user.isAdmin && 'Create one using the admin panel above!'}
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {limitedAlerts.map((alert, alertIndex) => (
                                                    <div key={alert._id || `alert-${alertIndex}`} className={`bg-white rounded-lg shadow-sm border-l-4 p-6 ${
                                                        alert.priority === 'HIGH' ? 'border-red-500' :
                                                        alert.priority === 'MEDIUM' ? 'border-yellow-500' : 'border-gray-300'
                                                    }`}>
                                                        <div className="flex items-start justify-between">
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-3 mb-2">
                                                                    <span className="text-xl">
                                                                        {alert.type === 'BOT_SIGNAL' ? 'ü§ñ' : 
                                                                         alert.type === 'MARKET_UPDATE' ? 'üìä' : 'üîî'}
                                                                    </span>
                                                                    <div>
                                                                        <h3 className="font-bold text-gray-900">{alert.title}</h3>
                                                                        {alert.botName && (
                                                                            <p className="text-sm text-blue-600 font-medium">{alert.botName}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                
                                                                <p className="text-gray-700 mb-3">{alert.message}</p>
                                                                
                                                                {alert.pnl && (
                                                                    <div className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${
                                                                        alert.pnl.includes('+') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                                    }`}>
                                                                        {alert.pnl.includes('+') ? 'üìà' : 'üìâ'}
                                                                        {alert.pnl}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            <div className="text-right ml-4">
                                                                <div className="flex items-center gap-2">
                                                                    <span>üïê</span>
                                                                    <span className="text-sm text-gray-500">{formatTimeAgo(alert.createdAt)}</span>
                                                                    {user.isAdmin && (
                                                                        <button
                                                                            onClick={() => handleDeleteAlert(alert._id)}
                                                                            className="p-1 text-red-400 hover:text-red-600"
                                                                        >
                                                                            üóëÔ∏è
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                {!isPaidUser && filteredAlerts.length > 3 && (
                                                    <div className="relative">
                                                        <div className="filter blur-sm pointer-events-none">
                                                            {filteredAlerts.slice(3, 6).map((alert, previewIndex) => (
                                                                <div key={`preview-${alert._id || `preview-alert-${previewIndex}`}`} className="bg-white rounded-lg shadow-sm border-l-4 border-gray-300 p-6 mb-4">
                                                                    <div className="flex items-start justify-between">
                                                                        <div className="flex-1">
                                                                            <div className="flex items-center gap-3 mb-2">
                                                                                <span className="text-xl">üîî</span>
                                                                                <h3 className="font-bold text-gray-900">{alert.title}</h3>
                                                                            </div>
                                                                            <p className="text-gray-700">{alert.message}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        
                                                        <div className="absolute inset-0 bg-gradient-to-t from-white via-white/95 to-white/50 flex items-center justify-center">
                                                            <div className="text-center bg-white p-8 rounded-lg shadow-xl border border-orange-200">
                                                                <div className="text-4xl mb-4">üîí</div>
                                                                <h3 className="text-xl font-bold text-gray-900 mb-2">Premium Content</h3>
                                                                <p className="text-gray-600 mb-4">Upgrade to see all {filteredAlerts.length} live alerts</p>
                                                                <button 
                                                                    onClick={() => navigateToPage('subscription')}
                                                                    className="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-3 rounded-lg font-bold hover:from-orange-600 hover:to-red-600 transition-all"
                                                                >
                                                                    üöÄ UPGRADE NOW
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="lg:col-span-1">
                                    <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            üë• Active Users ({members.length})
                                        </h3>
                                        
                                        <div className="space-y-3">
                                            {(isPaidUser ? members : members.slice(0, 3)).map((member, memberIndex) => (
                                                <div key={member.id || `member-${memberIndex}`} className="flex items-center gap-3">
                                                    <div className="relative">
                                                        <img src={member.avatar} alt="" className="w-10 h-10 rounded-full" />
                                                        <div className={`absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white ${
                                                            member.status === 'online' ? 'bg-green-500' :
                                                            member.status === 'away' ? 'bg-yellow-500' : 'bg-gray-400'
                                                        }`}></div>
                                                    </div>
                                                    <div className="flex-1">
                                                        <p className="font-medium text-gray-900 text-sm">{member.username}</p>
                                                        <span className={`text-xs px-2 py-0.5 rounded ${
                                                            member.tier === 'MONTHLY' ? 'bg-green-100 text-green-800' :
                                                            member.tier === 'WEEKLY' ? 'bg-blue-100 text-blue-800' :
                                                            member.tier === 'ADMIN' ? 'bg-red-100 text-red-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {member.tier}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            {!isPaidUser && members.length > 3 && (
                                                <div className="text-center py-3 text-sm text-gray-500 border-t">
                                                    <p>+{members.length - 3} more members</p>
                                                    <p className="text-xs text-orange-600 font-medium cursor-pointer" onClick={() => navigateToPage('subscription')}>
                                                        Upgrade to see all
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg shadow-sm p-6 relative">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            üìà Live Markets
                                            {!isPaidUser && <span className="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded">LIMITED</span>}
                                        </h3>
                                        
                                        {isPaidUser ? (
                                            <div className="space-y-3">
                                                {Object.entries(marketData).map(([symbol, data], marketIndex) => (
                                                    <div key={symbol || `market-${marketIndex}`} className="flex justify-between items-center">
                                                        <span className="font-medium text-gray-900">{symbol}</span>
                                                        <div className="text-right">
                                                            <div className="font-bold text-gray-900">
                                                                ${data.price.toFixed(2)}
                                                            </div>
                                                            <div className={`text-xs ${
                                                                data.changePercent >= 0 ? 'text-green-600' : 'text-red-600'
                                                            }`}>
                                                                {data.changePercent >= 0 ? '+' : ''}{data.changePercent.toFixed(2)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center py-8">
                                                <div className="text-4xl mb-3">üîí</div>
                                                <p className="text-gray-600 mb-3">Real-time market data</p>
                                                <p className="text-sm text-gray-500 mb-4">Live prices, trends & signals</p>
                                                <button 
                                                    onClick={() => navigateToPage('subscription')}
                                                    className="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-orange-600"
                                                >
                                                    Unlock Premium
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <ChatPanel />
                    </div>
                );
            };

            // Enhanced auth check with single execution guard
            useEffect(() => {
                debugLog('useEffect: Auth check triggered', { authCheckCompleted });
                
                if (authCheckCompleted) {
                    debugLog('AUTH: Skipping - already completed', null, 'WARN');
                    return;
                }
                
                authCheckCompleted = true;
                startPerformanceTimer('auth-check');
                
                const token = localStorage.getItem('authToken');
                debugLog('AUTH: Starting check', { hasToken: !!token });
                
                if (token) {
                    apiCall('/auth/profile')
                        .then(response => {
                            endPerformanceTimer('auth-check');
                            const userData = response.user || response;
                            debugLog('AUTH: Token valid', { 
                                username: userData.username,
                                tier: userData.tier,
                                isAdmin: userData.isAdmin
                            }, 'SUCCESS');
                            
                            setUser(userData);
                            
                            // Check current URL to determine where to redirect
                            const currentPath = window.location.pathname;
                            debugLog('AUTH: Determining redirect based on URL', { currentPath });
                            
                            if (currentPath === '/subscription' || requiresSubscriptionSelection(userData)) {
                                debugLog('AUTH: Redirecting to subscription picker');
                                navigateToPage('subscription');
                            } else if (currentPath === '/dashboard') {
                                debugLog('AUTH: Staying on dashboard');
                                navigateToPage('dashboard');
                            } else {
                                // Default redirect based on subscription status
                                if (requiresSubscriptionSelection(userData)) {
                                    navigateToPage('subscription');
                                } else {
                                    navigateToPage('dashboard');
                                }
                            }
                        })
                        .catch((error) => {
                            endPerformanceTimer('auth-check');
                            trackError(error, 'Auth Token Validation');
                            localStorage.removeItem('authToken');
                            authCheckCompleted = false;
                            navigateToPage('landing');
                        });
                } else {
                    endPerformanceTimer('auth-check');
                    debugLog('AUTH: No token found - staying on landing');
                    navigateToPage('landing');
                }
            }, []);

            debugLog('Component completed render', { 
                showLanding, 
                showSubscriptionPicker, 
                userLoggedIn: !!user 
            });

            if (showLanding) {
                return <LandingPage />;
            }

            if (showSubscriptionPicker) {
                return <SubscriptionPicker />;
            }

            return <Dashboard />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingGroupDashboard />);
    </script>
</body>
</html>
