<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTi Backend Diagnostic Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .console-output {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .loading-dots {
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0%, 60%, 100% { transform: initial; }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        üîß RTi Backend Diagnostic Tool
                    </h1>
                    <p class="text-gray-600 mt-2">Debug authentication and backend connectivity issues</p>
                </div>
                <div id="backendStatus" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-500 text-white">
                    Backend: Checking...
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Control Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    üéÆ Control Panel
                </h2>

                <!-- Quick Actions -->
                <div class="space-y-4">
                    <button 
                        id="runFullDiagnostic" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors"
                    >
                        üöÄ Run Full Backend Diagnostic
                    </button>

                    <button 
                        id="testBackendOnly" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium transition-colors"
                    >
                        üì° Test Backend Connection Only
                    </button>

                    <button 
                        id="clearResults" 
                        class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium transition-colors"
                    >
                        üßπ Clear Results
                    </button>
                </div>

                <!-- Manual Login Test -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">üîê Manual Login Test</h3>
                    <div class="space-y-3">
                        <input 
                            type="text" 
                            id="testUsername" 
                            placeholder="Username or Email" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input 
                            type="password" 
                            id="testPassword" 
                            placeholder="Password" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button 
                            id="testManualLogin" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium transition-colors"
                        >
                            üîì Test These Credentials
                        </button>
                    </div>
                </div>

                <!-- Quick Fill Buttons -->
                <div class="mt-4 space-y-2">
                    <p class="text-sm text-gray-600 font-medium">Quick Fill:</p>
                    <div class="grid grid-cols-1 gap-2">
                        <button id="fillAdmin" class="text-left px-3 py-2 bg-red-50 hover:bg-red-100 border border-red-200 rounded text-sm text-red-700 transition-colors">
                            üëë Admin: admin / admin123
                        </button>
                        <button id="fillTestUser" class="text-left px-3 py-2 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded text-sm text-blue-700 transition-colors">
                            üß™ Test User: testuser / test123
                        </button>
                        <button id="fillYourEmail" class="text-left px-3 py-2 bg-green-50 hover:bg-green-100 border border-green-200 rounded text-sm text-green-700 transition-colors">
                            üìß Your Email: CashFlowmc@outlook.com
                        </button>
                    </div>
                </div>

                <!-- Backend Info -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">üîó Backend Information</h3>
                    <div class="text-xs text-gray-600 space-y-1">
                        <p><strong>URL:</strong> <span class="font-mono bg-gray-100 px-1 rounded">https://rti-trading-backend-production.up.railway.app/api</span></p>
                        <p><strong>Test Endpoint:</strong> /test</p>
                        <p><strong>Login Endpoint:</strong> /auth/login</p>
                        <p><strong>Register Endpoint:</strong> /auth/register</p>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    üìã Diagnostic Results
                </h2>
                
                <div id="resultsContainer" class="h-96 overflow-y-auto bg-gray-50 rounded-lg p-4 border">
                    <div class="text-gray-500 italic text-center">
                        No diagnostics run yet. Click "Run Full Backend Diagnostic" to start testing.
                    </div>
                </div>

                <div class="mt-4 text-xs text-gray-500">
                    üí° Tip: Results are also logged to browser console (F12)
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summarySection" class="mt-6 bg-white rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Summary & Recommendations</h2>
            <div id="summaryContent" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://rti-trading-backend-production.up.railway.app/api';
        
        // State
        let diagnosticResults = [];
        let backendStatus = 'unknown';
        
        // DOM Elements
        const backendStatusEl = document.getElementById('backendStatus');
        const resultsContainer = document.getElementById('resultsContainer');
        const summarySection = document.getElementById('summarySection');
        const summaryContent = document.getElementById('summaryContent');

        // Utility Functions
        function addResult(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const result = { timestamp, message, type, data, id: Date.now() };
            diagnosticResults.push(result);
            
            // Log to console
            console.log(`[RTi Diagnostic] ${timestamp} - ${type.toUpperCase()}: ${message}`, data || '');
            
            // Update UI
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            if (diagnosticResults.length === 0) {
                resultsContainer.innerHTML = '<div class="text-gray-500 italic text-center">No diagnostics run yet.</div>';
                return;
            }

            const html = diagnosticResults.map(result => {
                const typeColors = {
                    success: 'bg-green-50 border-green-200 text-green-800',
                    error: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                    info: 'bg-blue-50 border-blue-200 text-blue-800'
                };

                const typeIcons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };

                return `
                    <div class="mb-3 p-3 rounded-lg border ${typeColors[result.type] || typeColors.info}">
                        <div class="font-medium console-output">
                            ${typeIcons[result.type] || '‚ÑπÔ∏è'} [${result.timestamp}] ${result.message}
                        </div>
                        ${result.data ? `
                            <details class="mt-2">
                                <summary class="cursor-pointer text-xs opacity-75 hover:opacity-100">Show Details</summary>
                                <pre class="mt-2 text-xs opacity-75 overflow-x-auto bg-black/10 p-2 rounded">${JSON.stringify(result.data, null, 2)}</pre>
                            </details>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            resultsContainer.innerHTML = html;
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }

        function updateBackendStatus(status) {
            backendStatus = status;
            const statusColors = {
                online: 'bg-green-500 text-white',
                offline: 'bg-red-500 text-white',
                error: 'bg-red-500 text-white',
                unknown: 'bg-gray-500 text-white'
            };
            
            backendStatusEl.className = `px-4 py-2 rounded-full text-sm font-medium ${statusColors[status]}`;
            backendStatusEl.textContent = `Backend: ${status}`;
        }

        // Test Functions
        async function testBackendConnection() {
            addResult('üì° Testing backend connection...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`);
                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Backend is online and responding!', 'success', data);
                    updateBackendStatus('online');
                    return true;
                } else {
                    addResult('‚ùå Backend responded with error', 'error', { status: response.status, data });
                    updateBackendStatus('error');
                    return false;
                }
            } catch (error) {
                addResult('‚ùå Backend connection failed', 'error', error.message);
                updateBackendStatus('offline');
                return false;
            }
        }

        async function testUserLogin(username, password, userType = 'user') {
            addResult(`üîê Testing ${userType} login: ${username}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult(`‚úÖ ${userType} login successful!`, 'success', {
                        username: data.user.username,
                        tier: data.user.tier,
                        isAdmin: data.user.isAdmin,
                        hasToken: !!data.token
                    });
                    return true;
                } else {
                    addResult(`‚ùå ${userType} login failed`, 'error', {
                        error: data.error,
                        status: response.status,
                        attempted: { username, passwordLength: password.length }
                    });
                    return false;
                }
            } catch (error) {
                addResult(`‚ùå ${userType} login request failed`, 'error', error.message);
                return false;
            }
        }

        async function testUserRegistration() {
            addResult('üìù Testing user registration...', 'info');
            
            const testUser = {
                username: `testuser_${Date.now()}`,
                email: `test_${Date.now()}@example.com`,
                password: 'test123'
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ User registration works!', 'success', {
                        username: data.user.username,
                        email: data.user.email,
                        tier: data.user.tier
                    });
                    return true;
                } else {
                    addResult('‚ùå User registration failed', 'error', {
                        error: data.error,
                        status: response.status
                    });
                    return false;
                }
            } catch (error) {
                addResult('‚ùå Registration request failed', 'error', error.message);
                return false;
            }
        }

        async function runFullDiagnostic() {
            // Show loading
            const button = document.getElementById('runFullDiagnostic');
            const originalText = button.textContent;
            button.textContent = 'üîÑ Running Diagnostic...';
            button.disabled = true;
            
            // Clear previous results
            diagnosticResults = [];
            updateResultsDisplay();
            summarySection.classList.add('hidden');
            
            addResult('üöÄ Starting comprehensive backend diagnostic...', 'info');
            
            const results = {
                backendOnline: false,
                adminExists: false,
                testUserExists: false,
                registrationWorks: false
            };

            try {
                // Test 1: Backend Connection
                results.backendOnline = await testBackendConnection();
                
                if (!results.backendOnline) {
                    addResult('üõë Stopping diagnostic - backend is offline', 'error');
                    showSummary(results);
                    return;
                }

                // Test 2: Admin User
                results.adminExists = await testUserLogin('admin', 'admin123', 'Admin');

                // Test 3: Test User
                results.testUserExists = await testUserLogin('testuser', 'test123', 'Test User');

                // Test 4: User Registration
                results.registrationWorks = await testUserRegistration();

                // Test 5: CORS Check
                addResult('üåê Testing CORS and headers...', 'info');
                try {
                    const corsResponse = await fetch(`${API_BASE_URL}/test`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Test-Header': 'diagnostic-test'
                        }
                    });
                    
                    if (corsResponse.ok) {
                        addResult('‚úÖ CORS working correctly', 'success');
                    } else {
                        addResult('‚ö†Ô∏è CORS may have issues', 'warning', { status: corsResponse.status });
                    }
                } catch (error) {
                    addResult('‚ùå CORS test failed', 'error', error.message);
                }

                addResult('üèÅ Full diagnostic complete!', 'success');
                showSummary(results);

            } catch (error) {
                addResult('üí• Diagnostic crashed with error', 'error', error.message);
            } finally {
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function showSummary(results) {
            const recommendations = [];
            
            if (!results.backendOnline) {
                recommendations.push({
                    type: 'error',
                    title: 'Backend is Offline',
                    message: 'Your backend server is not responding. Check if Railway deployment is running.',
                    action: 'Visit Railway dashboard and ensure your backend is deployed and running.'
                });
            } else if (!results.adminExists && !results.testUserExists) {
                recommendations.push({
                    type: 'error',
                    title: 'No Default Users Found',
                    message: 'Neither admin nor test users exist in the database.',
                    action: 'Your backend may not have initialized properly. Check server logs for user creation errors.'
                });
            } else if (!results.adminExists) {
                recommendations.push({
                    type: 'warning',
                    title: 'Admin User Missing',
                    message: 'Admin user (admin/admin123) does not exist.',
                    action: 'Check backend initialization code or create admin manually.'
                });
            } else if (!results.testUserExists) {
                recommendations.push({
                    type: 'warning',
                    title: 'Test User Missing',
                    message: 'Test user (testuser/test123) does not exist.',
                    action: 'This user may not have been created. Try registering manually.'
                });
            }

            if (results.backendOnline && (results.adminExists || results.testUserExists)) {
                recommendations.push({
                    type: 'success',
                    title: 'Backend is Working',
                    message: 'Your backend is online and at least some users exist.',
                    action: 'Try logging into your main app with working credentials.'
                });
            }

            if (!results.registrationWorks && results.backendOnline) {
                recommendations.push({
                    type: 'warning',
                    title: 'Registration Issues',
                    message: 'User registration is not working properly.',
                    action: 'Check backend registration endpoint and database connection.'
                });
            }

            // Show summary
            summaryContent.innerHTML = recommendations.map(rec => {
                const colors = {
                    success: 'bg-green-50 border-green-200 text-green-800',
                    error: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-yellow-50 border-yellow-200 text-yellow-800'
                };
                
                return `
                    <div class="p-4 rounded-lg border ${colors[rec.type]}">
                        <h3 class="font-semibold mb-2">${rec.title}</h3>
                        <p class="mb-2">${rec.message}</p>
                        <p class="text-sm font-medium">‚Üí ${rec.action}</p>
                    </div>
                `;
            }).join('');
            
            summarySection.classList.remove('hidden');
        }

        // Event Listeners
        document.getElementById('runFullDiagnostic').addEventListener('click', runFullDiagnostic);
        
        document.getElementById('testBackendOnly').addEventListener('click', async () => {
            diagnosticResults = [];
            updateResultsDisplay();
            await testBackendConnection();
        });

        document.getElementById('clearResults').addEventListener('click', () => {
            diagnosticResults = [];
            updateResultsDisplay();
            summarySection.classList.add('hidden');
        });

        document.getElementById('testManualLogin').addEventListener('click', async () => {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            if (!username || !password) {
                addResult('‚ö†Ô∏è Please enter both username and password', 'warning');
                return;
            }
            
            await testUserLogin(username, password, 'Manual');
        });

        // Quick fill buttons
        document.getElementById('fillAdmin').addEventListener('click', () => {
            document.getElementById('testUsername').value = 'admin';
            document.getElementById('testPassword').value = 'admin123';
        });

        document.getElementById('fillTestUser').addEventListener('click', () => {
            document.getElementById('testUsername').value = 'testuser';
            document.getElementById('testPassword').value = 'test123';
        });

        document.getElementById('fillYourEmail').addEventListener('click', () => {
            document.getElementById('testUsername').value = 'CashFlowmc@outlook.com';
            document.getElementById('testPassword').value = '';
            document.getElementById('testPassword').focus();
        });

        // Auto-run basic connectivity test on load
        window.addEventListener('load', () => {
            setTimeout(testBackendConnection, 500);
        });

        console.log('üîß RTi Backend Diagnostic Tool Loaded');
        console.log('Available functions: testBackendConnection(), runFullDiagnostic()');
    </script>
</body>
</html>
