<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTi Cashflowops - Trading Group Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes rocketLaunch {
            0% { transform: translateX(0px) translateY(0px) scale(1) rotate(0deg); opacity: 1; }
            25% { transform: translateX(25vw) translateY(-100px) scale(1.2) rotate(15deg); opacity: 1; }
            50% { transform: translateX(50vw) translateY(-200px) scale(1.4) rotate(30deg); opacity: 1; }
            75% { transform: translateX(75vw) translateY(-350px) scale(1.2) rotate(45deg); opacity: 0.8; }
            100% { transform: translateX(calc(100vw - 100px)) translateY(-500px) scale(0.8) rotate(60deg); opacity: 0.3; }
        }

        @keyframes dollarAcrossToMoon {
            0% { transform: translateX(0px) translateY(0px) scale(1) rotate(0deg); opacity: 1; }
            25% { transform: translateX(25vw) translateY(-30px) scale(1.1) rotate(15deg); opacity: 1; }
            50% { transform: translateX(50vw) translateY(-80px) scale(1.2) rotate(30deg); opacity: 1; }
            75% { transform: translateX(75vw) translateY(-140px) scale(1.1) rotate(45deg); opacity: 1; }
            100% { transform: translateX(calc(50vw - 50px)) translateY(-200px) scale(0.8) rotate(60deg); opacity: 0.9; }
        }
        
        @keyframes messageAppear {
            0%, 85% { opacity: 0; transform: translateY(20px); }
            90% { opacity: 1; transform: translateY(0px); }
            100% { opacity: 1; transform: translateY(0px); }
        }
        
        @keyframes moneyFall {
            0% { transform: translateY(-80px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(calc(100vh + 80px)) rotate(180deg); opacity: 0.8; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInFromRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .chat-message-enter {
            animation: slideIn 0.3s ease-out;
        }

        .user-item-enter {
            animation: slideInFromRight 0.2s ease-out;
        }
        
        .money-rain {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;
        }
        
        .falling-money {
            position: absolute; width: 40px; height: 17px;
            background: linear-gradient(135deg, #2d5016 0%, #3d6b1c 25%, #4a7c22 50%, #5a8c28 75%, #6ba02e 100%);
            border: 1px solid #1a3d0a; border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
            animation: moneyFall 4s ease-in infinite; position: relative;
        }
        
        .falling-money::before {
            content: '$1'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #1a3d0a; font-size: 10px; font-weight: bold; font-family: serif;
        }
        
        .falling-money::after {
            content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
            border: 1px solid rgba(26, 61, 10, 0.3); border-radius: 1px;
        }
        
        .plan-glow {
            animation: pulse 2s infinite;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
        }

        .chat-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }

        .chat-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .chat-scrollbar::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 3px;
        }

        .chat-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .chat-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .chat-tab-active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .chat-tab-inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        .user-online-indicator {
            animation: pulse 2s infinite;
        }

        .photo-upload-hover:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .avatar-preview {
            transition: all 0.3s ease;
        }

        .upload-progress {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            animation: slideRight 2s ease-in-out infinite;
        }

        @keyframes slideRight {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0%); }
            100% { transform: translateX(100%); }
        }

        /* Debug Panel Styles */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .proxy-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .proxy-status.online {
            background: #00ff00;
            animation: pulse 2s infinite;
        }

        .proxy-status.offline {
            background: #ff0000;
        }

        /* üöÄ ROCKET SHIP STYLES */
        .rocket-ship {
            font-size: 4rem;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: inline-block;
            filter: drop-shadow(0 0 20px rgba(255, 255, 0, 0.6));
        }

        .rocket-ship:hover {
            transform: scale(1.2) rotate(10deg);
        }

        .rocket-launching {
            animation: rocketLaunch 3s ease-out forwards;
        }

        .rocket-flames {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: flicker 0.2s infinite alternate;
        }

        @keyframes flicker {
            0% { opacity: 0.8; transform: translateX(-50%) scale(1); }
            100% { opacity: 1; transform: translateX(-50%) scale(1.2); }
        }

        .moon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 3rem;
            animation: moonGlow 2s ease-in-out infinite alternate;
        }

        @keyframes moonGlow {
            0% { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5)); }
            100% { filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.9)); }
        }

        .launch-trail {
            position: absolute;
            width: 4px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 0, 1), 
                rgba(255, 165, 0, 0.8), 
                rgba(255, 69, 0, 0.6),
                transparent);
            border-radius: 2px;
            opacity: 0;
        }

        .trail-active {
            opacity: 1;
            animation: trailFade 2s ease-out forwards;
        }

        @keyframes trailFade {
            0% { height: 0; }
            50% { height: 200px; }
            100% { height: 400px; opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // üõ°Ô∏è BULLETPROOF Configuration - PHP Proxy Only!
        const PROXY_BASE_URL = 'api_proxy.php'; // Always use PHP proxy
        
        // Global debug state
        let debugLogs = [];
        
        const debugLog = (message, data = null) => {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(`üêõ [RTi DEBUG] ${message}`);
            if (data) console.log('üìä Data:', data);
            
            debugLogs.unshift({ timestamp, message, data });
            if (debugLogs.length > 50) debugLogs.pop(); // Keep last 50 logs
            
            // Update debug panel
            window.updateDebugPanel && window.updateDebugPanel();
        };

        // üõ°Ô∏è Bulletproof Array Validator
        const ensureArray = (data, fallback = []) => {
            if (Array.isArray(data)) return data;
            debugLog(`‚ö†Ô∏è Data is not array, got: ${typeof data}`, data);
            return fallback;
        };

        // üõ°Ô∏è Bulletproof API Call Function - PHP Proxy Only
        const apiCall = async (endpoint, options = {}) => {
            const token = localStorage.getItem('token');
            
            debugLog(`üîÑ API Call via PHP Proxy: ${endpoint}`, { options, hasToken: !!token });

            try {
                // Build form data for PHP proxy
                const formData = new FormData();
                formData.append('endpoint', endpoint);
                formData.append('method', options.method || 'GET');
                
                if (options.body) {
                    formData.append('data', options.body);
                }
                
                if (token) {
                    formData.append('token', token);
                }

                const response = await fetch(PROXY_BASE_URL, {
                    method: 'POST',
                    body: formData
                });

                debugLog(`üì° Proxy Response: ${endpoint}`, { 
                    status: response.status, 
                    ok: response.ok 
                });

                if (!response.ok) {
                    throw new Error(`Proxy error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                debugLog(`‚úÖ Proxy Success: ${endpoint}`, result);
                return result;

            } catch (error) {
                debugLog(`‚ùå Proxy Error: ${endpoint}`, error.message);
                throw error;
            }
        };

        // üöÄ Rocket Ship Component
        const RocketShip = ({ onLaunch }) => {
            const [isLaunching, setIsLaunching] = useState(false);
            const [showTrail, setShowTrail] = useState(false);
            const rocketRef = useRef(null);

            const launchRocket = () => {
                if (isLaunching) return;
                
                setIsLaunching(true);
                setShowTrail(true);
                
                // Add flame effects
                if (rocketRef.current) {
                    const flames = document.createElement('div');
                    flames.className = 'rocket-flames';
                    flames.innerHTML = 'üî•üí®';
                    rocketRef.current.appendChild(flames);
                    
                    // Remove flames after animation
                    setTimeout(() => {
                        flames.remove();
                    }, 3000);
                }
                
                // Call parent launch handler
                onLaunch && onLaunch();
                
                // Reset after animation
                setTimeout(() => {
                    setIsLaunching(false);
                    setShowTrail(false);
                }, 3000);
            };

            return (
                <div className="relative inline-block">
                    <div 
                        ref={rocketRef}
                        className={`rocket-ship ${isLaunching ? 'rocket-launching' : ''}`}
                        onClick={launchRocket}
                        title="üöÄ Click to launch to the moon!"
                    >
                        üöÄ
                    </div>
                    {showTrail && (
                        <div 
                            className="launch-trail trail-active"
                            style={{
                                bottom: '-50px',
                                left: '50%',
                                transform: 'translateX(-50%)'
                            }}
                        />
                    )}
                </div>
            );
        };

        // üõ°Ô∏è Debug Panel Component
        const DebugPanel = ({ isVisible, onToggle }) => {
            if (!isVisible) {
                return (
                    <div className="fixed top-4 right-4 z-50">
                        <button
                            onClick={onToggle}
                            className="bg-black text-green-400 px-3 py-1 rounded text-xs font-mono"
                        >
                            üêõ Debug
                        </button>
                    </div>
                );
            }

            return (
                <div className="debug-panel">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-yellow-400 font-bold">üõ°Ô∏è RTi Debug Panel</span>
                        <button onClick={onToggle} className="text-red-400">‚úï</button>
                    </div>
                    
                    <div className="mb-2">
                        <span className="proxy-status online"></span>
                        <span className="text-green-400">PHP Proxy Active</span>
                    </div>
                    
                    <div className="text-xs space-y-1 max-h-32 overflow-y-auto">
                        {debugLogs.slice(0, 10).map((log, idx) => (
                            <div key={idx} className="text-gray-300">
                                <span className="text-blue-400">[{log.timestamp}]</span> {log.message}
                            </div>
                        ))}
                    </div>
                    
                    <div className="mt-2 text-xs">
                        <button 
                            onClick={() => window.testProxyConnection && window.testProxyConnection()}
                            className="bg-blue-600 text-white px-2 py-1 rounded mr-1"
                        >
                            Test Proxy
                        </button>
                        <button 
                            onClick={() => debugLogs = []}
                            className="bg-red-600 text-white px-2 py-1 rounded"
                        >
                            Clear
                        </button>
                    </div>
                </div>
            );
        };

        const TradingGroupDashboard = () => {
            const [user, setUser] = useState(null);
            const [showLanding, setShowLanding] = useState(true);
            const [showSubscriptionPicker, setShowSubscriptionPicker] = useState(false);
            const [alerts, setAlerts] = useState([]);
            const [members, setMembers] = useState([]);
            const [marketData, setMarketData] = useState({});
            const [filterType, setFilterType] = useState('ALL');
            const [newAlert, setNewAlert] = useState({ title: '', message: '', priority: 'MEDIUM', type: 'NEWS' });
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Enhanced Chat state
            const [chatMessages, setChatMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [chatExpanded, setChatExpanded] = useState(false);
            const [unreadMessages, setUnreadMessages] = useState(0);
            const [activeTab, setActiveTab] = useState('chat'); // 'chat' or 'users'
            const chatMessagesRef = useRef(null);

            // User status and DM state
            const [userStatus, setUserStatus] = useState('online');
            const [directMessages, setDirectMessages] = useState({});
            const [activeDMUser, setActiveDMUser] = useState(null);
            const [dmUnreadCounts, setDmUnreadCounts] = useState({});

            // Profile state
            const [showProfile, setShowProfile] = useState(null);
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [userProfiles, setUserProfiles] = useState({});
            const [profileForm, setProfileForm] = useState({
                bio: '',
                tradingExperience: 'Beginner',
                favoriteMarkets: [],
                achievements: [],
                socialLinks: {
                    twitter: '',
                    discord: '',
                    telegram: ''
                },
                isPublic: true,
                tradingStats: {
                    winRate: 0,
                    totalTrades: 0,
                    favoriteStrategy: ''
                }
            });

            // Photo upload state
            const [isUploadingPhoto, setIsUploadingPhoto] = useState(false);
            const [photoPreview, setPhotoPreview] = useState(null);
            const fileInputRef = useRef(null);
            
            // üõ°Ô∏è Debug Panel State
            const [showDebugPanel, setShowDebugPanel] = useState(false);

            // üöÄ Rocket launch state
            const [rocketLaunched, setRocketLaunched] = useState(false);

            // üõ°Ô∏è Test Functions for Console
            useEffect(() => {
                window.testProxyConnection = async () => {
                    debugLog('üß™ Testing PHP Proxy Connection...');
                    try {
                        await apiCall('/auth/profile');
                        debugLog('‚úÖ Proxy test successful!');
                    } catch (err) {
                        debugLog('‚ùå Proxy test failed:', err.message);
                    }
                };

                window.checkArrays = () => {
                    debugLog('üîç Array Status Check:');
                    debugLog(`- alerts: ${Array.isArray(alerts)} (length: ${alerts.length})`);
                    debugLog(`- members: ${Array.isArray(members)} (length: ${members.length})`);
                    debugLog(`- chatMessages: ${Array.isArray(chatMessages)} (length: ${chatMessages.length})`);
                };

                window.forceRefresh = () => {
                    debugLog('üîÑ Force refreshing all data...');
                    if (user && !showSubscriptionPicker) {
                        fetchAlerts();
                        fetchActiveUsers();
                    }
                };

                window.launchRocket = () => {
                    debugLog('üöÄ Manual rocket launch triggered!');
                    setRocketLaunched(true);
                    setTimeout(() => setRocketLaunched(false), 3000);
                };

                debugLog('üõ°Ô∏è Bulletproof React Dashboard initialized with PHP Proxy & Rocket Ship üöÄ');
            }, []);

            // üõ°Ô∏è Bulletproof polling instead of Socket.IO
            useEffect(() => {
                let pollInterval;
                
                if (user && !showSubscriptionPicker) {
                    debugLog('üîÑ Starting bulletproof polling (no Socket.IO)');
                    
                    pollInterval = setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            fetchAlerts();
                            fetchActiveUsers();
                        }
                    }, 5000); // Poll every 5 seconds when tab is visible
                }

                return () => {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        debugLog('üõë Stopped polling');
                    }
                };
            }, [user, showSubscriptionPicker]);

            // Auto-scroll chat to bottom
            useEffect(() => {
                if (chatMessagesRef.current) {
                    chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                }
            }, [chatMessages]);

            // Clear unread messages when appropriate
            useEffect(() => {
                if (chatExpanded && activeTab === 'chat' && !activeDMUser) {
                    setUnreadMessages(0);
                }
                if (activeDMUser && chatExpanded) {
                    setDmUnreadCounts(prev => ({
                        ...prev,
                        [activeDMUser]: 0
                    }));
                }
            }, [chatExpanded, activeDMUser, activeTab]);

            // Check if user requires subscription selection
            const requiresSubscriptionSelection = (user) => {
                if (!user) return false;
                if (user.isAdmin) return false;
                
                const hasNeverSubscribed = !user.subscriptionId && 
                                          !user.subscriptionStatus && 
                                          user.tier === 'FREE';
                
                debugLog('Subscription check:', {
                    tier: user.tier,
                    hasSubscriptionId: !!user.subscriptionId,
                    hasSubscriptionStatus: !!user.subscriptionStatus,
                    requiresSelection: hasNeverSubscribed
                });
                
                return hasNeverSubscribed;
            };

            // üõ°Ô∏è Bulletproof fetch alerts with array protection
            const fetchAlerts = async () => {
                try {
                    debugLog('üîç Fetching alerts via proxy...');
                    const data = await apiCall(`/alerts?type=${filterType}`);
                    
                    // üõ°Ô∏è Ensure data is always an array
                    const safeAlerts = ensureArray(data, []);
                    setAlerts(safeAlerts);
                    
                    debugLog(`‚úÖ Alerts loaded: ${safeAlerts.length} items`);
                } catch (err) {
                    debugLog('‚ùå Failed to fetch alerts:', err.message);
                    setError('Failed to fetch alerts: ' + err.message);
                    
                    // üõ°Ô∏è Ensure alerts stays as array even on error
                    setAlerts(ensureArray([]));
                }
            };

            // üõ°Ô∏è Bulletproof fetch users with array protection
            const fetchActiveUsers = async () => {
                try {
                    debugLog('üîç Fetching active users via proxy...');
                    const data = await apiCall('/users/active');
                    
                    // üõ°Ô∏è Ensure data is always an array and transform safely
                    const rawUsers = ensureArray(data, []);
                    const safeMembers = rawUsers.map(user => ({
                        id: user._id,
                        username: user.username,
                        avatar: user.avatar,
                        tier: user.tier,
                        status: 'online',
                        lastSeen: new Date()
                    }));
                    
                    setMembers(safeMembers);
                    debugLog(`‚úÖ Users loaded: ${safeMembers.length} members`);
                } catch (err) {
                    debugLog('‚ùå Failed to fetch users:', err.message);
                    console.error('Failed to fetch users:', err);
                    
                    // üõ°Ô∏è Ensure members stays as array even on error
                    setMembers(ensureArray([]));
                }
            };

            // Chat functions
            const sendChatMessage = useCallback(() => {
                if (!newMessage.trim()) return;

                // Since we don't have Socket.IO, simulate adding message locally
                const messageData = {
                    id: Date.now() + Math.random(),
                    message: newMessage.trim(),
                    user: {
                        id: user.id,
                        username: user.username,
                        avatar: user.avatar,
                        tier: user.tier,
                        isAdmin: user.isAdmin
                    },
                    timestamp: new Date()
                };

                setChatMessages(prev => [...prev, messageData]);
                setNewMessage('');
                debugLog('üí¨ Message sent locally (no Socket.IO)');
            }, [newMessage, user]);

            const updateUserStatus = useCallback((newStatus) => {
                setUserStatus(newStatus);
                debugLog(`üë§ User status updated to: ${newStatus}`);
            }, []);

            const startDirectMessage = useCallback((targetUser) => {
                setActiveDMUser(targetUser);
                setActiveTab('chat');
                setChatExpanded(true);
                
                setDmUnreadCounts(prev => ({
                    ...prev,
                    [targetUser.id]: 0
                }));
                
                debugLog(`üí¨ Started DM with: ${targetUser.username}`);
            }, []);

            const goBackToGroupChat = useCallback(() => {
                setActiveDMUser(null);
                setActiveTab('chat');
                debugLog('üîô Returned to group chat');
            }, []);

            // Profile functions
            const fetchUserProfile = async (userId) => {
                try {
                    const profile = await apiCall(`/users/${userId}/profile`);
                    setUserProfiles(prev => ({
                        ...prev,
                        [userId]: profile
                    }));
                    return profile;
                } catch (err) {
                    // If profile doesn't exist, return default
                    const defaultProfile = {
                        bio: '',
                        tradingExperience: 'Beginner',
                        favoriteMarkets: [],
                        achievements: [],
                        socialLinks: { twitter: '', discord: '', telegram: '' },
                        isPublic: true,
                        tradingStats: { winRate: 0, totalTrades: 0, favoriteStrategy: '' }
                    };
                    setUserProfiles(prev => ({
                        ...prev,
                        [userId]: defaultProfile
                    }));
                    return defaultProfile;
                }
            };

            const updateUserProfile = async (profileData) => {
                try {
                    const updatedProfile = await apiCall('/users/profile', {
                        method: 'PUT',
                        body: JSON.stringify(profileData)
                    });
                    
                    setUserProfiles(prev => ({
                        ...prev,
                        [user.id]: updatedProfile
                    }));
                    
                    setIsEditingProfile(false);
                    setError('Profile updated successfully! üéâ');
                    setTimeout(() => setError(''), 3000);
                    
                    return updatedProfile;
                } catch (err) {
                    setError('Failed to update profile: ' + err.message);
                }
            };

            const viewUserProfile = useCallback(async (targetUser) => {
                setShowProfile(targetUser);
                
                // Fetch profile data if not already loaded
                if (!userProfiles[targetUser.id]) {
                    await fetchUserProfile(targetUser.id);
                }
            }, [userProfiles]);

            const editMyProfile = useCallback(async () => {
                setIsEditingProfile(true);
                setShowProfile(user);
                
                // Load current profile data
                let currentProfile = userProfiles[user.id];
                if (!currentProfile) {
                    currentProfile = await fetchUserProfile(user.id);
                }
                
                setProfileForm(currentProfile);
                setPhotoPreview(null);
            }, [user, userProfiles]);

            // Photo upload functions (simplified for proxy)
            const handlePhotoSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    setError('Please select a valid image file');
                    setTimeout(() => setError(''), 3000);
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    setError('Image must be smaller than 5MB');
                    setTimeout(() => setError(''), 3000);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    setPhotoPreview(e.target.result);
                };
                reader.readAsDataURL(file);
            };

            const uploadPhoto = async () => {
                const file = fileInputRef.current?.files[0];
                if (!file) return;

                setIsUploadingPhoto(true);
                
                try {
                    // For now, simulate upload (you'd implement actual upload via proxy)
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    setPhotoPreview(null);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }

                    setError('Profile photo updated successfully! üì∏');
                    setTimeout(() => setError(''), 3000);

                } catch (err) {
                    setError('Failed to upload photo: ' + err.message);
                    setTimeout(() => setError(''), 5000);
                } finally {
                    setIsUploadingPhoto(false);
                }
            };

            const cancelPhotoUpload = () => {
                setPhotoPreview(null);
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            };

            // Load initial data
            useEffect(() => {
                if (user && !showSubscriptionPicker) {
                    debugLog('üìä Loading initial dashboard data...');
                    fetchAlerts();
                    fetchActiveUsers();
                }
            }, [user, filterType, showSubscriptionPicker]);

            const formatTimeAgo = (timestamp) => {
                const diff = Date.now() - new Date(timestamp).getTime();
                const minutes = Math.floor(diff / 60000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                return `${Math.floor(minutes / 60)}h ago`;
            };

            const handleCreateAlert = async () => {
                if (!user.isAdmin || !newAlert.title || !newAlert.message) return;
                
                setLoading(true);
                try {
                    await apiCall('/alerts', {
                        method: 'POST',
                        body: JSON.stringify(newAlert)
                    });
                    setNewAlert({ title: '', message: '', priority: 'MEDIUM', type: 'NEWS' });
                    setError('');
                    fetchAlerts(); // Refresh alerts
                } catch (err) {
                    setError('Failed to create alert');
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteAlert = async (alertId) => {
                if (!user.isAdmin) return;
                
                try {
                    await apiCall(`/alerts/${alertId}`, { method: 'DELETE' });
                    fetchAlerts(); // Refresh alerts
                } catch (err) {
                    setError('Failed to delete alert');
                }
            };

            // Drag and drop handlers for photo upload
            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        if (fileInputRef.current) {
                            fileInputRef.current.files = dt.files;
                            handlePhotoSelect({ target: { files: dt.files } });
                        }
                    } else {
                        setError('Please drop a valid image file');
                        setTimeout(() => setError(''), 3000);
                    }
                }
            };

            // üöÄ Handle rocket launch
            const handleRocketLaunch = () => {
                debugLog('üöÄ Rocket launched! TO THE MOON!');
                setRocketLaunched(true);
                setTimeout(() => setRocketLaunched(false), 3000);
            };

            // Profile Modal Component (simplified)
            const ProfileModal = () => {
                if (!showProfile) return null;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                            <div className="relative bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
                                <button
                                    onClick={() => {
                                        setShowProfile(null);
                                        setIsEditingProfile(false);
                                    }}
                                    className="absolute top-4 right-4 text-white hover:text-gray-200 text-2xl"
                                >
                                    ‚úï
                                </button>
                                
                                <div className="flex items-center gap-4">
                                    <img 
                                        src={showProfile.avatar} 
                                        alt={showProfile.username}
                                        className="w-20 h-20 rounded-full border-4 border-white shadow-lg"
                                    />
                                    <div className="flex-1">
                                        <h2 className="text-2xl font-bold">{showProfile.username}</h2>
                                        <div className="flex items-center gap-3 mt-2">
                                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                                                showProfile.tier === 'ADMIN' ? 'bg-red-500 text-white' :
                                                showProfile.tier === 'MONTHLY' ? 'bg-green-500 text-white' :
                                                showProfile.tier === 'WEEKLY' ? 'bg-blue-500 text-white' :
                                                'bg-gray-400 text-white'
                                            }`}>
                                                {showProfile.tier === 'ADMIN' ? 'üëë ADMIN' : 
                                                 showProfile.tier === 'MONTHLY' ? 'üíé MONTHLY' : 
                                                 showProfile.tier === 'WEEKLY' ? '‚≠ê WEEKLY' : 
                                                 'üÜì FREE'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-6">
                                <div className="text-center">
                                    <p className="text-gray-600">Profile functionality available in full version</p>
                                    <div className="mt-4">
                                        <RocketShip onLaunch={handleRocketLaunch} />
                                        <p className="text-sm text-gray-500 mt-2">üöÄ Click the rocket to launch!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Enhanced Chat Panel Component (simplified)
            const ChatPanel = () => {
                const isPaidUser = user.tier === 'WEEKLY' || user.tier === 'MONTHLY' || user.isAdmin;

                return (
                    <div className={`fixed bottom-0 right-4 z-50 transition-all duration-300 ${
                        chatExpanded ? 'w-96 h-96' : 'w-80 h-12'
                    }`}>
                        <div 
                            className="bg-gradient-to-r from-green-500 to-blue-600 text-white px-4 py-3 rounded-t-lg cursor-pointer flex items-center justify-between hover:from-green-600 hover:to-blue-700 transition-all"
                            onClick={() => setChatExpanded(!chatExpanded)}
                        >
                            <div className="flex items-center gap-2">
                                <span className="text-lg">üí¨</span>
                                <span className="font-bold">Trading Chat (Bulletproof)</span>
                                <div className="w-2 h-2 bg-green-300 rounded-full animate-pulse"></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <RocketShip onLaunch={handleRocketLaunch} />
                                <span className="text-sm">{chatExpanded ? '‚ñº' : '‚ñ≤'}</span>
                            </div>
                        </div>

                        {chatExpanded && (
                            <div className="bg-white border-l border-r border-gray-200 flex flex-col h-80">
                                <div className="flex-1 overflow-y-auto p-3 space-y-3 chat-scrollbar">
                                    {chatMessages.length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">
                                            <span className="text-4xl mb-2 block">üöÄ</span>
                                            <p className="text-sm">Welcome to RTi Trading Chat!</p>
                                            <p className="text-xs text-gray-400 mt-1">Start the conversation...</p>
                                        </div>
                                    ) : (
                                        chatMessages.slice(-10).map((message) => (
                                            <div key={message.id} className="chat-message-enter">
                                                <div className="flex items-start gap-2">
                                                    <img 
                                                        src={message.user?.avatar} 
                                                        alt="" 
                                                        className="w-8 h-8 rounded-full flex-shrink-0"
                                                    />
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="font-medium text-sm text-blue-600">
                                                                {message.user?.username}
                                                            </span>
                                                            <span className="text-xs text-gray-400">
                                                                {formatTimeAgo(message.timestamp)}
                                                            </span>
                                                        </div>
                                                        <p className="text-sm text-gray-700 break-words">
                                                            {message.message}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div className="border-t p-3">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newMessage}
                                            onChange={(e) => setNewMessage(e.target.value)}
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && !e.shiftKey) {
                                                    e.preventDefault();
                                                    sendChatMessage();
                                                }
                                            }}
                                            placeholder={
                                                !isPaidUser 
                                                    ? "Upgrade for unlimited messages..." 
                                                    : "Type your message..."
                                            }
                                            className="flex-1 text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            disabled={!isPaidUser}
                                        />
                                        <button
                                            onClick={sendChatMessage}
                                            disabled={!newMessage.trim() || !isPaidUser}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            üöÄ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // Landing Page Component (with rocket ship)
            const LandingPage = () => {
                const [loginData, setLoginData] = useState({ username: '', password: '' });
                const [isRegistering, setIsRegistering] = useState(false);
                const [registerData, setRegisterData] = useState({ username: '', email: '', password: '' });

                const fillTestCredentials = (username = 'testuser', password = 'test123') => {
                    if (isRegistering) {
                        setRegisterData({ ...registerData, username, password, email: 'test@example.com' });
                    } else {
                        setLoginData({ username, password });
                    }
                };

                const handleLogin = async () => {
                    if (!loginData.username || !loginData.password) {
                        setError('Please enter username and password');
                        return;
                    }

                    setLoading(true);
                    setError('');

                    try {
                        const response = await apiCall('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify(loginData)
                        });

                        localStorage.setItem('token', response.token);
                        setUser(response.user);

                        if (requiresSubscriptionSelection(response.user)) {
                            setShowSubscriptionPicker(true);
                            setShowLanding(false);
                            return;
                        }

                        setShowLanding(false);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                const handleRegister = async () => {
                    if (!registerData.username || !registerData.email || !registerData.password) {
                        setError('Please fill in all fields');
                        return;
                    }

                    setLoading(true);
                    setError('');

                    try {
                        const response = await apiCall('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify(registerData)
                        });

                        localStorage.setItem('token', response.token);
                        setUser(response.user);
                        
                        setShowSubscriptionPicker(true);
                        setShowLanding(false);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black overflow-hidden relative">
                        {/* Moon */}
                        <div className="moon">üåï</div>
                        
                        {/* Money Rain Effect */}
                        <div className="money-rain">
                            {[...Array(20)].map((_, i) => {
                                const randomLeft = ((i * 17) % 100);
                                const randomDelay = ((i * 7) % 40) / 10;
                                const randomDuration = 3 + ((i * 3) % 20) / 10;
                                return (
                                    <div 
                                        key={i} 
                                        className="falling-money"
                                        style={{
                                            left: `${randomLeft}%`,
                                            animationDelay: `${randomDelay}s`,
                                            animationDuration: `${randomDuration}s`
                                        }}
                                    />
                                );
                            })}
                        </div>

                        <div className="relative z-10 flex flex-col items-center justify-center min-h-screen px-4 pt-32">
                            {/* Rocket Ship Launch Area */}
                            <div className="relative mb-6">
                                <div className="flex justify-center">
                                    <RocketShip onLaunch={handleRocketLaunch} />
                                </div>
                            </div>

                            <div className="text-center mb-8">
                                <h1 className="text-6xl md:text-8xl font-black text-white mb-4 tracking-wider"
                                    style={{ fontFamily: 'Impact, Arial Black, sans-serif' }}>
                                    RTi
                                </h1>
                                <h2 className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-500"
                                    style={{ fontFamily: 'Impact, Arial Black, sans-serif' }}>
                                    CASHFLOWOPS
                                </h2>
                                <p className="text-xl md:text-2xl text-gray-300 mt-4 font-bold tracking-widest">
                                    üõ°Ô∏è BULLETPROOF EDITION üöÄ
                                </p>
                            </div>

                            <div className="relative w-full h-24 mb-6">
                                <div 
                                    className="absolute bottom-0 left-0"
                                    style={{
                                        animation: 'dollarAcrossToMoon 4s ease-in-out forwards'
                                    }}
                                >
                                    <div 
                                        className="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-500 cursor-pointer select-none"
                                        style={{
                                            fontFamily: 'Impact, Arial Black, sans-serif',
                                            textShadow: '0 0 30px rgba(34, 197, 94, 0.8), 0 0 60px rgba(234, 179, 8, 0.6)'
                                        }}
                                    >
                                        $
                                    </div>
                                    
                                    <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
                                        <div 
                                            className="w-6 h-8 bg-gradient-to-t from-red-500 via-orange-400 to-yellow-300 opacity-90"
                                            style={{
                                                clipPath: 'polygon(50% 100%, 20% 0%, 80% 0%)'
                                            }}
                                        ></div>
                                    </div>
                                </div>
                            </div>

                            <div className="text-center mb-6">
                                <p 
                                    className="text-2xl font-black text-yellow-400 opacity-0"
                                    style={{
                                        fontFamily: 'Impact, Arial Black, sans-serif',
                                        animation: 'messageAppear 4s ease-out forwards'
                                    }}
                                >
                                    üöÄ BULLETPROOF MOON LANDING SUCCESSFUL! üåï
                                </p>
                            </div>

                            <div className="bg-black/80 backdrop-blur-lg border border-green-500/30 rounded-2xl shadow-2xl p-8 w-full max-w-md">
                                {error && (
                                    <div className="bg-red-500/20 border border-red-500 text-red-300 px-4 py-2 rounded-lg mb-4">
                                        {error}
                                    </div>
                                )}

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setIsRegistering(false)}
                                        className={`flex-1 py-2 px-4 rounded-lg font-medium ${
                                            !isRegistering 
                                                ? 'bg-green-600 text-white' 
                                                : 'bg-gray-700 text-gray-300'
                                        }`}
                                    >
                                        Login
                                    </button>
                                    <button
                                        onClick={() => setIsRegistering(true)}
                                        className={`flex-1 py-2 px-4 rounded-lg font-medium ${
                                            isRegistering 
                                                ? 'bg-green-600 text-white' 
                                                : 'bg-gray-700 text-gray-300'
                                        }`}
                                    >
                                        Sign up
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    {isRegistering && (
                                        <div>
                                            <label className="block text-sm font-bold text-green-400 mb-2">Email</label>
                                            <input
                                                type="email"
                                                value={registerData.email}
                                                onChange={(e) => setRegisterData({...registerData, email: e.target.value})}
                                                className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-white"
                                                placeholder="Enter your email"
                                            />
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-bold text-green-400 mb-2">Username</label>
                                        <input
                                            type="text"
                                            value={isRegistering ? registerData.username : loginData.username}
                                            onChange={(e) => {
                                                if (isRegistering) {
                                                    setRegisterData({...registerData, username: e.target.value});
                                                } else {
                                                    setLoginData({...loginData, username: e.target.value});
                                                }
                                            }}
                                            className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-white"
                                            placeholder="Enter your username"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-green-400 mb-2">Password</label>
                                        <input
                                            type="password"
                                            value={isRegistering ? registerData.password : loginData.password}
                                            onChange={(e) => {
                                                if (isRegistering) {
                                                    setRegisterData({...registerData, password: e.target.value});
                                                } else {
                                                    setLoginData({...loginData, password: e.target.value});
                                                }
                                            }}
                                            className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-white"
                                            placeholder="Enter your password"
                                        />
                                    </div>

                                    <button
                                        onClick={isRegistering ? handleRegister : handleLogin}
                                        disabled={loading}
                                        className="w-full bg-gradient-to-r from-green-500 via-yellow-500 to-orange-500 text-black py-4 rounded-lg font-black text-lg hover:from-green-600 hover:via-yellow-600 hover:to-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg uppercase tracking-wide disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {loading ? 'üöÄ Loading...' : `üõ°Ô∏è ${isRegistering ? 'Join' : 'Launch'} Bulletproof Dashboard`}
                                    </button>

                                    {!isRegistering && (
                                        <div className="text-center text-sm text-gray-400">
                                            <p className="font-bold text-green-400 mb-2">Demo Credentials:</p>
                                            <button 
                                                onClick={() => fillTestCredentials('admin', 'admin123')}
                                                className="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition-colors mb-1"
                                            >
                                                Admin: admin / admin123
                                            </button>
                                            <button 
                                                onClick={() => fillTestCredentials()}
                                                className="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition-colors"
                                            >
                                                Test User: testuser / test123
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Subscription Selection Page (simplified with rocket)
            const SubscriptionPicker = () => {
                const handlePlanSelection = async (planId) => {
                    debugLog('Plan selected:', planId);
                    
                    if (planId === 'weekly') {
                        window.open('https://buy.stripe.com/aFa3cw2g84qA9E78Wq18c00', '_blank');
                    } else {
                        window.open('https://buy.stripe.com/aFa3cw2g84qA9E78Wq18c00', '_blank');
                    }
                    
                    setError('üöÄ Redirecting to secure payment...');
                };

                const handleSkipForNow = () => {
                    setShowSubscriptionPicker(false);
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black flex items-center justify-center px-4">
                        <div className="text-center">
                            <div className="mb-8">
                                <RocketShip onLaunch={handleRocketLaunch} />
                            </div>
                            
                            <h1 className="text-4xl font-black text-white mb-8">Choose Your Rocket Fuel ‚õΩ</h1>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div className="bg-black/80 border border-gray-500 rounded-2xl p-6 hover:border-green-400 transition-all">
                                    <h3 className="text-2xl font-bold text-white mb-4">üöÄ Weekly Fuel</h3>
                                    <div className="text-3xl font-bold text-green-400 mb-4">$6/week</div>
                                    <button
                                        onClick={() => handlePlanSelection('weekly')}
                                        className="w-full bg-gray-700 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors"
                                    >
                                        Select Weekly
                                    </button>
                                </div>
                                
                                <div className="relative bg-black/80 border border-green-500 rounded-2xl p-6 plan-glow">
                                    <div className="absolute -top-4 left-1/2 transform -translate-x-1/2">
                                        <span className="bg-green-500 text-black px-4 py-2 rounded-full text-sm font-black">
                                            üî• Most Popular
                                        </span>
                                    </div>
                                    <h3 className="text-2xl font-bold text-white mb-4">üíé Monthly Fuel</h3>
                                    <div className="text-3xl font-bold text-green-400 mb-4">$20/month</div>
                                    <button
                                        onClick={() => handlePlanSelection('monthly')}
                                        className="w-full bg-gradient-to-r from-green-500 to-orange-500 text-black py-3 rounded-lg font-bold hover:from-green-600 hover:to-orange-600 transition-all"
                                    >
                                        üöÄ Launch Monthly
                                    </button>
                                </div>
                            </div>
                            
                            <button
                                onClick={handleSkipForNow}
                                className="text-gray-400 hover:text-white transition-colors text-sm underline"
                            >
                                Continue with free rocket (limited fuel)
                            </button>
                        </div>
                    </div>
                );
            };

            const Dashboard = () => {
                // üõ°Ô∏è Ensure alerts is always an array before filtering
                const safeAlerts = ensureArray(alerts, []);
                const filteredAlerts = safeAlerts.filter(alert => 
                    filterType === 'ALL' || alert.type === filterType
                );

                const isPaidUser = user.tier === 'WEEKLY' || user.tier === 'MONTHLY' || user.isAdmin;
                const limitedAlerts = isPaidUser ? filteredAlerts : filteredAlerts.slice(0, 3);

                return (
                    <div className="min-h-screen bg-gray-50 relative">
                        {/* üõ°Ô∏è Debug Panel */}
                        <DebugPanel 
                            isVisible={showDebugPanel} 
                            onToggle={() => setShowDebugPanel(!showDebugPanel)} 
                        />

                        <header className="bg-white shadow-sm border-b">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex justify-between items-center h-16">
                                    <div className="flex items-center gap-3">
                                        <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-orange-500">
                                            RTi Cashflowops üõ°Ô∏è
                                        </div>
                                        <RocketShip onLaunch={handleRocketLaunch} />
                                        <div className="flex items-center gap-2 text-green-600">
                                            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <span className="text-sm font-medium">PHP Proxy</span>
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-4">
                                        {user.isAdmin && (
                                            <button
                                                onClick={() => setShowAdminPanel(!showAdminPanel)}
                                                className="bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-red-600"
                                            >
                                                ‚öôÔ∏è Admin
                                            </button>
                                        )}

                                        <div className="flex items-center gap-3">
                                            <img 
                                                src={user.avatar} 
                                                alt="" 
                                                className="w-8 h-8 rounded-full cursor-pointer"
                                                onClick={editMyProfile}
                                            />
                                            <div className="text-right">
                                                <p className="text-sm font-medium">{user.username}</p>
                                                <p className="text-xs text-gray-500">{user.tier}</p>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    localStorage.removeItem('token');
                                                    setUser(null);
                                                    setShowLanding(true);
                                                }}
                                                className="p-1 text-gray-400 hover:text-gray-600"
                                            >
                                                üö™
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                                    {error}
                                    <button 
                                        onClick={() => setError('')}
                                        className="float-right text-red-500"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            )}

                            {/* Free User Upgrade Banner with Rocket */}
                            {!isPaidUser && (
                                <div className="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white rounded-lg p-6 mb-8">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <RocketShip onLaunch={handleRocketLaunch} />
                                            <div>
                                                <h3 className="text-xl font-black">üõ°Ô∏è UPGRADE YOUR ROCKET FUEL!</h3>
                                                <p>Unlimited access to all features with bulletproof reliability</p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => setShowSubscriptionPicker(true)}
                                            className="bg-white text-orange-600 px-6 py-3 rounded-lg font-black hover:bg-gray-100"
                                        >
                                            üöÄ UPGRADE
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Admin Panel */}
                            {user.isAdmin && showAdminPanel && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
                                    <h3 className="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                                        ‚öôÔ∏è Admin Panel 
                                        <RocketShip onLaunch={handleRocketLaunch} />
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <select
                                            value={newAlert.type}
                                            onChange={(e) => setNewAlert({...newAlert, type: e.target.value})}
                                            className="px-3 py-2 border rounded-lg"
                                        >
                                            <option value="NEWS">News Alert</option>
                                            <option value="BOT_SIGNAL">Bot Signal</option>
                                            <option value="MARKET_UPDATE">Market Update</option>
                                        </select>
                                        <select
                                            value={newAlert.priority}
                                            onChange={(e) => setNewAlert({...newAlert, priority: e.target.value})}
                                            className="px-3 py-2 border rounded-lg"
                                        >
                                            <option value="LOW">Low</option>
                                            <option value="MEDIUM">Medium</option>
                                            <option value="HIGH">High</option>
                                        </select>
                                    </div>
                                    <div className="space-y-4">
                                        <input
                                            type="text"
                                            value={newAlert.title}
                                            onChange={(e) => setNewAlert({...newAlert, title: e.target.value})}
                                            className="w-full px-3 py-2 border rounded-lg"
                                            placeholder="Alert title"
                                        />
                                        <textarea
                                            value={newAlert.message}
                                            onChange={(e) => setNewAlert({...newAlert, message: e.target.value})}
                                            className="w-full px-3 py-2 border rounded-lg"
                                            rows="3"
                                            placeholder="Alert message"
                                        />
                                        <button
                                            onClick={handleCreateAlert}
                                            disabled={loading}
                                            className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                        >
                                            {loading ? 'Creating...' : 'üöÄ Create Alert'}
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                                <div className="lg:col-span-3 space-y-6">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                            üõ°Ô∏è Bulletproof Live Alerts 
                                            <RocketShip onLaunch={handleRocketLaunch} />
                                        </h2>
                                        <div className="flex gap-2">
                                            {['ALL', 'BOT_SIGNAL', 'NEWS', 'MARKET_UPDATE'].map(type => (
                                                <button
                                                    key={type}
                                                    onClick={() => setFilterType(type)}
                                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                                                        filterType === type 
                                                            ? 'bg-blue-500 text-white' 
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    {type === 'BOT_SIGNAL' ? 'Bot' : 
                                                     type === 'NEWS' ? 'News' : 
                                                     type === 'MARKET_UPDATE' ? 'Market' : 'All'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        {limitedAlerts.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                <div className="text-4xl mb-4">üõ°Ô∏è</div>
                                                <p>No alerts found. System running bulletproof!</p>
                                                <div className="mt-4">
                                                    <RocketShip onLaunch={handleRocketLaunch} />
                                                </div>
                                            </div>
                                        ) : (
                                            limitedAlerts.map(alert => (
                                                <div key={alert._id} className={`bg-white rounded-lg shadow-sm border-l-4 p-6 ${
                                                    alert.priority === 'HIGH' ? 'border-red-500' :
                                                    alert.priority === 'MEDIUM' ? 'border-yellow-500' : 'border-gray-300'
                                                }`}>
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className="text-xl">
                                                                    {alert.type === 'BOT_SIGNAL' ? 'ü§ñ' : 
                                                                     alert.type === 'MARKET_UPDATE' ? 'üìä' : 'üîî'}
                                                                </span>
                                                                <h3 className="font-bold text-gray-900">{alert.title}</h3>
                                                            </div>
                                                            <p className="text-gray-700 mb-3">{alert.message}</p>
                                                        </div>
                                                        
                                                        <div className="text-right ml-4">
                                                            <div className="flex items-center gap-2">
                                                                <span>üïê</span>
                                                                <span className="text-sm text-gray-500">{formatTimeAgo(alert.createdAt)}</span>
                                                                {user.isAdmin && (
                                                                    <button
                                                                        onClick={() => handleDeleteAlert(alert._id)}
                                                                        className="p-1 text-red-400 hover:text-red-600"
                                                                    >
                                                                        üóëÔ∏è
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                        
                                        {!isPaidUser && filteredAlerts.length > 3 && (
                                            <div className="text-center bg-orange-100 p-8 rounded-lg">
                                                <div className="text-4xl mb-4">üîí</div>
                                                <h3 className="text-xl font-bold mb-2">Premium Content</h3>
                                                <p className="text-gray-600 mb-4">Upgrade to see all {filteredAlerts.length} alerts</p>
                                                <div className="flex items-center justify-center gap-4">
                                                    <button 
                                                        onClick={() => setShowSubscriptionPicker(true)}
                                                        className="bg-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-orange-600"
                                                    >
                                                        üöÄ UPGRADE NOW
                                                    </button>
                                                    <RocketShip onLaunch={handleRocketLaunch} />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="lg:col-span-1">
                                    <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            üë• Active Users ({ensureArray(members, []).length})
                                            <RocketShip onLaunch={handleRocketLaunch} />
                                        </h3>
                                        
                                        <div className="space-y-3">
                                            {(isPaidUser ? members : members.slice(0, 3)).map(member => (
                                                <div key={member.id} className="flex items-center gap-3">
                                                    <img 
                                                        src={member.avatar} 
                                                        alt="" 
                                                        className="w-10 h-10 rounded-full cursor-pointer" 
                                                        onClick={() => viewUserProfile(member)}
                                                    />
                                                    <div className="flex-1">
                                                        <p className="font-medium text-sm">{member.username}</p>
                                                        <span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">
                                                            {member.tier}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            {!isPaidUser && members.length > 3 && (
                                                <div className="text-center py-3 text-sm text-gray-500 border-t">
                                                    <p>+{members.length - 3} more members</p>
                                                    <button 
                                                        onClick={() => setShowSubscriptionPicker(true)}
                                                        className="text-orange-600 font-medium flex items-center justify-center gap-2"
                                                    >
                                                        Upgrade to see all <RocketShip onLaunch={handleRocketLaunch} />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg shadow-sm p-6">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            üìà Live Markets
                                            {!isPaidUser && <span className="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded ml-2">LIMITED</span>}
                                        </h3>
                                        
                                        {isPaidUser ? (
                                            <div className="text-center py-8">
                                                <div className="text-4xl mb-3">üìä</div>
                                                <p className="text-gray-600">Market data via bulletproof proxy</p>
                                                <div className="text-sm text-green-600 mt-2 flex items-center justify-center gap-2">
                                                    üõ°Ô∏è Protected & Reliable <RocketShip onLaunch={handleRocketLaunch} />
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-center py-8">
                                                <div className="text-4xl mb-3">üîí</div>
                                                <p className="text-gray-600 mb-3">Real-time market data</p>
                                                <div className="flex items-center justify-center gap-2 mb-4">
                                                    <RocketShip onLaunch={handleRocketLaunch} />
                                                </div>
                                                <button 
                                                    onClick={() => setShowSubscriptionPicker(true)}
                                                    className="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-600"
                                                >
                                                    Unlock Premium
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <ChatPanel />
                        <ProfileModal />
                    </div>
                );
            };

            // Check for existing auth token on load
            useEffect(() => {
                const token = localStorage.getItem('token');
                if (token) {
                    debugLog('üîç Found existing token, validating via proxy...');
                    apiCall('/auth/profile')
                        .then(userData => {
                            debugLog('‚úÖ Token valid, user loaded:', userData.username);
                            setUser(userData);
                            
                            if (requiresSubscriptionSelection(userData)) {
                                setShowSubscriptionPicker(true);
                                setShowLanding(false);
                            } else {
                                setShowLanding(false);
                            }
                        })
                        .catch((error) => {
                            debugLog('‚ùå Token invalid, removing:', error.message);
                            localStorage.removeItem('token');
                        });
                }
            }, []);

            debugLog('üõ°Ô∏èüöÄ RTi Cashflowops Bulletproof Dashboard with Rocket Ship Loaded - All Errors Fixed!');

            // Render logic
            if (showLanding) {
                return React.createElement(LandingPage);
            }

            if (showSubscriptionPicker) {
                return React.createElement(SubscriptionPicker);
            }

            return React.createElement(Dashboard);
        };

        // Render the application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TradingGroupDashboard));
    </script>
</body>
</html>
