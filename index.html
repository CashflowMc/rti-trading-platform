<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RTi Cashflowops - Trading Group Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes dollarAcrossToMoon{0%{transform:translateX(0) translateY(0) scale(1) rotate(0);opacity:1}25%{transform:translateX(25vw) translateY(-30px) scale(1.1) rotate(15deg);opacity:1}50%{transform:translateX(50vw) translateY(-80px) scale(1.2) rotate(30deg);opacity:1}75%{transform:translateX(75vw) translateY(-140px) scale(1.1) rotate(45deg);opacity:1}100%{transform:translateX(calc(50vw - 50px)) translateY(-200px) scale(.8) rotate(60deg);opacity:.9}}
        @keyframes messageAppear{0%,85%{opacity:0;transform:translateY(20px)}90%{opacity:1;transform:translateY(0)}100%{opacity:1;transform:translateY(0)}}
        @keyframes moneyFall{0%{transform:translateY(-80px) rotate(0);opacity:0}10%{opacity:1}100%{transform:translateY(calc(100vh + 80px)) rotate(180deg);opacity:.8}}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes slideIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
        .chat-message-enter{animation:slideIn .3s ease-out}
        .money-rain{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;overflow:hidden}
        .falling-money{position:absolute;width:40px;height:17px;background:linear-gradient(135deg,#2d5016 0%,#3d6b1c 25%,#4a7c22 50%,#5a8c28 75%,#6ba02e 100%);border:1px solid #1a3d0a;border-radius:2px;box-shadow:0 2px 4px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.1);animation:moneyFall 4s ease-in infinite;position:relative}
        .falling-money::before{content:'$1';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#1a3d0a;font-size:10px;font-weight:700;font-family:serif}
        .falling-money::after{content:'';position:absolute;top:2px;left:2px;right:2px;bottom:2px;border:1px solid rgba(26,61,10,.3);border-radius:1px}
        .plan-glow{animation:pulse 2s infinite;box-shadow:0 0 30px rgba(34,197,94,.3)}
        .chat-scrollbar{scrollbar-width:thin;scrollbar-color:#cbd5e0 #f7fafc}
        .chat-scrollbar::-webkit-scrollbar{width:6px}
        .chat-scrollbar::-webkit-scrollbar-track{background:#f7fafc;border-radius:3px}
        .chat-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e0;border-radius:3px}
        .chat-scrollbar::-webkit-scrollbar-thumb:hover{background:#a0aec0}
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ✅ Same-origin API (proxied by your Node server)
const API_BASE_URL = '/api';

// Socket.io connection
let socket = null;

const debugLog = (message, data = null) => {
  console.log(`🐛 [RTi DEBUG] ${message}`);
  if (data) console.log('📊 Data:', data);
};

const TradingGroupDashboard = () => {
  const [user, setUser] = useState(null);
  const [showLanding, setShowLanding] = useState(true);
  const [showSubscriptionPicker, setShowSubscriptionPicker] = useState(false);
  const [alerts, setAlerts] = useState([]);
  const [members, setMembers] = useState([]);
  const [marketData, setMarketData] = useState({});
  const [filterType, setFilterType] = useState('ALL');
  const [newAlert, setNewAlert] = useState({ title: '', message: '', priority: 'MEDIUM', type: 'NEWS' });
  const [showAdminPanel, setShowAdminPanel] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Chat state
  const [chatMessages, setChatMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [chatExpanded, setChatExpanded] = useState(false);
  const [unreadMessages, setUnreadMessages] = useState(0);
  const chatMessagesRef = useRef(null);

  // Initialize socket connection
  useEffect(() => {
    if (user && !socket && !showSubscriptionPicker) {
      // ✅ Same-origin socket (your server must serve /socket.io)
      socket = io();

      socket.on('connect', () => {
        debugLog('Connected to server');
        socket.emit('joinTradingRoom', user.id);
      });

      socket.on('newAlert', (alert) => {
        setAlerts(prev => [alert, ...prev]);
      });

      socket.on('alertDeleted', (alertId) => {
        setAlerts(prev => prev.filter(alert => alert._id !== alertId));
      });

      socket.on('marketUpdate', (data) => {
        setMarketData(prev => ({ ...prev, [data.symbol]: data }));
      });

      // Chat events
      socket.on('chatMessage', (message) => {
        debugLog('New chat message received:', message);
        setChatMessages(prev => [...prev, {
          ...message,
          id: Date.now() + Math.random(),
          timestamp: new Date()
        }]);
        if (!chatExpanded) setUnreadMessages(prev => prev + 1);
      });

      socket.on('userJoined', (userData) => {
        debugLog('User joined:', userData);
        setChatMessages(prev => [...prev, {
          id: Date.now() + Math.random(),
          type: 'system',
          message: `${userData.username} joined the trading room`,
          timestamp: new Date()
        }]);
      });

      socket.on('userLeft', (userData) => {
        debugLog('User left:', userData);
        setChatMessages(prev => [...prev, {
          id: Date.now() + Math.random(),
          type: 'system',
          message: `${userData.username} left the trading room`,
          timestamp: new Date()
        }]);
      });
    }

    return () => {
      if (socket) {
        socket.disconnect();
        socket = null;
      }
    };
  }, [user, showSubscriptionPicker]);

  // Auto-scroll chat to bottom
  useEffect(() => {
    if (chatMessagesRef.current) {
      chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
    }
  }, [chatMessages]);

  // Clear unread when chat is expanded
  useEffect(() => {
    if (chatExpanded) setUnreadMessages(0);
  }, [chatExpanded]);

  // API helper
  const apiCall = async (endpoint, options = {}) => {
    const token = localStorage.getItem('token');
    const headers = {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` })
    };

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers, ...options });
      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error || `API Error ${response.status}`);
      }
      return response.json();
    } catch (error) {
      setError(error.message);
      throw error;
    }
  };

  const requiresSubscriptionSelection = (user) => {
    if (!user) return false;
    if (user.isAdmin) return false;
    const hasNeverSubscribed = !user.subscriptionId && !user.subscriptionStatus && user.tier === 'FREE';
    return hasNeverSubscribed;
  };

  // Chat functions
  const sendChatMessage = () => {
    if (!newMessage.trim() || !socket) return;
    const messageData = {
      message: newMessage.trim(),
      user: {
        id: user.id,
        username: user.username,
        avatar: user.avatar,
        tier: user.tier,
        isAdmin: user.isAdmin
      },
      timestamp: new Date()
    };
    socket.emit('chatMessage', messageData);
    setNewMessage('');
  };

  const handleChatKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChatMessage();
    }
  };

  const formatChatTime = (timestamp) =>
    new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const getTierColor = (tier) => {
    switch (tier) {
      case 'ADMIN': return 'text-red-600 bg-red-100';
      case 'MONTHLY': return 'text-green-600 bg-green-100';
      case 'WEEKLY': return 'text-blue-600 bg-blue-100';
      default: return 'text-gray-600 bg-gray-100';
    }
  };

  const fetchAlerts = async () => {
    try {
      const data = await apiCall(`/alerts?type=${filterType}`);
      setAlerts(data);
    } catch (_) {}
  };

  const fetchActiveUsers = async () => {
    try {
      const data = await apiCall('/users/active');
      setMembers(data.map(user => ({
        id: user._id,
        username: user.username,
        avatar: user.avatar,
        tier: user.tier,
        status: 'online'
      })));
    } catch (_) {}
  };

  useEffect(() => {
    if (user && !showSubscriptionPicker) {
      fetchAlerts();
      fetchActiveUsers();
    }
  }, [user, filterType, showSubscriptionPicker]);

  const formatTimeAgo = (timestamp) => {
    const diff = Date.now() - new Date(timestamp).getTime();
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    return `${Math.floor(minutes / 60)}h ago`;
  };

  const handleCreateAlert = async () => {
    if (!user.isAdmin || !newAlert.title || !newAlert.message) return;
    setLoading(true);
    try {
      await apiCall('/alerts', { method: 'POST', body: JSON.stringify(newAlert) });
      setNewAlert({ title: '', message: '', priority: 'MEDIUM', type: 'NEWS' });
      setError('');
    } catch (_) {} finally {
      setLoading(false);
    }
  };

  const handleDeleteAlert = async (alertId) => {
    if (!user.isAdmin) return;
    try {
      await apiCall(`/alerts/${alertId}`, { method: 'DELETE' });
    } catch (_) {}
  };

  const LandingPage = () => {
    const [loginData, setLoginData] = useState({ username: '', password: '' });
    const [isRegistering, setIsRegistering] = useState(false);
    const [registerData, setRegisterData] = useState({ username: '', email: '', password: '' });

    const fillTestCredentials = (username = 'testuser', password = 'test123') => {
      if (isRegistering) {
        setRegisterData({ ...registerData, username, password, email: 'test@example.com' });
      } else {
        setLoginData({ username, password });
      }
      setError('Test credentials filled: ' + username);
      setTimeout(() => setError(''), 2000);
    };

    const fillAdminCredentials = () => { fillTestCredentials('admin', 'admin123'); };

    useEffect(() => {
      window.fillTestUser = () => fillTestCredentials();
      window.fillAdmin = fillAdminCredentials;
    }, [isRegistering, registerData, loginData]);

    const handleLogin = async () => {
      if (!loginData.username || !loginData.password) {
        setError('Please enter username and password');
        return;
      }
      setLoading(true);
      setError('');
      try {
        const response = await apiCall('/auth/login', { method: 'POST', body: JSON.stringify(loginData) });
        localStorage.setItem('token', response.token);
        setUser(response.user);
        if (requiresSubscriptionSelection(response.user)) {
          setShowSubscriptionPicker(true);
          setShowLanding(false);
          return;
        }
        setShowLanding(false);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    const handleRegister = async () => {
      if (!registerData.username || !registerData.email || !registerData.password) {
        setError('Please fill in all fields');
        return;
      }
      setLoading(true);
      setError('');
      try {
        const response = await apiCall('/auth/register', { method: 'POST', body: JSON.stringify(registerData) });
        localStorage.setItem('token', response.token);
        setUser(response.user);
        setShowSubscriptionPicker(true);
        setShowLanding(false);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black overflow-hidden relative">
        <div className="money-rain">
          {[...Array(20)].map((_, i) => {
            const randomLeft = ((i * 17) % 100);
            const randomDelay = ((i * 7) % 40) / 10;
            const randomDuration = 3 + ((i * 3) % 20) / 10;
            return (
              <div key={i} className="falling-money"
                   style={{ left: `${randomLeft}%`, animationDelay: `${randomDelay}s`, animationDuration: `${randomDuration}s` }} />
            );
          })}
        </div>

        <div className="absolute inset-0">
          <div className="absolute top-20 left-10 w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
          <div className="absolute top-40 right-20 w-1 h-1 bg-white rounded-full animate-ping"></div>
          <div className="absolute bottom-32 left-1/4 w-1.5 h-1.5 bg-green-400 rounded-full animate-bounce"></div>
        </div>

        <div className="relative z-10 flex flex-col items-center justify-center min-h-screen px-4 pt-32">
          <div className="relative mb-6">
            <div className="flex justify-center"><div className="text-8xl">🌕</div></div>
          </div>

          <div className="text-center mb-8">
            <h1 className="text-6xl md:text-8xl font-black text-white mb-4 tracking-wider"
                style={{ fontFamily:'Impact, Arial Black, sans-serif', textShadow:'0 0 20px rgba(255,255,255,.3), 0 0 40px rgba(34,197,94,.2)' }}>
              RTi
            </h1>
            <h2 className="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-500 tracking-wide"
                style={{ fontFamily:'Impact, Arial Black, sans-serif' }}>
              CASHFLOWOPS
            </h2>
            <p className="text-xl md:text-2xl text-gray-300 mt-4 font-bold tracking-widest">TO THE MOON 🚀</p>
          </div>

          <div className="relative w-full h-24 mb-6">
            <div className="absolute bottom-0 left-0" style={{ animation:'dollarAcrossToMoon 4s ease-in-out forwards' }}>
              <div className="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-500 cursor-pointer select-none"
                   style={{ fontFamily:'Impact, Arial Black, sans-serif', textShadow:'0 0 30px rgba(34,197,94,.8), 0 0 60px rgba(234,179,8,.6)' }}>$</div>
              <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
                <div className="w-6 h-8 bg-gradient-to-t from-red-500 via-orange-400 to-yellow-300 opacity-90"
                     style={{ clipPath:'polygon(50% 100%, 20% 0%, 80% 0%)' }}></div>
              </div>
              <div className="absolute -bottom-1 left-1/4 transform -translate-x-1/2">
                <div className="w-3 h-6 bg-gradient-to-t from-orange-500 to-red-400 opacity-70"
                     style={{ clipPath:'polygon(50% 100%, 0% 0%, 100% 0%)' }}></div>
              </div>
              <div className="absolute -bottom-1 right-1/4 transform translate-x-1/2">
                <div className="w-3 h-6 bg-gradient-to-t from-orange-500 to-red-400 opacity-70"
                     style={{ clipPath:'polygon(50% 100%, 0% 0%, 100% 0%)' }}></div>
              </div>
            </div>
          </div>

          <div className="text-center mb-6">
            <p className="text-2xl font-black text-yellow-400 opacity-0"
               style={{ fontFamily:'Impact, Arial Black, sans-serif', animation:'messageAppear 4s ease-out forwards' }}>
              🚀 MOON LANDING SUCCESSFUL! 🌕
            </p>
          </div>

          <div className="bg-black/80 backdrop-blur-lg border border-green-500/30 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            {error && <div className="bg-red-500/20 border border-red-500 text-red-300 px-4 py-2 rounded-lg mb-4">{error}</div>}

            <div className="flex gap-2 mb-6">
              <button onClick={() => setIsRegistering(false)}
                className={`flex-1 py-2 px-4 rounded-lg font-medium ${!isRegistering ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-300'}`}>
                Login
              </button>
              <button onClick={() => setIsRegistering(true)}
                className={`flex-1 py-2 px-4 rounded-lg font-medium ${isRegistering ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-300'}`}>
                Sign up
              </button>
            </div>

            <div className="space-y-6">
              {isRegistering && (
                <div>
                  <label className="block text-sm font-bold text-green-400 mb-2 uppercase tracking-wide">Email</label>
                  <input type="email" value={registerData.email}
                    onChange={(e) => setRegisterData({ ...registerData, email: e.target.value })}
                    className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent text-white placeholder-gray-400"
                    placeholder="Enter your email" />
                </div>
              )}

              <div>
                <label className="block text-sm font-bold text-green-400 mb-2 uppercase tracking-wide">Username</label>
                <input type="text" value={isRegistering ? registerData.username : loginData.username}
                  onChange={(e) => { isRegistering ? setRegisterData({ ...registerData, username: e.target.value }) : setLoginData({ ...loginData, username: e.target.value }); }}
                  className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent text-white placeholder-gray-400"
                  placeholder="Enter your username" />
              </div>

              <div>
                <label className="block text-sm font-bold text-green-400 mb-2 uppercase tracking-wide">Password</label>
                <input type="password" value={isRegistering ? registerData.password : loginData.password}
                  onChange={(e) => { isRegistering ? setRegisterData({ ...registerData, password: e.target.value }) : setLoginData({ ...loginData, password: e.target.value }); }}
                  className="w-full px-4 py-3 bg-gray-900 border border-green-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent text-white placeholder-gray-400"
                  placeholder="Enter your password" />
              </div>

              <button onClick={isRegistering ? handleRegister : handleLogin} disabled={loading}
                className="w-full bg-gradient-to-r from-green-500 via-yellow-500 to-orange-500 text-black py-4 rounded-lg font-black text-lg hover:from-green-600 hover:via-yellow-600 hover:to-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg uppercase tracking-wide disabled:opacity-50 disabled:cursor-not-allowed">
                {loading ? '🚀 Loading...' : `🚀 ${isRegistering ? 'Join' : 'Launch to'} Dashboard`}
              </button>

              {!isRegistering && (
                <div className="text-center text-sm text-gray-400 space-y-2">
                  <p className="font-bold text-green-400">Demo Credentials:</p>
                  <div className="space-y-1">
                    <button onClick={fillAdminCredentials} className="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition-colors">
                      Admin: <span className="text-white">admin</span> / <span className="text-white">admin123</span>
                    </button>
                    <button onClick={() => fillTestCredentials()} className="block w-full text-left px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition-colors">
                      Test User: <span className="text-white">testuser</span> / <span className="text-white">test123</span>
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // SubscriptionPicker, ChatPanel, Dashboard — unchanged from your version
  // (omitted here for brevity; keep your existing components)

  // BUT keep your `Dashboard` and `ChatPanel` exactly as in your file.

  // Check for existing auth token on load
  useEffect(() => {
    const token = localStorage.getItem('token');
    if (token) {
      debugLog('Found existing token, validating...');
      apiCall('/auth/profile')
        .then(userData => {
          debugLog('✅ Token valid, user loaded:', userData.username);
          setUser(userData);
          if (requiresSubscriptionSelection(userData)) {
            setShowSubscriptionPicker(true);
            setShowLanding(false);
          } else {
            setShowLanding(false);
          }
        })
        .catch((error) => {
          debugLog('❌ Token invalid, removing:', error.message);
          localStorage.removeItem('token');
        });
    }
  }, []);

  debugLog('🚀 RTi Cashflowops Dashboard Loaded');

  // Render logic
  if (showLanding) return React.createElement(LandingPage);
  if (showSubscriptionPicker) return React.createElement(SubscriptionPicker);
  return React.createElement(Dashboard);
};

// Render
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(TradingGroupDashboard));
</script>
</body>
</html>
