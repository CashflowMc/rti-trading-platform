<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RTi Cashflowops - Trading Group Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes dollarAcrossToMoon {
      0% { transform: translateX(0px) translateY(0px) scale(1) rotate(0deg); opacity: 1; }
      25% { transform: translateX(25vw) translateY(-30px) scale(1.1) rotate(15deg); opacity: 1; }
      50% { transform: translateX(50vw) translateY(-80px) scale(1.2) rotate(30deg); opacity: 1; }
      75% { transform: translateX(75vw) translateY(-140px) scale(1.1) rotate(45deg); opacity: 1; }
      100% { transform: translateX(calc(50vw - 50px)) translateY(-200px) scale(0.8) rotate(60deg); opacity: 0.9; }
    }
    @keyframes moneyFall {
      0% { transform: translateY(-80px) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      100% { transform: translateY(calc(100vh + 80px)) rotate(180deg); opacity: 0.8; }
    }
    .money-rain {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none; overflow: hidden;
    }
    .falling-money {
      position: absolute; width: 40px; height: 17px;
      background: linear-gradient(135deg, #2d5016 0%, #3d6b1c 25%, #4a7c22 50%, #5a8c28 75%, #6ba02e 100%);
      border: 1px solid #1a3d0a; border-radius: 2px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
      animation: moneyFall 4s ease-in infinite;
    }
    .falling-money::before {
      content: '$1'; position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #1a3d0a; font-size: 10px; font-weight: bold; font-family: serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_BASE_URL = 'https://rti-trading-backend-production.up.railway.app/api';

    const debugLog = (msg, data = null) => {
      console.log(`üêõ [RTi DEBUG] ${msg}`);
      if (data) console.log('üìä Data:', data);
    };

    const TradingGroupDashboard = () => {
      const [user, setUser] = useState(null);
      const [alerts, setAlerts] = useState([]);
      const [filterType, setFilterType] = useState('ALL');
      const [showLanding, setShowLanding] = useState(true);
      const [error, setError] = useState('');

      const fetchAlerts = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/alerts?type=${filterType}`, {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          const data = await response.json();
          debugLog('Fetched alerts:', data);
          const parsed = Array.isArray(data) ? data : (data?.alerts || data?.data || []);
          setAlerts(parsed);
        } catch (err) {
          debugLog('‚ùå Alert fetch error:', err.message);
          setError('Failed to fetch alerts');
        }
      };

      useEffect(() => {
        if (user) fetchAlerts();
      }, [user, filterType]);

      const Dashboard = () => {
        const isPaidUser = user?.tier === 'WEEKLY' || user?.tier === 'MONTHLY' || user?.isAdmin;
        const filteredAlerts = Array.isArray(alerts)
          ? alerts.filter(alert => filterType === 'ALL' || alert.type === filterType)
          : [];
        const limitedAlerts = isPaidUser ? filteredAlerts : filteredAlerts.slice(0, 3);

        return (
          <div className="p-6">
            <h1 className="text-2xl font-bold">Welcome, {user?.username}</h1>
            {error && <p className="text-red-500">{error}</p>}
            <h2 className="mt-4 text-xl">Live Alerts:</h2>
            <ul className="mt-2 space-y-2">
              {limitedAlerts.map(alert => (
                <li key={alert._id} className="p-4 border rounded">
                  <strong>{alert.title}</strong> - {alert.message}
                </li>
              ))}
            </ul>
          </div>
        );
      };

      const LandingPage = () => {
        const [loginData, setLoginData] = useState({ username: '', password: '' });

        const handleLogin = async () => {
          try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(loginData)
            });
            const data = await response.json();
            localStorage.setItem('token', data.token);
            setUser(data.user);
            setShowLanding(false);
          } catch (err) {
            setError('Login failed');
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-900 text-white">
            <div className="bg-gray-800 p-6 rounded shadow-md w-80">
              <h1 className="text-xl mb-4 font-bold">Login</h1>
              {error && <p className="text-red-500">{error}</p>}
              <input
                type="text" placeholder="Username"
                value={loginData.username}
                onChange={e => setLoginData({ ...loginData, username: e.target.value })}
                className="w-full p-2 mb-2 bg-gray-700 rounded"
              />
              <input
                type="password" placeholder="Password"
                value={loginData.password}
                onChange={e => setLoginData({ ...loginData, password: e.target.value })}
                className="w-full p-2 mb-4 bg-gray-700 rounded"
              />
              <button
                onClick={handleLogin}
                className="w-full bg-green-500 p-2 rounded hover:bg-green-600"
              >Login</button>
            </div>
          </div>
        );
      };

      useEffect(() => {
        const token = localStorage.getItem('token');
        if (token) {
          debugLog('üîê Token found, validating...');
          fetch(`${API_BASE_URL}/auth/profile`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
            .then(res => res.json())
            .then(userData => {
              debugLog('‚úÖ Token valid', userData);
              setUser(userData);
              setShowLanding(false);
            })
            .catch(err => {
              console.error('‚ùå Token invalid');
              localStorage.removeItem('token');
              setShowLanding(true);
            });
        }
      }, []);

      if (showLanding) return <LandingPage />;
      return <Dashboard />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TradingGroupDashboard />);
  </script>
</body>
</html>
